<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Supabase Integration Test</title>
    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            margin: 20px; 
            background: #f8fafc;
            color: #1e293b;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .test-section { 
            margin: 24px 0; 
            padding: 20px; 
            border: 1px solid #e2e8f0; 
            border-radius: 8px; 
            background: #f8fafc;
        }
        .success { background-color: #f0fdf4; border-color: #bbf7d0; }
        .error { background-color: #fef2f2; border-color: #fecaca; }
        .warning { background-color: #fffbeb; border-color: #fed7aa; }
        .info { background-color: #eff6ff; border-color: #bfdbfe; }
        
        button { 
            padding: 12px 20px; 
            margin: 8px; 
            cursor: pointer; 
            border: none;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        
        pre { 
            background: #1e293b; 
            color: #e2e8f0;
            padding: 16px; 
            border-radius: 6px; 
            overflow-x: auto; 
            font-size: 14px;
            margin: 12px 0;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online { background: #10b981; }
        .status-offline { background: #ef4444; }
        .status-warning { background: #f59e0b; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #3b82f6;
        }
        
        .metric-label {
            font-size: 14px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        h1 { color: #1e293b; margin-bottom: 8px; }
        h2 { color: #374151; margin-bottom: 16px; }
        h3 { color: #4b5563; margin-bottom: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Enhanced Supabase Integration Test</h1>
        <p>Comprehensive testing suite for the enhanced Fuel Analytics Supabase integration</p>

        <div class="test-section info">
            <h2>üìä Connection Status</h2>
            <div id="connection-status">Loading...</div>
        </div>

        <div class="grid">
            <div class="metric-card">
                <div class="metric-value" id="online-status">-</div>
                <div class="metric-label">Online Status</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="auth-status">-</div>
                <div class="metric-label">Authentication</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="db-status">-</div>
                <div class="metric-label">Database</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="pending-ops">-</div>
                <div class="metric-label">Pending Operations</div>
            </div>
        </div>

        <div class="test-section">
            <h2>üîß Core Functions</h2>
            <button class="btn-primary" onclick="testInitialization()">Test Initialization</button>
            <button class="btn-primary" onclick="testHealthCheck()">Health Check</button>
            <button class="btn-secondary" onclick="testConnectionStatus()">Connection Status</button>
            <button class="btn-warning" onclick="testOfflineMode()">Test Offline Mode</button>
            <div id="core-results"></div>
        </div>

        <div class="test-section">
            <h2>üìä Data Operations</h2>
            <button class="btn-primary" onclick="testGetReports()">Get Reports</button>
            <button class="btn-success" onclick="testSyncData()">Sync Data</button>
            <button class="btn-warning" onclick="testClearCache()">Clear Cache</button>
            <button class="btn-secondary" onclick="testOverallPerformance()">Overall Performance</button>
            <div id="data-results"></div>
        </div>

        <div class="test-section">
            <h2>üîÑ Pending Operations</h2>
            <button class="btn-primary" onclick="testProcessPending()">Process Pending</button>
            <button class="btn-warning" onclick="testQueueOperation()">Queue Test Operation</button>
            <div id="pending-results"></div>
        </div>

        <div class="test-section">
            <h2>üîç Debug Functions</h2>
            <button class="btn-primary" onclick="testAuthCheck()">Check Authentication</button>
            <button class="btn-secondary" onclick="testFixProfile()">Fix User Profile</button>
            <button class="btn-warning" onclick="testRetryLogic()">Test Retry Logic</button>
            <button class="btn-danger" onclick="testErrorHandling()">Test Error Handling</button>
            <div id="debug-results"></div>
        </div>

        <div class="test-section">
            <h2>üìã Test Results Log</h2>
            <div id="test-log"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./supabase-client.js"></script>

    <script>
        // Test logging utility
        function logTest(section, message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `test-section ${type}`;
            logEntry.innerHTML = `
                <strong>[${timestamp}] ${section}:</strong> ${message}
            `;
            logDiv.insertBefore(logEntry, logDiv.firstChild);
        }

        // Update connection status
        function updateConnectionStatus() {
            // Check if global functions are available
            if (!window.getConnectionStatus) {
                const statusDiv = document.getElementById('connection-status');
                statusDiv.innerHTML = `<span class="status-indicator status-warning"></span>Loading Supabase client...`;
                return;
            }
            
            const status = window.getConnectionStatus();
            const statusDiv = document.getElementById('connection-status');
            
            if (status.error) {
                statusDiv.innerHTML = `<span class="status-indicator status-offline"></span>Error: ${status.error}`;
                return;
            }
            
            const onlineStatus = document.getElementById('online-status');
            const authStatus = document.getElementById('auth-status');
            const dbStatus = document.getElementById('db-status');
            const pendingOps = document.getElementById('pending-ops');
            
            onlineStatus.textContent = status.online ? 'üü¢ Online' : 'üî¥ Offline';
            authStatus.textContent = status.authenticated ? '‚úÖ Authenticated' : '‚ùå Not Auth';
            dbStatus.textContent = status.initialized ? '‚úÖ Initialized' : '‚ùå Not Init';
            pendingOps.textContent = status.pendingOperations;
            
            statusDiv.innerHTML = `
                <span class="status-indicator ${status.online ? 'status-online' : 'status-offline'}"></span>
                Online: ${status.online ? 'Yes' : 'No'} | 
                Initialized: ${status.initialized ? 'Yes' : 'No'} | 
                Authenticated: ${status.authenticated ? 'Yes' : 'No'} | 
                Pending Operations: ${status.pendingOperations}
            `;
        }

        // Test initialization
        async function testInitialization() {
            logTest('Initialization', 'Starting initialization test...');
            const resultsDiv = document.getElementById('core-results');
            
            try {
                const result = await window.fuelAnalyticsDB.initialize();
                logTest('Initialization', `Result: ${JSON.stringify(result, null, 2)}`, result.success ? 'success' : 'error');
                
                resultsDiv.innerHTML = `
                    <div class="test-section ${result.success ? 'success' : 'error'}">
                        <h3>Initialization Test</h3>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
                
                updateConnectionStatus();
            } catch (error) {
                logTest('Initialization', `Error: ${error.message}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="test-section error">
                        <h3>Initialization Test Failed</h3>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        // Test health check
        async function testHealthCheck() {
            logTest('Health Check', 'Starting health check...');
            const resultsDiv = document.getElementById('core-results');
            
            try {
                const health = await window.checkDatabaseHealth();
                logTest('Health Check', `Result: ${JSON.stringify(health, null, 2)}`, health.success ? 'success' : 'error');
                
                resultsDiv.innerHTML = `
                    <div class="test-section ${health.success ? 'success' : 'error'}">
                        <h3>Health Check</h3>
                        <pre>${JSON.stringify(health, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                logTest('Health Check', `Error: ${error.message}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="test-section error">
                        <h3>Health Check Failed</h3>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        // Test connection status
        function testConnectionStatus() {
            logTest('Connection Status', 'Checking connection status...');
            const resultsDiv = document.getElementById('core-results');
            
            try {
                const status = window.getConnectionStatus();
                logTest('Connection Status', `Status: ${JSON.stringify(status, null, 2)}`, 'info');
                
                resultsDiv.innerHTML = `
                    <div class="test-section info">
                        <h3>Connection Status</h3>
                        <pre>${JSON.stringify(status, null, 2)}</pre>
                    </div>
                `;
                
                updateConnectionStatus();
            } catch (error) {
                logTest('Connection Status', `Error: ${error.message}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="test-section error">
                        <h3>Connection Status Failed</h3>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        // Test offline mode
        function testOfflineMode() {
            logTest('Offline Mode', 'Testing offline mode simulation...');
            const resultsDiv = document.getElementById('core-results');
            
            // Simulate offline mode
            const originalOnline = navigator.onLine;
            Object.defineProperty(navigator, 'onLine', {
                writable: true,
                value: false
            });
            
            // Trigger offline event
            window.dispatchEvent(new Event('offline'));
            
            setTimeout(() => {
                // Restore online status
                Object.defineProperty(navigator, 'onLine', {
                    writable: true,
                    value: originalOnline
                });
                
                // Trigger online event
                window.dispatchEvent(new Event('online'));
                
                logTest('Offline Mode', 'Offline mode test completed', 'success');
                resultsDiv.innerHTML = `
                    <div class="test-section success">
                        <h3>Offline Mode Test</h3>
                        <p>Offline mode simulation completed successfully</p>
                    </div>
                `;
                
                updateConnectionStatus();
            }, 2000);
        }

        // Test get reports
        async function testGetReports() {
            logTest('Get Reports', 'Fetching reports from database...');
            const resultsDiv = document.getElementById('data-results');
            
            try {
                const result = await window.fuelAnalyticsDB.getMonthlyReports();
                logTest('Get Reports', `Found ${result.reports?.length || 0} reports`, result.success ? 'success' : 'error');
                
                resultsDiv.innerHTML = `
                    <div class="test-section ${result.success ? 'success' : 'error'}">
                        <h3>Get Reports Test</h3>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                logTest('Get Reports', `Error: ${error.message}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="test-section error">
                        <h3>Get Reports Test Failed</h3>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        // Test sync data
        async function testSyncData() {
            logTest('Sync Data', 'Syncing data with local storage...');
            const resultsDiv = document.getElementById('data-results');
            
            try {
                const result = await window.syncDatabaseData();
                logTest('Sync Data', `Sync result: ${JSON.stringify(result, null, 2)}`, result.success ? 'success' : 'error');
                
                resultsDiv.innerHTML = `
                    <div class="test-section ${result.success ? 'success' : 'error'}">
                        <h3>Sync Data Test</h3>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                logTest('Sync Data', `Error: ${error.message}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="test-section error">
                        <h3>Sync Data Test Failed</h3>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        // Test clear cache
        async function testClearCache() {
            logTest('Clear Cache', 'Clearing database cache...');
            const resultsDiv = document.getElementById('data-results');
            
            try {
                const result = await window.clearDatabaseCache();
                logTest('Clear Cache', `Cache clear result: ${JSON.stringify(result, null, 2)}`, result.success ? 'success' : 'error');
                
                resultsDiv.innerHTML = `
                    <div class="test-section ${result.success ? 'success' : 'error'}">
                        <h3>Clear Cache Test</h3>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                logTest('Clear Cache', `Error: ${error.message}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="test-section error">
                        <h3>Clear Cache Test Failed</h3>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        // Test overall performance
        async function testOverallPerformance() {
            logTest('Overall Performance', 'Fetching overall performance data...');
            const resultsDiv = document.getElementById('data-results');
            
            try {
                const result = await window.fuelAnalyticsDB.getOverallPerformance();
                logTest('Overall Performance', `Performance data retrieved`, result.success ? 'success' : 'error');
                
                resultsDiv.innerHTML = `
                    <div class="test-section ${result.success ? 'success' : 'error'}">
                        <h3>Overall Performance Test</h3>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                logTest('Overall Performance', `Error: ${error.message}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="test-section error">
                        <h3>Overall Performance Test Failed</h3>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        // Test process pending operations
        async function testProcessPending() {
            logTest('Process Pending', 'Processing pending operations...');
            const resultsDiv = document.getElementById('pending-results');
            
            try {
                const result = await window.processPendingOperations();
                logTest('Process Pending', `Process result: ${JSON.stringify(result, null, 2)}`, result.success ? 'success' : 'error');
                
                resultsDiv.innerHTML = `
                    <div class="test-section ${result.success ? 'success' : 'error'}">
                        <h3>Process Pending Operations Test</h3>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
                
                updateConnectionStatus();
            } catch (error) {
                logTest('Process Pending', `Error: ${error.message}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="test-section error">
                        <h3>Process Pending Operations Test Failed</h3>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        // Test queue operation
        function testQueueOperation() {
            logTest('Queue Operation', 'Queuing test operation...');
            const resultsDiv = document.getElementById('pending-results');
            
            try {
                // Add a test operation to the queue
                window.fuelAnalyticsDB.pendingOperations.push({
                    type: 'testOperation',
                    data: { test: true },
                    timestamp: Date.now()
                });
                
                logTest('Queue Operation', 'Test operation queued successfully', 'success');
                resultsDiv.innerHTML = `
                    <div class="test-section success">
                        <h3>Queue Operation Test</h3>
                        <p>Test operation queued successfully</p>
                        <p>Pending operations: ${window.fuelAnalyticsDB.pendingOperations.length}</p>
                    </div>
                `;
                
                updateConnectionStatus();
            } catch (error) {
                logTest('Queue Operation', `Error: ${error.message}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="test-section error">
                        <h3>Queue Operation Test Failed</h3>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        // Test authentication check
        async function testAuthCheck() {
            logTest('Auth Check', 'Checking authentication status...');
            const resultsDiv = document.getElementById('debug-results');
            
            try {
                const result = await window.checkAndFixAuth();
                logTest('Auth Check', `Auth result: ${JSON.stringify(result, null, 2)}`, result.success ? 'success' : 'error');
                
                resultsDiv.innerHTML = `
                    <div class="test-section ${result.success ? 'success' : 'error'}">
                        <h3>Authentication Check</h3>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
                
                updateConnectionStatus();
            } catch (error) {
                logTest('Auth Check', `Error: ${error.message}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="test-section error">
                        <h3>Authentication Check Failed</h3>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        // Test fix profile
        async function testFixProfile() {
            logTest('Fix Profile', 'Attempting to fix user profile...');
            const resultsDiv = document.getElementById('debug-results');
            
            try {
                const result = await window.fixCurrentUserProfile();
                logTest('Fix Profile', `Profile fix result: ${JSON.stringify(result, null, 2)}`, result.success ? 'success' : 'error');
                
                resultsDiv.innerHTML = `
                    <div class="test-section ${result.success ? 'success' : 'error'}">
                        <h3>Fix Profile Test</h3>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
                
                updateConnectionStatus();
            } catch (error) {
                logTest('Fix Profile', `Error: ${error.message}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="test-section error">
                        <h3>Fix Profile Test Failed</h3>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        // Test retry logic
        function testRetryLogic() {
            logTest('Retry Logic', 'Testing retry logic with simulated failures...');
            const resultsDiv = document.getElementById('debug-results');
            
            let attemptCount = 0;
            const testOperation = async () => {
                attemptCount++;
                if (attemptCount < 3) {
                    throw new Error(`Simulated failure attempt ${attemptCount}`);
                }
                return { success: true, attempt: attemptCount };
            };
            
            // Test the retry operation
            retryOperation(testOperation, 3)
                .then(result => {
                    logTest('Retry Logic', `Retry successful after ${result.attempt} attempts`, 'success');
                    resultsDiv.innerHTML = `
                        <div class="test-section success">
                            <h3>Retry Logic Test</h3>
                            <p>Retry logic working correctly</p>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;
                })
                .catch(error => {
                    logTest('Retry Logic', `Retry failed: ${error.message}`, 'error');
                    resultsDiv.innerHTML = `
                        <div class="test-section error">
                            <h3>Retry Logic Test Failed</h3>
                            <pre>${error.message}</pre>
                        </div>
                    `;
                });
        }

        // Test error handling
        function testErrorHandling() {
            logTest('Error Handling', 'Testing error handling with invalid operations...');
            const resultsDiv = document.getElementById('debug-results');
            
            try {
                // Test with uninitialized database
                const originalInitialized = window.fuelAnalyticsDB.isInitialized;
                window.fuelAnalyticsDB.isInitialized = false;
                
                window.fuelAnalyticsDB.getMonthlyReports()
                    .then(result => {
                        logTest('Error Handling', 'Error handling test completed', 'success');
                        resultsDiv.innerHTML = `
                            <div class="test-section success">
                                <h3>Error Handling Test</h3>
                                <p>Error handling working correctly</p>
                                <pre>${JSON.stringify(result, null, 2)}</pre>
                            </div>
                        `;
                    })
                    .catch(error => {
                        logTest('Error Handling', `Expected error caught: ${error.message}`, 'success');
                        resultsDiv.innerHTML = `
                            <div class="test-section success">
                                <h3>Error Handling Test</h3>
                                <p>Error handling working correctly</p>
                                <pre>Expected error: ${error.message}</pre>
                            </div>
                        `;
                    })
                    .finally(() => {
                        // Restore original state
                        window.fuelAnalyticsDB.isInitialized = originalInitialized;
                    });
            } catch (error) {
                logTest('Error Handling', `Error: ${error.message}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="test-section error">
                        <h3>Error Handling Test Failed</h3>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        // Wait for Supabase client to be ready
        function waitForSupabaseClient() {
            if (window.fuelAnalyticsDB && window.getConnectionStatus) {
                logTest('Page Load', 'Enhanced Supabase test page loaded and ready', 'success');
                updateConnectionStatus();
                
                // Auto-refresh connection status every 5 seconds
                setInterval(updateConnectionStatus, 5000);
            } else {
                // Check again in 500ms
                setTimeout(waitForSupabaseClient, 500);
            }
        }

        // Initialize page
        window.addEventListener('load', function() {
            logTest('Page Load', 'Enhanced Supabase test page loaded, waiting for client...', 'info');
            waitForSupabaseClient();
        });
    </script>
</body>
</html>
