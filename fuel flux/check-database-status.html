<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Status Check</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .status-box { margin: 20px 0; padding: 20px; border-radius: 8px; }
        .success { background: #2d5a2d; border: 1px solid #4caf50; }
        .error { background: #5a2d2d; border: 1px solid #f44336; }
        .warning { background: #5a4a2d; border: 1px solid #ff9800; }
        .info { background: #2d4a5a; border: 1px solid #2196f3; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #4caf50; color: white; border: none; border-radius: 4px; }
        pre { background: #333; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Database Status Check</h1>

    <div class="status-box info">
        <h2>Current Status</h2>
        <div id="current-status">Checking...</div>
    </div>

    <div class="status-box">
        <h2>Actions</h2>
        <button onclick="checkDatabaseStatus()">Check Database Status</button>
        <button onclick="createTestUser()">Create Test User</button>
        <button onclick="signInTestUser()">Sign In Test User</button>
        <button onclick="testDatabaseConnection()">Test Database Connection</button>
    </div>

    <div class="status-box">
        <h2>Results</h2>
        <div id="results"></div>
    </div>

    <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./supabase-client.js?v=5"></script>

    <script>
        let db = null;

        async function checkDatabaseStatus() {
            const resultsDiv = document.getElementById('results');
            const statusDiv = document.getElementById('current-status');
            
            resultsDiv.innerHTML = '<p>üîÑ Checking database status...</p>';
            
            try {
                // Check if Supabase client is available
                if (!window.supabase) {
                    throw new Error('Supabase client not loaded');
                }

                // Check if our database client is available
                if (!window.fuelAnalyticsDB) {
                    throw new Error('Fuel Analytics DB client not loaded');
                }

                db = window.fuelAnalyticsDB;
                
                // Check authentication status
                const authStatus = await db.checkAuthStatus();
                
                // Try to initialize database
                const initResult = await db.initialize();
                
                let status = '';
                let results = '<h3>Database Status Results:</h3><ul>';
                
                // Check Supabase client
                results += '<li>‚úÖ Supabase client: Loaded</li>';
                
                // Check our database client
                results += '<li>‚úÖ Fuel Analytics DB: Loaded</li>';
                
                // Check authentication
                if (authStatus) {
                    results += '<li>‚úÖ Authentication: Active</li>';
                    status = 'üü¢ Authenticated - Database Ready';
                } else {
                    results += '<li>‚ùå Authentication: Not authenticated</li>';
                    status = 'üü° Not Authenticated - Need to sign in';
                }
                
                // Check database initialization
                if (initResult.success) {
                    results += '<li>‚úÖ Database initialization: Successful</li>';
                    if (initResult.user) {
                        results += `<li>‚úÖ User: ${initResult.user.email}</li>`;
                    }
                    if (initResult.company) {
                        results += `<li>‚úÖ Company: ${initResult.company.name}</li>`;
                    }
                } else {
                    results += `<li>‚ùå Database initialization: Failed - ${initResult.error}</li>`;
                    status = 'üî¥ Database initialization failed';
                }
                
                results += '</ul>';
                
                statusDiv.innerHTML = status;
                resultsDiv.innerHTML = results;
                
            } catch (error) {
                statusDiv.innerHTML = 'üî¥ Error checking database status';
                resultsDiv.innerHTML = `<div class="error"><h3>Error:</h3><pre>${error.message}</pre></div>`;
            }
        }

        async function createTestUser() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>üîÑ Creating test user...</p>';
            
            try {
                if (!db) {
                    db = window.fuelAnalyticsDB;
                }
                
                const testEmail = 'test@fuelstation.com';
                const testPassword = 'testpassword123';
                
                // Try to sign up
                const { data, error } = await window.supabase.auth.signUp({
                    email: testEmail,
                    password: testPassword
                });
                
                if (error) {
                    if (error.message.includes('already registered')) {
                        resultsDiv.innerHTML = '<div class="warning"><h3>User already exists</h3><p>Test user already exists. Try signing in instead.</p></div>';
                    } else {
                        throw error;
                    }
                } else {
                    resultsDiv.innerHTML = '<div class="success"><h3>Test user created successfully</h3><p>Email: test@fuelstation.com<br>Password: testpassword123</p></div>';
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error"><h3>Error creating test user:</h3><pre>${error.message}</pre></div>`;
            }
        }

        async function signInTestUser() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>üîÑ Signing in test user...</p>';
            
            try {
                if (!db) {
                    db = window.fuelAnalyticsDB;
                }
                
                const testEmail = 'test@fuelstation.com';
                const testPassword = 'testpassword123';
                
                const result = await db.signIn(testEmail, testPassword);
                
                if (result.success) {
                    resultsDiv.innerHTML = '<div class="success"><h3>Sign in successful!</h3><p>User is now authenticated and database should be ready.</p></div>';
                    
                    // Re-check database status
                    setTimeout(() => {
                        checkDatabaseStatus();
                    }, 1000);
                } else {
                    resultsDiv.innerHTML = `<div class="error"><h3>Sign in failed:</h3><pre>${result.error}</pre></div>`;
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error"><h3>Error signing in:</h3><pre>${error.message}</pre></div>`;
            }
        }

        async function testDatabaseConnection() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>üîÑ Testing database connection...</p>';
            
            try {
                if (!db) {
                    db = window.fuelAnalyticsDB;
                }
                
                // Test a simple query
                const { data, error } = await window.supabase.from('companies').select('count').limit(1);
                
                if (error) {
                    throw error;
                }
                
                resultsDiv.innerHTML = '<div class="success"><h3>Database connection successful!</h3><p>Tables are accessible and queries work.</p></div>';
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error"><h3>Database connection failed:</h3><pre>${error.message}</pre></div>`;
            }
        }

        // Auto-check on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkDatabaseStatus();
            }, 1000);
        });
    </script>
</body>
</html>
