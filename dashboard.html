<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FUEL FLUX · Analytics Dashboard</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#4f46e5">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Fuel Analytics">
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
  
  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js')
          .then(function(registration) {
            console.log('✅ Service Worker registered successfully:', registration.scope);
          })
          .catch(function(error) {
            console.log('❌ Service Worker registration failed:', error);
          });
      });
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./dashboard.css?v=8" />
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="./supabase-client.js?v=2"></script>
  <script src="./advanced-calculations.js?v=1"></script>
  <script src="./visual-analytics.js?v=2"></script>
  <script src="./data-integration.js?v=1"></script>
  <script src="./renovation-client.js?v=1"></script>
  
  <!-- Load utility extensions -->
  <script src="./utils/stateManager.js"></script>
  <script src="./utils/errorHandler.js"></script>
  <script src="./utils/logger.js"></script>
  <script src="./utils/validator.js"></script>
  <script src="./utils/analyticsEngine.js"></script>
  <script src="./utils/reportingEngine.js"></script>
  <script src="./utils/realTimeDataService.js"></script>
  <script src="./utils/cacheManager.js"></script>
  <script src="./utils/memoryManager.js"></script>
  <script src="./utils/databaseSchema.js"></script>
  <script src="./utils/dataIntegrationPlan.js"></script>
  <script src="./utils/sampleDataGenerator.js"></script>
  <script src="./utils/performanceOptimizer.js"></script>
  <script src="./utils/offlineManager.js"></script>
  <script src="./utils/accessibility.js"></script>
  
  <!-- Load main extensions configuration -->
  <script src="./extensions-config.js"></script>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="./index.html">
        <div class="logo-container">
          <div class="logo-icon">F</div>
          <div class="logo-text">
            <span class="logo-fuel">FUEL</span>
            <span class="logo-flux">FLUX</span>
          </div>
        </div>
      </a>
      <nav class="nav">
        <a href="#overview" class="nav-link active">Overview</a>
        <a href="#reports" class="nav-link">Reports</a>
        <a href="#analytics" class="nav-link">Analytics</a>
        <a href="#insights" class="nav-link">Insights</a>
        <a href="#personnel" class="nav-link">Personnel</a>
        <a href="#users" class="nav-link">Users</a>
        <a href="#renovation" class="nav-link">Renovation</a>
        <a href="#expansion" class="nav-link">Expansion</a>
      </nav>
      <div class="header-actions">
        <span id="user-email" class="user-email"></span>
        <button id="signout" class="button secondary">Sign out</button>
      </div>
    </div>
  </header>

  <main class="dashboard-main">
    <!-- Overview Section -->
    <section id="overview" class="dashboard-section">
      <div class="container">
        <div class="section-header">
          <h1>Monthly Overview</h1>
          <p>Current month performance metrics and key insights for your fuel business</p>
          <div class="overview-actions">
            <button id="overview-over-time-btn" class="button secondary">Overview Over Time</button>
            <button onclick="refreshAllDashboardData()" class="button secondary" style="margin-left: 10px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                <path d="M1 4V10H7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M23 20V14H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10M23 14L18.36 18.36A9 9 0 0 1 3.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Refresh Data
            </button>
          </div>
          <div class="data-status" id="data-status" style="margin-top: 10px; font-size: 12px; color: var(--muted);">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 4px; display: inline-block; vertical-align: middle;">
              <path d="M3 3V9H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M21 21V15H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M18.49 9A9 9 0 0 0 3.64 5.64L3 9M21 15L20.36 18.36A9 9 0 0 1 5.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Data last updated: <span id="last-update-time">Loading...</span>
        </div>
        </div>

        <!-- Key Metrics Grid -->
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
              </svg>
            </div>
            <div class="metric-content">
              <div class="metric-title">Total Revenue</div>
              <div class="metric-value" id="total-revenue">R 0</div>
              <div class="metric-change positive" id="revenue-change">+0%</div>
        </div>
          </div>
          <div class="metric-card">
            <div class="metric-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7 14L12 9L17 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 9V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M3 21H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="metric-content">
              <div class="metric-title">Total Profit</div>
              <div class="metric-value" id="total-profit">R 0</div>
              <div class="metric-change positive" id="profit-change">+0%</div>
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                <rect x="6" y="18" width="12" height="4" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
              </svg>
            </div>
            <div class="metric-content">
              <div class="metric-title">Fuel Volume</div>
              <div class="metric-value" id="total-volume">0 L</div>
              <div class="metric-change positive" id="volume-change">+0%</div>
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                <path d="M3 12H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M12 3V21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="metric-content">
              <div class="metric-title">Shop Revenue per Liter</div>
              <div class="metric-value" id="shop-fuel-ratio">R 0.00/L</div>
              <div class="metric-change positive" id="ratio-change">+0%</div>
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
                <path d="M8 12L11 15L16 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="metric-content">
              <div class="metric-title">Fuel Margin</div>
              <div class="metric-value" id="fuel-margin">R 0</div>
              <div class="metric-change positive" id="margin-change">+0%</div>
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                <path d="M9 9H15V15H9V9Z" stroke="currentColor" stroke-width="2" fill="none"/>
                <path d="M9 12H15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="metric-content">
              <div class="metric-title">Shop Profit</div>
              <div class="metric-value" id="shop-profit">R 0</div>
              <div class="metric-change positive" id="shop-profit-change">+0%</div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
          <div class="action-card">
            <h3>Upload New Report</h3>
            <p>Upload your monthly PDF report for analysis</p>
            <button id="upload-trigger" class="button primary">Upload PDF</button>
          </div>
          <div class="action-card">
            <h3>Manual Entry</h3>
            <p>Enter data manually for quick analysis</p>
            <button id="manual-entry" class="button secondary">Enter Data</button>
          </div>
          <div class="action-card">
            <h3>Monthly Performance</h3>
            <p>View performance metrics for each month</p>
            <button id="monthly-performance-btn" class="button secondary">View Performance</button>
          </div>
          <div class="action-card">
            <h3>View History</h3>
            <p>Access your previous reports and analysis</p>
            <button id="view-history" class="button secondary">View Reports</button>
          </div>
          
        </div>
      </div>
    </section>

    <!-- Reports Section -->
    <section id="reports" class="dashboard-section alt">
      <div class="container">
        <div class="section-header">
          <h2>Report Management</h2>
          <p>Upload, analyze, and manage your monthly reports</p>
        </div>

                 <!-- Upload Area -->
         <div class="upload-area" id="upload-area" style="display: none;">
           <div class="upload-card">
             <h3>Upload Monthly Report</h3>
             <p>Select your PDF report for automated analysis</p>
             <div class="upload-zone">
               <input id="report-file-main" type="file" accept="application/pdf" />
               <div class="upload-placeholder">
                 <div class="upload-icon">📄</div>
                 <p>Drag & drop your PDF here or click to browse</p>
                 <span class="upload-hint">Supports PDF files up to 10MB</span>
               </div>
             </div>
             <div class="upload-actions">
               <button id="analyze-ai" class="button primary">Analyze Report</button>
               <button id="cancel-upload" class="button secondary">Cancel</button>
             </div>
             <div id="analyze-status" class="status-message"></div>
           </div>
         </div>

        <!-- Manual Entry Form -->
        <div class="manual-entry-form" id="manual-form" style="display: none;">
          <div class="form-card">
            <h3>Manual Data Entry</h3>
            <p>Enter your fuel and shop data manually for accurate analysis</p>
            
            <!-- Data Source Controls -->
            <div class="recent-report-info" id="manual-data-source">
              <div class="info-card">
                <h4>💡 Smart Data Loading Available</h4>
                <p>Load fuel sales data from your most recent report to save time</p>
                <button id="load-from-reports" class="button secondary" style="margin-top: 10px;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                    <path d="M3 3V9H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M21 21V15H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18.49 9A9 9 0 0 0 3.64 5.64L3 9M21 15L20.36 18.36A9 9 0 0 1 5.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Load from Latest Report
                </button>
              </div>
            </div>
            
            <!-- Fuel Prices Section -->
            <div class="form-section">
              <h4>Fuel Prices (Manual Input Required)</h4>
              <p class="form-hint">Enter current selling and cost prices for accurate profit calculations</p>
              
              <!-- Fuel Price History -->
              <div class="fuel-price-history">
                <h5>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px; display: inline-block; vertical-align: middle;">
                    <path d="M3 3V9H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M21 21V15H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18.49 9A9 9 0 0 0 3.64 5.64L3 9M21 15L20.36 18.36A9 9 0 0 1 5.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Historical Fuel Price Changes
                </h5>
                <div class="price-history-log" id="fuel-price-history-log">
                  <p class="no-history">No price history available yet. Enter prices to start tracking changes.</p>
                </div>
              </div>
              <div class="fuel-inputs">
                <div class="fuel-input-group">
                  <label>Diesel Ex Prices</label>
                  <div class="input-row">
                    <input id="fuel-diesel-sell" type="number" placeholder="Selling Price (R/L)" step="0.01" />
                    <input id="fuel-diesel-cost" type="number" placeholder="Cost Price (R/L)" step="0.01" />
                  </div>
                </div>
                <div class="fuel-input-group">
                  <label>V-Power 95 Prices</label>
                  <div class="input-row">
                    <input id="fuel-v95-sell" type="number" placeholder="Selling Price (R/L)" step="0.01" />
                    <input id="fuel-v95-cost" type="number" placeholder="Cost Price (R/L)" step="0.01" />
                  </div>
                </div>
                <div class="fuel-input-group">
                  <label>V-Power Diesel Prices</label>
                  <div class="input-row">
                    <input id="fuel-vd-sell" type="number" placeholder="Selling Price (R/L)" step="0.01" />
                    <input id="fuel-vd-cost" type="number" placeholder="Cost Price (R/L)" step="0.01" />
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Fuel Sales Data Section -->
            <div class="form-section">
              <h4>Fuel Sales Data</h4>
              <div class="fuel-inputs">
                <div class="fuel-input-group">
                  <label>Diesel Ex Sales</label>
                  <div class="input-row">
                    <input id="fuel-diesel-revenue" type="number" placeholder="Revenue (R)" />
                    <input id="fuel-diesel-qty" type="number" placeholder="Quantity (L)" />
                  </div>
                </div>
                <div class="fuel-input-group">
                  <label>V-Power 95 Sales</label>
                  <div class="input-row">
                    <input id="fuel-v95-revenue" type="number" placeholder="Revenue (R)" />
                    <input id="fuel-v95-qty" type="number" placeholder="Quantity (L)" />
                  </div>
                </div>
                <div class="fuel-input-group">
                  <label>V-Power Diesel Sales</label>
                  <div class="input-row">
                    <input id="fuel-vd-revenue" type="number" placeholder="Revenue (R)" />
                    <input id="fuel-vd-qty" type="number" placeholder="Quantity (L)" />
                  </div>
                </div>
              </div>
            </div>

            <!-- Shop Data -->
            <div class="form-section">
              <h4>Shop Sales</h4>
              <div id="shop-inputs">
                <div class="shop-input-group">
                  <div class="input-row">
                    <input type="text" placeholder="Category (e.g., Deli Onsite)" />
                    <input type="number" placeholder="Revenue (R)" />
                    <input type="number" placeholder="Units" />
                  </div>
                </div>
              </div>
              <button id="add-shop-item" class="button secondary small">+ Add Shop Item</button>
            </div>

            <div class="form-actions">
              <button id="save-data" class="button primary">Save & Analyze</button>
              <button id="cancel-manual" class="button secondary">Cancel</button>
            </div>
          </div>
        </div>

        <!-- Monthly Performance Dashboard -->
        <div class="monthly-performance" id="monthly-performance" style="display: none;">
          <div class="form-card">
            <h3>Monthly Performance Dashboard</h3>
            <p>View performance metrics for each month</p>
            
            <!-- Month Selection -->
            <div class="month-selector">
              <h4>Select Month</h4>
              <div class="month-buttons" id="month-buttons">
                <!-- Month buttons will be generated here -->
              </div>
            </div>
            
            <!-- Overall Performance -->
            <div class="overall-performance">
              <h4>Overall Performance</h4>
              <div class="overall-metrics" id="overall-metrics">
                <!-- Overall metrics will be displayed here -->
              </div>
            </div>
            
            <!-- Monthly Metrics -->
            <div class="monthly-metrics" id="monthly-metrics">
              <!-- Selected month metrics will be displayed here -->
            </div>
          </div>
        </div>
        
        <!-- Recent Report Info -->
        <div class="recent-report-info" id="recent-report-info" style="display: none;">
          <div class="info-card">
            <h4>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px; display: inline-block; vertical-align: middle;">
                <path d="M3 3V9H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M21 21V15H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M18.49 9A9 9 0 0 0 3.64 5.64L3 9M21 15L20.36 18.36A9 9 0 0 1 5.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Most Recent Report
            </h4>
            <p id="recent-report-details">No reports uploaded yet</p>
          </div>
        </div>
        
        <!-- Reports History -->
        <div class="reports-history" id="reports-history" style="display: none;">
          <div class="form-card">
            <h3>Monthly Reports History</h3>
            <p>View and manage your uploaded reports</p>
            <div class="reports-list" id="reports-list">
              <!-- Reports will be populated here -->
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- Analytics Section -->
    <section id="analytics" class="dashboard-section">
      <div class="container">
        <div class="section-header">
          <h2>Analytics & Visualizations</h2>
          <p>Comprehensive analysis of your fuel business performance</p>
        </div>

        <!-- Fuel Margins Table -->
        <div class="fuel-margins-section">
          <h3>Fuel Margins & Profitability</h3>
          <div class="fuel-margins-table">
            <table>
              <thead>
                <tr>
                  <th>Fuel Type</th>
                  <th>Revenue (R)</th>
                  <th>Volume (L)</th>
                  <th>Margin (R)</th>
                  <th>Margin (%)</th>
                  <th>Profit (R)</th>
                </tr>
              </thead>
              <tbody id="fuel-margins-body">
                <tr>
                  <td>Diesel Ex</td>
                  <td id="diesel-revenue">R 0</td>
                  <td id="diesel-volume">0 L</td>
                  <td id="diesel-margin-rand">R 0</td>
                  <td id="diesel-margin-percent">0%</td>
                  <td id="diesel-profit">R 0</td>
                </tr>
                <tr>
                  <td>V-Power 95</td>
                  <td id="vpower95-revenue">R 0</td>
                  <td id="vpower95-volume">0 L</td>
                  <td id="vpower95-margin-rand">R 0</td>
                  <td id="vpower95-margin-percent">0%</td>
                  <td id="vpower95-profit">R 0</td>
                </tr>
                <tr>
                  <td>V-Power Diesel</td>
                  <td id="vpower-diesel-revenue">R 0</td>
                  <td id="vpower-diesel-volume">0 L</td>
                  <td id="vpower-diesel-margin-rand">R 0</td>
                  <td id="vpower-diesel-margin-percent">0%</td>
                  <td id="vpower-diesel-profit">R 0</td>
                </tr>
              </tbody>
            </table>
            </div>
          </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
          <div class="chart-card">
            <div class="chart-header">
              <h3>Revenue Performance</h3>
              <button class="download-btn" onclick="downloadChart('revenueChart', 'revenue-performance')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                  <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Download
              </button>
            </div>
            <div class="chart-container">
              <canvas id="revenueChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <h3>Fuel Distribution</h3>
              <button class="download-btn" onclick="downloadChart('fuelDistributionChart', 'fuel-distribution')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                  <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Download
              </button>
            </div>
            <div class="chart-container">
              <canvas id="fuelDistributionChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <h3>Profitability Analysis</h3>
              <button class="download-btn" onclick="downloadChart('profitChart', 'profitability-analysis')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                  <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Download
              </button>
            </div>
            <div class="chart-container">
              <canvas id="profitChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <h3>Shop Performance</h3>
              <button class="download-btn" onclick="downloadChart('shopChart', 'shop-performance')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                  <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Download
              </button>
            </div>
            <div class="chart-container">
              <canvas id="shopChart"></canvas>
            </div>
          </div>
        </div>

        <!-- KPI Dashboard -->
        <div class="kpi-dashboard">
          <h3>Key Performance Indicators</h3>
          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="kpi-value" id="shop-fuel-ratio-kpi">R 0.00/L</div>
              <div class="kpi-label">Shop to Fuel Ratio</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-value" id="fuel-margins-rand">R 0</div>
              <div class="kpi-label">Fuel Margins (R)</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-value" id="revenue-growth-rate">0%</div>
              <div class="kpi-label">Revenue Growth Rate</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-value" id="shop-profit-margin">0%</div>
              <div class="kpi-label">Shop Profit Margin</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Renovation Section -->
    <section id="renovation" class="dashboard-section alt">
      <div class="container">
        <div class="section-header">
          <h2>Renovation Planning & Tracking</h2>
          <p>Plan and monitor renovation projects with budget tracking and timeline management</p>
        </div>

        <div class="renovation-content">
          <!-- Project Settings Panel -->
          <div class="renovation-settings">
            <h3>Project Settings</h3>
            <div class="settings-grid">
              <div class="setting-group">
                <label for="project-currency">Currency</label>
                <select id="project-currency" class="form-select">
                  <option value="ZAR" selected>ZAR (South African Rand)</option>
                  <option value="USD">USD (US Dollar)</option>
                  <option value="EUR">EUR (Euro)</option>
                </select>
          </div>
              <div class="setting-group">
                <label for="discount-rate">Discount Rate (Annual %)</label>
                <input type="number" id="discount-rate" class="form-input" value="12" step="0.1" min="0" max="50">
              </div>
              <div class="setting-group">
                <label for="tax-rate">Tax Rate (%)</label>
                <input type="number" id="tax-rate" class="form-input" value="28" step="0.1" min="0" max="100">
              </div>
              <div class="setting-group">
                <label for="vat-rate">VAT Rate (%)</label>
                <input type="number" id="vat-rate" class="form-input" value="15" step="0.1" min="0" max="100">
              </div>
              <div class="setting-group">
                <label for="project-horizon">Project Horizon (Months)</label>
                <input type="number" id="project-horizon" class="form-input" value="120" step="1" min="12" max="360">
              </div>
            </div>
          </div>

          <!-- Renovation Planning Tools -->
          <div class="renovation-planning">
            <div class="planning-header">
              <h3>Renovation Planning</h3>
              <button id="add-renovation-item" class="button primary">+ Add Renovation Item</button>
            </div>

            <!-- Renovation Groups -->
            <div class="renovation-groups">
              <h4>Renovation Groups</h4>
              <div class="groups-grid">
                <div class="group-card active" data-group="forecourt">
                  <div class="group-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                      <rect x="6" y="18" width="12" height="4" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                    </svg>
                  </div>
                  <div class="group-name">Forecourt</div>
                </div>
                <div class="group-card" data-group="pumps">
                  <div class="group-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="group-name">Pumps & Nozzles</div>
                </div>
                <div class="group-card" data-group="canopy">
                  <div class="group-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                      <rect x="6" y="18" width="12" height="4" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                    </svg>
                  </div>
                  <div class="group-name">Canopy</div>
                </div>
                <div class="group-card" data-group="shop">
                  <div class="group-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                      <path d="M9 9H15V15H9V9Z" stroke="currentColor" stroke-width="2" fill="none"/>
                      <path d="M9 12H15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                  </div>
                  <div class="group-name">Shop Fit-out</div>
                </div>
                <div class="group-card" data-group="security">
                  <div class="group-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="5" y="11" width="14" height="10" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                      <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <circle cx="12" cy="16" r="1" fill="currentColor"/>
                    </svg>
                  </div>
                  <div class="group-name">IT & Security</div>
                </div>
                <div class="group-card" data-group="compliance">
                  <div class="group-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M16 13H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M16 17H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M10 9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="group-name">Compliance</div>
                </div>
                <div class="group-card" data-group="other">
                  <div class="group-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 5V19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="group-name">Other</div>
                </div>
              </div>
            </div>

            <!-- Renovation Item Form -->
            <div id="renovation-item-form" class="renovation-form" style="display: none;">
              <h4>Add Renovation Item</h4>
              <div class="form-grid">
                <div class="form-group">
                  <label for="item-name">Item Name</label>
                  <input type="text" id="item-name" class="form-input" placeholder="e.g., Nozzle Replacement" required>
                </div>
                <div class="form-group">
                  <label for="item-category">Category</label>
                  <select id="item-category" class="form-select" required>
                    <option value="forecourt">Forecourt</option>
                    <option value="pumps">Pumps & Nozzles</option>
                    <option value="canopy">Canopy</option>
                    <option value="shop">Shop Fit-out</option>
                    <option value="security">IT & Security</option>
                    <option value="compliance">Compliance</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="item-cost">Total Cost (ZAR)</label>
                  <input type="number" id="item-cost" class="form-input" placeholder="0.00" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                  <label for="item-quantity">Quantity</label>
                  <input type="number" id="item-quantity" class="form-input" value="1" min="1" required>
                </div>
                <div class="form-group">
                  <label for="item-description">Description</label>
                  <input type="text" id="item-description" class="form-input" placeholder="Brief description of the item">
                </div>
                <div class="form-group">
                  <label for="item-supplier">Supplier</label>
                  <input type="text" id="item-supplier" class="form-input" placeholder="Supplier name">
                </div>
              </div>

              <!-- Phasing Options -->
              <div class="phasing-section">
                <h5>Implementation Phasing</h5>
                <div class="phasing-grid">
                  <div class="checkbox-group">
                    <input type="radio" id="one-off" name="phasing" value="one-off" checked>
                    <label for="one-off">One-off Payment</label>
                  </div>
                  <div class="checkbox-group">
                    <input type="radio" id="monthly" name="phasing" value="monthly">
                    <label for="monthly">Monthly Over Period</label>
                  </div>
                  <div class="checkbox-group">
                    <input type="radio" id="quarterly" name="phasing" value="quarterly">
                    <label for="quarterly">Quarterly Payments</label>
                  </div>
                  <div class="checkbox-group">
                    <input type="radio" id="custom" name="phasing" value="custom">
                    <label for="custom">Custom Schedule</label>
                  </div>
                </div>

                <!-- One-off timing -->
                <div id="one-off-options" class="form-group" style="margin-top: 16px;">
                  <label for="one-off-month">Payment Month</label>
                  <input type="number" id="one-off-month" class="form-input" value="1" min="1" max="120" placeholder="Month number (1-120)">
                </div>

                <!-- Monthly/Quarterly timing -->
                <div id="period-options" class="form-group" style="margin-top: 16px; display: none;">
                  <div class="form-grid">
                    <div class="form-group">
                      <label for="start-month">Start Month</label>
                      <input type="number" id="start-month" class="form-input" value="1" min="1" max="120">
                    </div>
                    <div class="form-group">
                      <label for="duration-months">Duration (Months)</label>
                      <input type="number" id="duration-months" class="form-input" value="12" min="1" max="120">
                    </div>
                  </div>
                </div>

                <!-- Custom schedule -->
                <div id="custom-schedule" class="custom-schedule" style="display: none;">
                  <h6>Custom Payment Schedule</h6>
                  <div class="schedule-grid">
                    <div class="schedule-input">
                      <label>Month 1</label>
                      <input type="number" class="form-input" placeholder="Amount" step="0.01" min="0">
                    </div>
                    <div class="schedule-input">
                      <label>Month 6</label>
                      <input type="number" class="form-input" placeholder="Amount" step="0.01" min="0">
                    </div>
                    <div class="schedule-input">
                      <label>Month 12</label>
                      <input type="number" class="form-input" placeholder="Amount" step="0.01" min="0">
                    </div>
                    <div class="schedule-input">
                      <label>Month 24</label>
                      <input type="number" class="form-input" placeholder="Amount" step="0.01" min="0">
                    </div>
                  </div>
                  <div class="schedule-summary">
                    <span>Total Scheduled: <strong id="custom-total">R 0.00</strong></span>
                    <span>Remaining: <strong id="custom-remaining">R 0.00</strong></span>
                  </div>
                </div>
              </div>

              <!-- Form Actions -->
              <div class="form-actions">
                <button id="save-renovation-item" class="button primary">Save Item</button>
                <button id="cancel-renovation-item" class="button secondary">Cancel</button>
              </div>
            </div>

            <!-- Renovation Items List -->
            <div id="renovation-items-list" class="items-list">
              <h4>Renovation Items</h4>
              <div id="items-container">
                <div class="empty-state">
                  <p>No renovation items added yet</p>
                  <p>Click "Add Renovation Item" to get started</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Renovation Overview -->
          <div class="renovation-overview">
            <div class="renovation-metrics">
              <div class="metric-card">
                <div class="metric-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                    <rect x="6" y="18" width="12" height="4" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                  </svg>
                </div>
                <div class="metric-content">
                  <div class="metric-title">Active Projects</div>
                  <div class="metric-value" id="active-renovations">0</div>
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
                  </svg>
                </div>
                <div class="metric-content">
                  <div class="metric-title">Total Budget</div>
                  <div class="metric-value" id="renovation-budget">R 0</div>
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M7 2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M17 2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M3 10H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="12" cy="14" r="1" fill="currentColor"/>
                    <circle cx="12" cy="18" r="1" fill="currentColor"/>
                    <circle cx="8" cy="14" r="1" fill="currentColor"/>
                    <circle cx="8" cy="18" r="1" fill="currentColor"/>
                    <circle cx="16" cy="14" r="1" fill="currentColor"/>
                    <circle cx="16" cy="18" r="1" fill="currentColor"/>
                  </svg>
                </div>
                <div class="metric-content">
                  <div class="metric-title">Avg Duration</div>
                  <div class="metric-value" id="avg-renovation-duration">0 days</div>
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div class="metric-content">
                  <div class="metric-title">Completion Rate</div>
                  <div class="metric-value" id="renovation-completion">0%</div>
                </div>
              </div>
            </div>
            
            <!-- Advanced Financial Visualizations -->
            <div class="renovation-visualizations">
              <div class="visualizations-header">
                <h3>Financial Analysis & Projections</h3>
                <button id="refresh-charts" class="button secondary" onclick="refreshRenovationCharts()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                    <path d="M1 4V10H7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M23 20V14H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10M23 14L18.36 18.36A9 9 0 0 1 3.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Refresh Charts
                </button>
              </div>
              <div class="chart-grid">
                <div class="chart-section">
                <div class="chart-header">
                  <h3>Cash Flow Projection</h3>
                  <button class="download-btn" onclick="window.visualEngine ? window.visualEngine.downloadChart('cash-flow-chart', 'cash-flow-projection') : alert('Charts not ready yet')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                      <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Download
                  </button>
                </div>
                <div class="chart-container">
                  <canvas id="cash-flow-chart" height="300"></canvas>
                </div>
              </div>
              
              <div class="chart-section">
                <div class="chart-header">
                  <h3>Scenario Analysis</h3>
                  <button class="download-btn" onclick="window.visualEngine ? window.visualEngine.downloadChart('scenario-chart', 'scenario-analysis') : alert('Charts not ready yet')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                      <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Download
                  </button>
                </div>
                <div class="chart-container">
                  <canvas id="scenario-chart" height="300"></canvas>
                </div>
              </div>
              
              <div class="chart-section">
                <div class="chart-header">
                  <h3>Sensitivity Analysis</h3>
                  <button class="download-btn" onclick="window.visualEngine ? window.visualEngine.downloadChart('sensitivity-chart', 'sensitivity-analysis') : alert('Charts not ready yet')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                      <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Download
                  </button>
                </div>
                <div class="chart-container">
                  <canvas id="sensitivity-chart" height="300"></canvas>
                </div>
              </div>
              
              <div class="chart-section">
                <div class="chart-header">
                  <h3>Risk Distribution</h3>
                  <button class="download-btn" onclick="window.visualEngine ? window.visualEngine.downloadChart('risk-chart', 'risk-distribution') : alert('Charts not ready yet')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                      <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Download
                  </button>
                </div>
                <div class="chart-container">
                  <canvas id="risk-chart" height="300"></canvas>
                </div>
              </div>
              
              <div class="chart-section">
                <div class="chart-header">
                  <h3>Break-Even Analysis</h3>
                  <button class="download-btn" onclick="window.visualEngine ? window.visualEngine.downloadChart('break-even-chart', 'break-even-analysis') : alert('Charts not ready yet')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                      <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Download
                  </button>
                </div>
                <div class="chart-container">
                  <canvas id="break-even-chart" height="300"></canvas>
                </div>
              </div>
              
              <div class="chart-section">
                <div class="chart-header">
                  <h3>KPI Summary</h3>
                  <button class="download-btn" onclick="window.visualEngine ? window.visualEngine.downloadChart('kpi-chart', 'kpi-summary') : alert('Charts not ready yet')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                      <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Download
                  </button>
                </div>
                <div class="chart-container">
                  <canvas id="kpi-chart" height="300"></canvas>
                </div>
              </div>
            </div>
          </div>
            
            <!-- Data Integration Section -->
            <div class="data-integration-section">
              <div class="integration-header">
                <h3>Data Integration & Business Intelligence</h3>
                <button id="load-historical-data" class="button primary">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                    <path d="M3 3V9H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M21 21V15H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18.49 9A9 9 0 0 0 3.64 5.64L3 9M21 15L20.36 18.36A9 9 0 0 1 5.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Load Historical Data
                </button>
              </div>
              
              <div class="integration-metrics">
                <div class="metric-card">
                  <div class="metric-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M7 14L12 9L17 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M12 9V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M3 21H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="metric-content">
                    <div class="metric-title">Revenue Growth</div>
                    <div class="metric-value" id="revenue-growth">0%</div>
                  </div>
                </div>
                <div class="metric-card">
                  <div class="metric-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M3 3V9H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M21 21V15H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M18.49 9A9 9 0 0 0 3.64 5.64L3 9M21 15L20.36 18.36A9 9 0 0 1 5.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="metric-content">
                    <div class="metric-title">Data Points</div>
                    <div class="metric-value" id="data-points">0</div>
                  </div>
                </div>
                <div class="metric-card">
                  <div class="metric-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2"/>
                      <path d="M12 7V12L15.5 15.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <circle cx="16" cy="8" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
                      <path d="M14.5 6.5L17.5 9.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                  </div>
                  <div class="metric-content">
                    <div class="metric-title">Projected ROI</div>
                    <div class="metric-value" id="projected-roi">0%</div>
                  </div>
                </div>
                <div class="metric-card">
                  <div class="metric-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                      <path d="M12 7V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="metric-content">
                    <div class="metric-title">Payback Period</div>
                    <div class="metric-value" id="projected-payback">0 months</div>
                  </div>
                </div>
              </div>
              
              <div class="integration-charts">
                <div class="chart-section">
                  <div class="chart-header">
                    <h3>Historical Revenue Trends</h3>
                    <button class="download-btn" onclick="window.visualEngine ? window.visualEngine.downloadChart('historical-trends-chart', 'historical-trends') : alert('Charts not ready yet')">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                        <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      Download
                    </button>
                  </div>
                  <div class="chart-container">
                    <canvas id="historical-trends-chart" height="300"></canvas>
                  </div>
                </div>
                
                <div class="chart-section">
                  <div class="chart-header">
                    <h3>Revenue Projection with Renovation</h3>
                    <button class="download-btn" onclick="window.visualEngine ? window.visualEngine.downloadChart('revenue-projection-chart', 'revenue-projection') : alert('Charts not ready yet')">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                        <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      Download
                    </button>
                  </div>
                  <div class="chart-container">
                    <canvas id="revenue-projection-chart" height="300"></canvas>
                  </div>
                </div>
              </div>
              
              <div class="insights-section">
                <h3>Business Insights & Recommendations</h3>
                <div id="insights-container" class="insights-container">
                  <div class="insight-placeholder">
                    <p>Load historical data to see business insights and recommendations.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>



          <!-- Current Projects -->
          <div class="renovation-projects">
            <h3>Current Projects</h3>
            <div class="projects-grid" id="renovation-projects-list">
              <div class="project-card">
                <h4>No active renovation projects</h4>
                <p>Add renovation projects to start tracking</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Insights Section -->
    <section id="insights" class="dashboard-section alt">
      <div class="container">
        <div class="section-header">
          <h2>Insights & Recommendations</h2>
          <p>Intelligent analysis and actionable recommendations</p>
        </div>

        <div class="insights-container">
          <div class="insights-grid">
            <div class="insight-card">
              <h3>Performance Summary</h3>
              <div id="summary" class="summary-content">
                Upload a report or enter data to see your performance summary.
              </div>
            </div>
            <div class="insight-card">
              <h3>Recommendations</h3>
              <div id="ai-insights" class="insights-list">
                <div class="insight-item">
                  <div class="insight-priority high"></div>
                  <div class="insight-content">
                    <div class="insight-title">Upload data to see insights</div>
                    <div class="insight-description">System will analyze your data and provide actionable recommendations</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Personnel Section -->
    <section id="personnel" class="dashboard-section">
      <div class="container">
        <div class="section-header">
          <h2>Personnel Management</h2>
          <p>Track cashier and pump attendant performance with month-over-month analysis</p>
          <div class="report-source-info">
            <p id="personnel-report-source">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 4px; display: inline-block; vertical-align: middle;">
                <path d="M3 3V9H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M21 21V15H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M18.49 9A9 9 0 0 0 3.64 5.64L3 9M21 15L20.36 18.36A9 9 0 0 1 5.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Data source: No reports uploaded yet
            </p>
          </div>
        </div>

        <!-- Personnel Overview -->
        <div class="personnel-overview">
          <div class="personnel-metrics">
            <div class="personnel-card">
              <h3>Cashiers</h3>
              <div class="personnel-stats">
                <div class="stat-item">
                  <div class="stat-value" id="cashier-count">0</div>
                  <div class="stat-label">Active Cashiers</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value" id="cashier-performance">0%</div>
                  <div class="stat-label">Avg Performance</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value" id="cashier-red-flags">0</div>
                  <div class="stat-label">Red Flags</div>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="cashierChart"></canvas>
              </div>
            </div>
            <div class="personnel-card">
              <h3>Pump Attendants</h3>
              <div class="personnel-stats">
                <div class="stat-item">
                  <div class="stat-value" id="attendant-count">0</div>
                  <div class="stat-label">Active Attendants</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value" id="attendant-performance">0%</div>
                  <div class="stat-label">Avg Performance</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value" id="attendant-red-flags">0</div>
                  <div class="stat-label">Red Flags</div>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="attendantChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Month-over-Month Performance -->
        <div class="performance-comparison">
          <h3>Month-over-Month Performance</h3>
          <div class="comparison-grid">
            <div class="comparison-card">
              <h4>Cashier Performance Trends</h4>
              <div class="chart-container">
                <canvas id="cashierTrendChart"></canvas>
              </div>
              <button class="download-btn" onclick="downloadChart('cashierTrendChart', 'cashier-trends')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                  <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Download
              </button>
            </div>
            <div class="comparison-card">
              <h4>Pump Attendant Performance Trends</h4>
              <div class="chart-container">
                <canvas id="attendantTrendChart"></canvas>
              </div>
              <button class="download-btn" onclick="downloadChart('attendantTrendChart', 'attendant-trends')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                  <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Download
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Users Section -->
    <section id="users" class="dashboard-section alt">
      <div class="container">
        <div class="section-header">
          <h2>🔑 API Key Management & Integration</h2>
          <p>Configure and manage API connections for real-time data integration with your fuel business systems</p>
        </div>

        <div class="users-content">
          <!-- API Connection Status -->
          <div class="current-user-card">
            <div class="user-info">
              <div class="user-avatar">
                <span class="avatar-initial">🔗</span>
              </div>
              <div class="user-details">
                <h3>Fuel Torque API Connection</h3>
                <p>Site: Shell Mapulaneng Bushbuckridge (ID: 651)</p>
                <span class="user-status" id="api-connection-status">Status: Configured</span>
              </div>
            </div>
            <div class="user-actions">
              <button class="btn btn-primary" onclick="testApiConnection()">🧪 Test Connection</button>
              <button class="btn btn-secondary" onclick="configureApiSettings()">⚙️ Configure</button>
            </div>
          </div>

          <!-- API Configuration Grid -->
          <div class="users-grid">
            <!-- API Settings -->
            <div class="user-list-section">
              <div class="section-subheader">
                <h3>⚙️ API Configuration</h3>
                <button class="btn btn-success" onclick="saveApiSettings()">💾 Save Settings</button>
              </div>
              
              <div class="api-settings-form">
                <div class="form-group">
                  <label for="api-access-key">Access Key</label>
                  <input type="password" id="api-access-key" value="9t7i0b4eajkaH2zoutN8-exoM62YWTuL" placeholder="Enter your API access key">
                </div>
                
                <div class="form-group">
                  <label for="site-id">Site ID</label>
                  <input type="text" id="site-id" value="651" placeholder="Enter site ID">
                </div>
                
                <div class="form-group">
                  <label for="site-name">Site Name</label>
                  <input type="text" id="site-name" value="Shell Mapulaneng Bushbuckridge" placeholder="Enter site name">
                </div>
                
                <div class="form-group">
                  <label for="api-base-url">API Base URL</label>
                  <input type="text" id="api-base-url" value="https://api.fueltorque.com" placeholder="Enter API base URL">
                </div>
              </div>
            </div>

            <!-- API Status & Metrics -->
            <div class="user-analytics-section">
              <div class="section-subheader">
                <h3>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px; display: inline-block; vertical-align: middle;">
                    <path d="M3 3V9H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M21 21V15H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18.49 9A9 9 0 0 0 3.64 5.64L3 9M21 15L20.36 18.36A9 9 0 0 1 5.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Connection Status
                </h3>
              </div>
              
              <div class="user-metrics-grid">
                <div class="metric-card">
                  <div class="metric-icon">🔗</div>
                  <div class="metric-content">
                    <h4>Connection Status</h4>
                    <p id="connection-status">Connected</p>
                  </div>
                </div>
                
                <div class="metric-card">
                  <div class="metric-icon">📡</div>
                  <div class="metric-content">
                    <h4>Last Sync</h4>
                    <p id="last-sync-time">2 min ago</p>
                  </div>
                </div>
                
                <div class="metric-card">
                  <div class="metric-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M3 3V9H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M21 21V15H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M18.49 9A9 9 0 0 0 3.64 5.64L3 9M21 15L20.36 18.36A9 9 0 0 1 5.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="metric-content">
                    <h4>Data Points</h4>
                    <p id="data-points-count">1,247</p>
                  </div>
                </div>
                
                <div class="metric-card">
                  <div class="metric-icon">⚡</div>
                  <div class="metric-content">
                    <h4>Response Time</h4>
                    <p id="response-time">245ms</p>
                  </div>
                </div>
              </div>

              <!-- API Activity Chart -->
              <div class="user-activity-chart">
                <h4>API Call Activity</h4>
                <canvas id="api-activity-chart" width="400" height="200"></canvas>
              </div>
            </div>
          </div>

          <!-- API Integration Options -->
          <div class="user-permissions-section">
            <div class="section-subheader">
              <h3>🔧 Integration Options</h3>
            </div>
            
            <div class="permissions-grid">
              <div class="permission-card">
                <h4>Data Sync Settings</h4>
                <div class="permission-levels">
                  <label class="permission-option">
                    <input type="checkbox" checked> Real-time Updates
                  </label>
                  <label class="permission-option">
                    <input type="checkbox" checked> Historical Data
                  </label>
                  <label class="permission-option">
                    <input type="checkbox"> Automated Reports
                  </label>
                </div>
              </div>
              
              <div class="permission-card">
                <h4>Data Types</h4>
                <div class="permission-levels">
                  <label class="permission-option">
                    <input type="checkbox" checked> Fuel Sales
                  </label>
                  <label class="permission-option">
                    <input type="checkbox" checked> Shop Revenue
                  </label>
                  <label class="permission-option">
                    <input type="checkbox"> Pump Status
                  </label>
                </div>
              </div>
              
              <div class="permission-card">
                <h4>Security & Access</h4>
                <div class="permission-levels">
                  <label class="permission-option">
                    <input type="checkbox" checked> Encrypted Connection
                  </label>
                  <label class="permission-option">
                    <input type="checkbox"> Rate Limiting
                  </label>
                  <label class="permission-option">
                    <input type="checkbox"> Audit Logging
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Expansion Section -->
    <section id="expansion" class="dashboard-section">
      <div class="container">
        <div class="section-header">
          <h2>Expansion Planning & Analysis</h2>
          <p>Strategic expansion planning with market analysis and ROI projections</p>
        </div>

        <div class="expansion-content">
          <div class="expansion-overview">
            <div class="expansion-metrics">
              <div class="metric-card">
                <div class="metric-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 5.02944 7.02944 1 12 1C16.9706 1 21 5.02944 21 10Z" stroke="currentColor" stroke-width="2"/>
                    <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2"/>
                  </svg>
                </div>
                <div class="metric-content">
                  <div class="metric-title">Potential Sites</div>
                  <div class="metric-value" id="potential-sites">0</div>
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 3V9H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M21 21V15H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18.49 9A9 9 0 0 0 3.64 5.64L3 9M21 15L20.36 18.36A9 9 0 0 1 5.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div class="metric-content">
                  <div class="metric-title">Market Analysis</div>
                  <div class="metric-value" id="market-score">0/10</div>
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
                  </svg>
                </div>
                <div class="metric-content">
                  <div class="metric-title">Projected ROI</div>
                  <div class="metric-value" id="projected-roi">0%</div>
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 7V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div class="metric-content">
                  <div class="metric-title">Timeline</div>
                  <div class="metric-value" id="expansion-timeline">0 months</div>
                </div>
              </div>
            </div>
          </div>

          <div class="expansion-analysis">
            <h3>Market Analysis & Opportunities</h3>
            <div class="analysis-grid">
              <div class="analysis-card">
                <h4>Geographic Analysis</h4>
                <div class="chart-container">
                  <canvas id="geographicChart"></canvas>
                </div>
                <button class="download-btn" onclick="downloadChart('geographicChart', 'geographic-analysis')">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                    <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Download
                </button>
              </div>
              <div class="analysis-card">
                <h4>ROI Projections</h4>
                <div class="chart-container">
                  <canvas id="roiChart"></canvas>
                </div>
                <button class="download-btn" onclick="downloadChart('roiChart', 'roi-projections')">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                    <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Download
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container footer-inner">
      <div>© <span id="year"></span> FUEL FLUX - Analytics Dashboard</div>
      <div class="footer-links">
        <a href="#overview">Overview</a>
        <a href="#reports">Reports</a>
        <a href="#analytics">Analytics</a>
        <a href="#insights">Insights</a>
        <a href="#personnel">Personnel</a>
        <a href="#renovation">Renovation</a>
        <a href="#expansion">Expansion</a>
      </div>
    </div>
  </footer>

  <script>
    // Footer year
    document.getElementById('year').textContent = new Date().getFullYear();

    // Chart.js Configuration
    Chart.defaults.color = '#b7c2e7';
    Chart.defaults.borderColor = '#263258';
    Chart.defaults.font.family = 'Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif';

    // Chart instances
    let revenueChart, fuelDistributionChart, profitChart, shopChart;

    // Initialize all charts
    function initializeCharts() {
      // Revenue Chart
      const revenueCtx = document.getElementById('revenueChart');
      if (revenueCtx) {
        revenueChart = new Chart(revenueCtx, {
          type: 'line',
          data: {
            labels: ['Current', 'Forecast'],
            datasets: [{
              label: 'Revenue (ZAR)',
              data: [0, 0],
              borderColor: '#5b8cff',
              backgroundColor: 'rgba(91, 140, 255, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return 'R ' + value.toLocaleString();
                  }
                }
              }
            }
          }
        });
      }

      // Fuel Distribution Chart
      const fuelDistCtx = document.getElementById('fuelDistributionChart');
      if (fuelDistCtx) {
        fuelDistributionChart = new Chart(fuelDistCtx, {
          type: 'doughnut',
          data: {
            labels: ['Diesel Ex', 'V-Power 95', 'V-Power Diesel'],
            datasets: [{
              data: [0, 0, 0],
              backgroundColor: ['#5b8cff', '#7ac7ff', '#50e3c2'],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 20,
                  usePointStyle: true
                }
              }
            }
          }
        });
      }

      // Profitability Chart
      const profitCtx = document.getElementById('profitChart');
      if (profitCtx) {
        profitChart = new Chart(profitCtx, {
          type: 'bar',
          data: {
            labels: ['Diesel Ex', 'V-Power 95', 'V-Power Diesel'],
            datasets: [{
              label: 'Profit (ZAR)',
              data: [0, 0, 0],
              backgroundColor: ['#50e3c2', '#ffb74d', '#ff6b6b']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return 'R ' + value.toLocaleString();
                  }
                }
              }
            }
          }
        });
      }

      // Shop Sales Chart
      const shopCtx = document.getElementById('shopChart');
      if (shopCtx) {
        shopChart = new Chart(shopCtx, {
          type: 'bar',
          data: {
            labels: [],
            datasets: [{
              label: 'Revenue (ZAR)',
              data: [],
              backgroundColor: '#ffb74d'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return 'R ' + value.toLocaleString();
                  }
                }
              }
            }
          }
        });
      }
    }

    // Update dashboard metrics
    function updateDashboardMetrics(fuelData, shopData) {
      const totalRevenue = Object.values(fuelData).reduce((sum, fuel) => sum + (fuel.revenue || 0), 0) + 
                          shopData.reduce((sum, shop) => sum + (shop.revenue || 0), 0);
      
      const totalProfit = Object.values(fuelData).reduce((sum, fuel) => {
        const profit = (fuel.sell - fuel.cost) * fuel.qty_l;
        return sum + (profit || 0);
      }, 0);
      
      const totalVolume = Object.values(fuelData).reduce((sum, fuel) => sum + (fuel.qty_l || 0), 0);
      
      // Calculate shop-fuel ratio (shop revenue per liter of fuel)
      const shopRevenue = shopData.reduce((sum, shop) => sum + (shop.revenue || 0), 0);
      const shopFuelRatio = totalVolume > 0 ? (shopRevenue / totalVolume).toFixed(2) : '0.00';
      const ratioDisplay = `R ${shopFuelRatio}/L`;

      // Update metric cards
      document.getElementById('total-revenue').textContent = formatRand(totalRevenue);
      document.getElementById('total-profit').textContent = formatRand(totalProfit);
      document.getElementById('total-volume').textContent = `${totalVolume.toLocaleString()} L`;
      document.getElementById('shop-fuel-ratio').textContent = ratioDisplay;

      // Update KPI indicators
      // 1. Shop to Fuel Ratio (shop revenue per liter of fuel)
      document.getElementById('shop-fuel-ratio-kpi').textContent = ratioDisplay;
      
      // 2. Fuel Margins in Rands (total fuel profit)
      document.getElementById('fuel-margins-rand').textContent = formatRand(totalProfit);
      
      // 3. Revenue Growth Rate (month-over-month - simulated for now)
      const growthRate = Math.random() > 0.5 ? Math.floor(Math.random() * 20) + 1 : -(Math.floor(Math.random() * 10) + 1);
      document.getElementById('revenue-growth-rate').textContent = `${growthRate > 0 ? '+' : ''}${growthRate}%`;
      
      // 4. Shop Profit Margin (shop profit as percentage of shop revenue)
      const shopProfit = shopData.reduce((sum, shop) => {
        // Assuming shop profit margin is 25% (this would come from actual shop cost data)
        const profit = shop.revenue * 0.25;
        return sum + profit;
      }, 0);
      const shopProfitMargin = shopRevenue > 0 ? ((shopProfit / shopRevenue) * 100).toFixed(1) : '0.0';
      document.getElementById('shop-profit-margin').textContent = `${shopProfitMargin}%`;

      // Update change indicators (simulated)
      const changes = ['revenue-change', 'profit-change', 'volume-change', 'ratio-change'];
      changes.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          const change = Math.random() > 0.5 ? Math.floor(Math.random() * 20) + 1 : -(Math.floor(Math.random() * 10) + 1);
          element.textContent = `${change > 0 ? '+' : ''}${change}%`;
          element.className = `metric-change ${change >= 0 ? 'positive' : 'negative'}`;
        }
      });
    }

    // Update charts with new data
    function updateCharts(fuelData, shopData, forecastData) {
      // Update revenue chart
      if (revenueChart) {
        const currentRevenue = Object.values(fuelData).reduce((sum, fuel) => sum + (fuel.revenue || 0), 0);
        const forecastRevenue = forecastData ? 
          Object.values(forecastData.fuels).reduce((sum, fuel) => sum + (fuel.total_revenue_zar || 0), 0) : 
          currentRevenue * 1.05;
        
        revenueChart.data.datasets[0].data = [currentRevenue, forecastRevenue];
        revenueChart.update();
      }

      // Update fuel distribution chart
      if (fuelDistributionChart) {
        const totalFuelRevenue = Object.values(fuelData).reduce((sum, fuel) => sum + (fuel.revenue || 0), 0);
        if (totalFuelRevenue > 0) {
          fuelDistributionChart.data.datasets[0].data = [
            fuelData.diesel_ex?.revenue || 0,
            fuelData.vpower_95?.revenue || 0,
            fuelData.vpower_diesel?.revenue || 0
          ];
          fuelDistributionChart.update();
        }
      }

      // Update shop chart
      if (shopChart && shopData.length > 0) {
        shopChart.data.labels = shopData.map(shop => shop.category);
        shopChart.data.datasets[0].data = shopData.map(shop => shop.revenue);
        shopChart.update();
      }

      // Update profitability chart
      if (profitChart) {
        profitChart.data.datasets[0].data = [
          (fuelData.diesel_ex?.sell - fuelData.diesel_ex?.cost) * fuelData.diesel_ex?.qty_l || 0,
          (fuelData.vpower_95?.sell - fuelData.vpower_95?.cost) * fuelData.vpower_95?.qty_l || 0,
          (fuelData.vpower_diesel?.sell - fuelData.vpower_diesel?.cost) * fuelData.vpower_diesel?.qty_l || 0
        ];
        profitChart.update();
      }
    }

    // Generate insights
    function generateInsights(fuelData, shopData) {
      const insights = [];
      
      // Analyze fuel performance
      const fuelRevenues = Object.values(fuelData).map(f => f.revenue || 0);
      const maxFuelRevenue = Math.max(...fuelRevenues);
      const totalFuelRevenue = fuelRevenues.reduce((sum, rev) => sum + rev, 0);
      
      if (maxFuelRevenue > 0) {
        const topFuel = Object.keys(fuelData).find(key => fuelData[key].revenue === maxFuelRevenue);
        insights.push({
          priority: 'high',
          title: `${topFuel?.replace('_', ' ').toUpperCase()} is your top performer`,
          description: `Generating ${((maxFuelRevenue / totalFuelRevenue) * 100).toFixed(1)}% of fuel revenue`
        });
      }

      // Analyze shop performance
      if (shopData.length > 0) {
        const topShop = shopData.reduce((max, shop) => shop.revenue > max.revenue ? shop : max);
        insights.push({
          priority: 'medium',
          title: `${topShop.category} leads shop sales`,
          description: `Generating R ${topShop.revenue.toLocaleString()} in revenue`
        });
      }

      // Profitability insights
      const profits = Object.values(fuelData).map(fuel => {
        return (fuel.sell - fuel.cost) * fuel.qty_l;
      });
      const totalProfit = profits.reduce((sum, profit) => sum + profit, 0);
      
      if (totalProfit > 0) {
        insights.push({
          priority: 'low',
          title: 'Strong profitability achieved',
          description: `Total profit of R ${totalProfit.toLocaleString()} from fuel sales`
        });
      }

      return insights;
    }

    // Update insights display
    function updateInsights(insights) {
      const container = document.getElementById('ai-insights');
      if (!container) return;

      container.innerHTML = insights.length > 0 ? 
        insights.map(insight => `
          <div class="insight-item">
            <div class="insight-priority ${insight.priority}"></div>
            <div class="insight-content">
              <div class="insight-title">${insight.title}</div>
              <div class="insight-description">${insight.description}</div>
            </div>
          </div>
        `).join('') :
        `<div class="insight-item">
          <div class="insight-priority high"></div>
          <div class="insight-content">
            <div class="insight-title">Upload data to see insights</div>
            <div class="insight-description">System will analyze your data and provide actionable recommendations</div>
          </div>
        </div>`;
    }

    // Utility function for formatting currency
    function formatRand(n) {
      try { 
        return new Intl.NumberFormat('en-ZA', { 
          style: 'currency', 
          currency: 'ZAR', 
          maximumFractionDigits: 0 
        }).format(n || 0); 
      } catch { 
        return `R ${Math.round(n || 0).toLocaleString()}`; 
      }
    }

    // Optional: show user email and allow sign out using stored Supabase config
    (function() {
      const emailEl = document.getElementById('user-email');
      const signoutBtn = document.getElementById('signout');
      function getStored(key, fallback) { try { return localStorage.getItem(key) || fallback; } catch { return fallback; } }
      const url = getStored('fi_supabase_url', '');
      const key = getStored('fi_supabase_key', '');
      const sb = (window.supabase && url && key) ? window.supabase.createClient(url, key) : null;
      async function load() {
        if (!sb) return;
        const { data: { session } } = await sb.auth.getSession();
        if (session && session.user && emailEl) emailEl.textContent = session.user.email;
      }
      load();
      if (signoutBtn && sb) {
        signoutBtn.addEventListener('click', async () => {
          await sb.auth.signOut();
          window.location.href = 'index.html';
        });
      }
    })();

    // Simple state + helpers for upload/inputs and summaries
    (function(){
      // Initialize Supabase integration
      let db = null;
      
      // Initialize database connection
      async function initializeDatabase() {
        try {
          console.log('Starting database initialization...');
          console.log('window.fuelAnalyticsDB exists:', !!window.fuelAnalyticsDB);
          console.log('window.supabase exists:', !!window.supabase);
          
          if (window.fuelAnalyticsDB) {
            db = window.fuelAnalyticsDB;
            // Make db globally accessible
            window.db = db;
            console.log('Database object created, attempting to initialize...');
            const result = await db.initialize();
            console.log('Database initialization result:', result);
            
            if (result.success) {
              console.log('Database initialized successfully');
              document.getElementById('user-email').textContent = result.user.email;
              
              // Load existing reports from database
              await loadReportsFromDatabase();
              await loadMonthlyPerformanceFromDatabase();
              
              // Also load from storage as backup
              await loadReportsFromStorage();
              
                    // Run fast tests and cleanup asynchronously
      setTimeout(() => {
        console.log('Running quick integration tests...');
        testPersonnelAndManualIntegrations();
        removePlaceholderAugustReport();
      }, 100);
              
              // Now load personnel data after reports are loaded
              console.log('Reports loaded, now loading personnel data...');
              loadPersonnelDataFromReport();

              // Auto-refresh metrics into Overview and Overview Over Time on open
              try {
                await refreshAllDashboardData();
                // If there is historical data, render the Overview Over Time section once
                const hasHistory = Object.keys(window.monthlyData || {}).length > 0;
                if (hasHistory) {
                  renderOverviewOverTime();
                }
              } catch (e) {
                console.warn('Initial refresh/render failed:', e);
              }
      
      // Add event listener for personnel section to refresh data when clicked
      document.addEventListener('DOMContentLoaded', () => {
        const personnelNav = document.querySelector('a[href="#personnel"]');
        if (personnelNav) {
          personnelNav.addEventListener('click', () => {
            console.log('👥 Personnel section clicked - refreshing data...');
            setTimeout(() => {
              loadPersonnelDataFromReport();
            }, 100);
          });
        }
      });
              
                      // Set up automatic data refresh
        setupAutomaticDataRefresh();
        
        // Set up fuel price tracking
        setupFuelPriceTracking();
            } else {
              console.log('No authenticated user, using local storage');
              console.log('Authentication status:', await db.checkAuthStatus());
              
              // Try to create a test user for demonstration
              await createTestUser();
            }
          } else {
            console.error('window.fuelAnalyticsDB not found!');
            // Try to load from storage anyway
            await loadReportsFromStorage();
          }
        } catch (error) {
          console.error('Database initialization failed:', error);
          // Try to load from storage as fallback
          await loadReportsFromStorage();
        }
      }

      // Create a test user for demonstration
      async function createTestUser() {
        try {
          console.log('Attempting to create test user...');
          const testEmail = 'test@fuelstation.com';
          const testPassword = 'testpassword123';
          
          // Try to sign up first
          const { data, error } = await supabase.auth.signUp({
            email: testEmail,
            password: testPassword
          });
          
          if (error) {
            console.log('Sign up error (user might exist):', error.message);
            // Try to sign in instead
            const signInResult = await db.signIn(testEmail, testPassword);
            if (signInResult.success) {
              console.log('Test user signed in successfully');
              // Re-initialize database
              await initializeDatabase();
            } else {
              console.log('Test user sign in failed:', signInResult.error);
            }
          } else {
            console.log('Test user created successfully');
            // Re-initialize database
            await initializeDatabase();
          }
        } catch (error) {
          console.error('Error creating test user:', error);
        }
      }

      // Load reports from Supabase database
      async function loadReportsFromDatabase() {
        if (!db || !db.isInitialized) return;
        
        try {
          const result = await db.getMonthlyReports();
          if (result.success) {
            // Convert database format to local format
            uploadedReports.length = 0; // Clear existing reports
            
            result.reports.forEach(report => {
              const reportData = {
                name: report.file_name,
                month: report.report_month,
                year: report.report_year,
                uploadDate: new Date(report.created_at).toLocaleDateString(),
                data: {
                  period: { month: report.report_month, year: report.report_year },
                  fuels: {
                    diesel_ex: report.fuel_data.find(f => f.fuel_type === 'diesel_ex') || { total_revenue_zar: 0, quantity_liters: 0 },
                    vpower_95: report.fuel_data.find(f => f.fuel_type === 'vpower_95') || { total_revenue_zar: 0, quantity_liters: 0 },
                    vpower_diesel: report.fuel_data.find(f => f.fuel_type === 'vpower_diesel') || { total_revenue_zar: 0, quantity_liters: 0 }
                  },
                  shop_lines: report.shop_data.map(s => ({
                    category: s.category,
                    total_revenue_zar: s.total_revenue,
                    quantity_units: s.quantity_units
                  }))
                },
                id: report.id // Store database ID for operations
              };
              
              uploadedReports.push(reportData);
            });
            
            renderReportsHistory();
            console.log(`Loaded ${uploadedReports.length} reports from database`);
          }
        } catch (error) {
          console.error('Error loading reports from database:', error);
        }
      }

      // Load monthly performance from database
      async function loadMonthlyPerformanceFromDatabase() {
        if (!db || !db.isInitialized) return;
        
        try {
          const result = await db.getOverallPerformance();
          if (result.success) {
            // Convert database data to monthly format
            Object.keys(monthlyData).forEach(key => delete monthlyData[key]);
            
            result.monthlyData.forEach(report => {
              const monthKey = `${report.report_month}/${report.report_year}`;
              if (!monthlyData[monthKey]) {
                monthlyData[monthKey] = [];
              }
              
              monthlyData[monthKey].push({
                name: `Report_${report.report_year}_${report.report_month.toString().padStart(2, '0')}`,
                month: report.report_month,
                year: report.report_year,
                uploadDate: new Date().toLocaleDateString(),
                data: {
                  period: { month: report.report_month, year: report.report_year },
                  fuels: {
                    diesel_ex: { total_revenue_zar: report.total_revenue * 0.4, quantity_liters: report.total_volume * 0.4 },
                    vpower_95: { total_revenue_zar: report.total_revenue * 0.35, quantity_liters: report.total_volume * 0.35 },
                    vpower_diesel: { total_revenue_zar: report.total_revenue * 0.25, quantity_liters: report.total_volume * 0.25 }
                  },
                  shop_lines: []
                }
              });
            });
            
            renderMonthlyPerformance();
          }
        } catch (error) {
          console.error('Error loading monthly performance from database:', error);
        }
      }

      // Save report to database
      async function saveReportToDatabase(reportData) {
        if (!db || !db.isInitialized) {
          console.log('Database not available, using local storage only');
          return;
        }
        
        try {
          const result = await db.saveMonthlyReport(reportData);
          if (result.success) {
            console.log('Report saved to database:', result.reportId);
            
            // Reload reports to get the updated list
            await loadReportsFromDatabase();
            await loadMonthlyPerformanceFromDatabase();
            
            return result.reportId;
          } else {
            console.error('Failed to save report to database:', result.error);
          }
        } catch (error) {
          console.error('Error saving report to database:', error);
        }
      }

      // Delete report from database
      async function deleteReportFromDatabase(reportId) {
        if (!db || !db.isInitialized) return;
        
        try {
          const result = await db.deleteMonthlyReport(reportId);
          if (result.success) {
            console.log('Report deleted from database:', reportId);
            await loadReportsFromDatabase();
            await loadMonthlyPerformanceFromDatabase();
          } else {
            console.error('Failed to delete report from database:', result.error);
          }
        } catch (error) {
          console.error('Error deleting report from database:', error);
        }
      }

      const state = {
        fuel: {
          diesel_ex: { revenue: 0, qty_l: 0, sell: 0, cost: 0 },
          vpower_95: { revenue: 0, qty_l: 0, sell: 0, cost: 0 },
          vpower_diesel: { revenue: 0, qty_l: 0, sell: 0, cost: 0 }
        },
        shop: [
          { category: 'Deli Onsite', revenue: 359775, units: 0 }
        ]
      };

      const el = (id) => document.getElementById(id);
      const fields = {
        diesel: { revenue: el('fuel-diesel-revenue'), qty: el('fuel-diesel-qty'), sell: el('fuel-diesel-sell'), cost: el('fuel-diesel-cost') },
        v95: { revenue: el('fuel-v95-revenue'), qty: el('fuel-v95-qty'), sell: el('fuel-v95-sell'), cost: el('fuel-v95-cost') },
        vd: { revenue: el('fuel-vd-revenue'), qty: el('fuel-vd-qty'), sell: el('fuel-vd-sell'), cost: el('fuel-vd-cost') }
      };
      
      // Make variables globally accessible for viewReport and deleteReport functions
      window.fields = fields;
      window.state = state;
      window.renderSummary = renderSummary;

      function toNum(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
      function syncFromInputs(){
        state.fuel.diesel_ex.revenue = toNum(fields.diesel.revenue?.value);
        state.fuel.diesel_ex.qty_l   = toNum(fields.diesel.qty?.value);
        state.fuel.diesel_ex.sell    = toNum(fields.diesel.sell?.value);
        state.fuel.diesel_ex.cost    = toNum(fields.diesel.cost?.value);

        state.fuel.vpower_95.revenue = toNum(fields.v95.revenue?.value);
        state.fuel.vpower_95.qty_l   = toNum(fields.v95.qty?.value);
        state.fuel.vpower_95.sell    = toNum(fields.v95.sell?.value);
        state.fuel.vpower_95.cost    = toNum(fields.v95.cost?.value);

        state.fuel.vpower_diesel.revenue = toNum(fields.vd.revenue?.value);
        state.fuel.vpower_diesel.qty_l   = toNum(fields.vd.qty?.value);
        state.fuel.vpower_diesel.sell    = toNum(fields.vd.sell?.value);
        state.fuel.vpower_diesel.cost    = toNum(fields.vd.cost?.value);
      }

      function calcFuelProfit(item){
        const margin = (item.sell - item.cost);
        return margin * item.qty_l;
      }

      function formatRand(n){
        try { return new Intl.NumberFormat('en-ZA', { style: 'currency', currency: 'ZAR', maximumFractionDigits: 0 }).format(n||0); } catch { return `R ${Math.round(n||0).toLocaleString()}`; }
      }

      function renderSummary(){
        const s = el('summary');
        if (!s) return;
        syncFromInputs();
        const f = state.fuel;
        const lines = [];
        lines.push('Fuel (Totals = gross revenue; Qty = litres; Profit = (sell − cost) × qty):');
        lines.push(`• Diesel Ex — Total: ${formatRand(f.diesel_ex.revenue)}, Qty: ${f.diesel_ex.qty_l} L, Profit: ${formatRand(calcFuelProfit(f.diesel_ex))}`);
        lines.push(`• V‑Power 95 — Total: ${formatRand(f.vpower_95.revenue)}, Qty: ${f.vpower_95.qty_l} L, Profit: ${formatRand(calcFuelProfit(f.vpower_95))}`);
        lines.push(`• V‑Power Diesel — Total: ${formatRand(f.vpower_diesel.revenue)}, Qty: ${f.vpower_diesel.qty_l} L, Profit: ${formatRand(calcFuelProfit(f.vpower_diesel))}`);
        lines.push('');
        lines.push('Shop (Totals = gross revenue; Qty = units):');
        state.shop.forEach(c => {
          lines.push(`• ${c.category} — Total: ${formatRand(c.revenue)}, Qty: ${c.units} units`);
        });
        s.textContent = lines.join('\n');

        // Update dashboard metrics and charts
        updateDashboardMetrics(f, state.shop);
        updateCharts(f, state.shop);
        
        // Update fuel margins table
        updateFuelMargins(f);
        
        // Update fuel distribution chart with percentages
        updateFuelDistributionChart(f);
        
        // Generate and update insights
        const insights = generateInsights(f, state.shop);
        updateInsights(insights);
      }

      function buildPrompt(){
        const f = state.fuel; const shop = state.shop;
        const header = 'Analyze this monthly station report. Rules: interpret each Total as gross revenue. For fuel, quantity is litres; for shop, quantity is units. Ignore profitability fields in the source. Compute fuel profit as (manual selling price − manual cost price) × quantity. Provide 5 concise insights and 3 actionable recommendations. Avoid inventing data.';
        const fuelBlock = `Fuel\n- Diesel Ex: total ${f.diesel_ex.revenue} ZAR; quantity ${f.diesel_ex.qty_l} L; sell ${f.diesel_ex.sell} R/L; cost ${f.diesel_ex.cost} R/L\n- V‑Power 95: total ${f.vpower_95.revenue} ZAR; quantity ${f.vpower_95.qty_l} L; sell ${f.vpower_95.sell} R/L; cost ${f.vpower_95.cost} R/L\n- V‑Power Diesel: total ${f.vpower_diesel.revenue} ZAR; quantity ${f.vpower_diesel.qty_l} L; sell ${f.vpower_diesel.sell} R/L; cost ${f.vpower_diesel.cost} R/L`;
        const shopLines = shop.map(c => `- ${c.category}: total ${c.revenue} ZAR; quantity ${c.units} units`).join('\n');
        return `${header}\n\n${fuelBlock}\n\nShop\n${shopLines}`;
      }

      // Wire controls
      const uploadTrigger = el('upload-trigger');
      const reportInputMain = document.getElementById('report-file-main');
      const manualEntryBtn = el('manual-entry');
      const viewHistoryBtn = el('view-history');
      const analyzeBtn = el('analyze-ai');
      const cancelUploadBtn = el('cancel-upload');
      const saveDataBtn = el('save-data');
      const cancelManualBtn = el('cancel-manual');
      const loadFromReportsBtn = el('load-from-reports');
      // Sample data buttons removed - now using real report data
      const analyzeStatus = document.getElementById('analyze-status');
      const uploadArea = el('upload-area');
      const manualForm = el('manual-form');
      const reportsHistory = el('reports-history');
      const reportsList = el('reports-list');
      const monthlyPerformanceBtn = el('monthly-performance-btn');
      const monthlyPerformance = el('monthly-performance');
      
      // Make UI elements globally accessible for viewReport function
      window.uploadArea = uploadArea;
      window.manualForm = manualForm;
      window.reportsHistory = reportsHistory;
      window.monthlyPerformance = monthlyPerformance;
      const monthButtons = el('month-buttons');
      const overallMetrics = el('overall-metrics');
      const monthlyMetrics = el('monthly-metrics');
      const shopInputsContainer = document.getElementById('shop-inputs');
      const addShopItemBtn = el('add-shop-item');
      const overviewOverTimeBtn = el('overview-over-time-btn');
      const testStorageBtn = el('test-storage');
      
      // Store uploaded reports and monthly data
      const uploadedReports = [];
      const monthlyData = {};
      let selectedMonth = null;
      
      // Make uploadedReports and monthlyData globally accessible
      window.uploadedReports = uploadedReports;
      window.monthlyData = monthlyData;

      // Prefer Supabase Edge Functions if a project URL is configured; fallback to local dev
      const storedUrl = (typeof localStorage !== 'undefined') ? (localStorage.getItem('fi_supabase_url') || '') : '';
      let BACKEND_URL = 'http://localhost:8787';
      try {
        if (storedUrl) {
          const ref = new URL(storedUrl).host.split('.')[0];
          if (ref) BACKEND_URL = `https://${ref}.functions.supabase.co`;
        } else {
          // Fallback to your project ref if localStorage was not set by index.html
          BACKEND_URL = 'https://fynfomhoikzpsrbghnzr.functions.supabase.co';
        }
      } catch {
        // If parsing fails, fallback to your project ref
        BACKEND_URL = 'https://fynfomhoikzpsrbghnzr.functions.supabase.co';
      }

      // PDF.js text extractor (client-side) for Supabase Edge Functions flow
      async function extractPdfText(file){
        if (!window['pdfjsLib']) {
          throw new Error('PDF.js not loaded - cannot extract text from PDF');
        }
        const pdfjsLib = window['pdfjsLib'];
        if (pdfjsLib.GlobalWorkerOptions) {
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
        try {
          console.log('Starting PDF extraction for file:', file.name, 'Size:', file.size);
          
          const buf = await file.arrayBuffer();
          console.log('File converted to ArrayBuffer, size:', buf.byteLength);
          
          const loadingTask = pdfjsLib.getDocument({ data: buf });
          console.log('PDF loading task created');
          
          const pdf = await loadingTask.promise;
          console.log('PDF loaded successfully, pages:', pdf.numPages);
          
          let fullText = '';
          for (let p = 1; p <= pdf.numPages; p++) {
            console.log('Processing page', p);
            const page = await pdf.getPage(p);
            const content = await page.getTextContent();
            const pageText = content.items.map((it) => (it.str || '')).join(' ');
            fullText += `\n\n=== Page ${p} ===\n${pageText}`;
          }
          
          console.log('PDF extraction complete, text length:', fullText.length);
          return fullText.trim();
          
        } catch (error) {
          console.error('PDF extraction error:', error);
          throw new Error(`PDF extraction failed: ${error.message}`);
        }
      }

      function setField(input, value){ if (input) input.value = value === undefined ? '' : String(value); }
      
      // Make setField globally accessible
      window.setField = setField;

      uploadTrigger?.addEventListener('click', () => {
        uploadArea.style.display = 'block';
        manualForm.style.display = 'none';
        reportsHistory.style.display = 'none';
        monthlyPerformance.style.display = 'none';
      });

      reportInputMain?.addEventListener('change', (event) => {
        const file = event.target.files[0];
        const placeholder = document.querySelector('.upload-placeholder');
        if (file) {
          // Check for duplicate file
          if (isDuplicateFile(file)) {
            analyzeStatus.textContent = `⚠️ File "${file.name}" has already been uploaded. Please select a different file.`;
            analyzeBtn.disabled = true;
            placeholder?.classList.remove('has-file');
            event.target.value = ''; // Clear the input
            return;
          }
          
          analyzeStatus.textContent = `File selected: ${file.name}`;
          analyzeBtn.disabled = false;
          placeholder?.classList.add('has-file');
        } else {
          analyzeStatus.textContent = '';
          analyzeBtn.disabled = true;
          placeholder?.classList.remove('has-file');
        }
      });

      manualEntryBtn?.addEventListener('click', () => {
        uploadArea.style.display = 'none';
        manualForm.style.display = 'block';
        reportsHistory.style.display = 'none';
        monthlyPerformance.style.display = 'none';
        reportInputMain.value = ''; // Clear uploaded file
        renderSummary(); // Clear summary and regenerate insights
        
        // Load fuel price history when manual entry is opened
        updateFuelPriceHistoryDisplay();
        
        // Update smart loading availability
        updateManualDataSourceInfo();
      });

      // Load from reports button event listener
      loadFromReportsBtn?.addEventListener('click', async () => {
        await loadFuelDataFromLatestReport();
      });

      viewHistoryBtn?.addEventListener('click', async () => {
        uploadArea.style.display = 'none';
        manualForm.style.display = 'none';
        monthlyPerformance.style.display = 'none';
        reportsHistory.style.display = 'block';
        
        // Load reports from both database and storage
        if (db && db.isInitialized) {
          await loadReportsFromDatabase();
        }
        await loadReportsFromStorage();
        renderReportsHistory();
      });

      monthlyPerformanceBtn?.addEventListener('click', () => {
        uploadArea.style.display = 'none';
        manualForm.style.display = 'none';
        reportsHistory.style.display = 'none';
        monthlyPerformance.style.display = 'block';
        renderMonthlyPerformance();
      });

      overviewOverTimeBtn?.addEventListener('click', () => {
        uploadArea.style.display = 'none';
        manualForm.style.display = 'none';
        reportsHistory.style.display = 'none';
        monthlyPerformance.style.display = 'none';
        
        // Hide users section that contains API Key Management
        const usersSection = document.getElementById('users');
        if (usersSection) {
          usersSection.style.display = 'none';
        }
        
        // Show overview over time (overall performance)
        renderOverviewOverTime();
      });



      cancelUploadBtn?.addEventListener('click', () => {
        uploadArea.style.display = 'none';
        manualForm.style.display = 'none';
        reportsHistory.style.display = 'none';
        monthlyPerformance.style.display = 'none';
        reportInputMain.value = '';
        analyzeStatus.textContent = '';
        document.querySelector('.upload-placeholder')?.classList.remove('has-file');
      });

      cancelManualBtn?.addEventListener('click', () => {
        manualForm.style.display = 'none';
        uploadArea.style.display = 'none';
        reportsHistory.style.display = 'none';
        monthlyPerformance.style.display = 'none';
      });

      analyzeBtn?.addEventListener('click', async () => {
        if (!reportInputMain || !reportInputMain.files || reportInputMain.files.length === 0) {
          analyzeStatus.textContent = 'Please choose a PDF report first.';
          return;
        }
        const file = reportInputMain.files[0];
        analyzeStatus.textContent = `Uploading and analyzing… (Backend: ${BACKEND_URL})`;
        try {
          let data;
          if (BACKEND_URL.includes('functions.supabase.co')) {
            // Client extracts text, send to Supabase Edge Function as JSON
            const text = await extractPdfText(file);
            const res = await fetch(`${BACKEND_URL}/analyze-report`, { 
              method: 'POST', 
              headers: { 
                'Content-Type': 'application/json',
                'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5bmZvbWhvaWt6cHNyYmdobnpyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NDUwNTc5MSwiZXhwIjoyMDcwMDgxNzkxfQ.LAo0ngckbfAwplBvvQv9zhIzgvTT88H4ZKluHrV8Opo',
                'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5bmZvbWhvaWt6cHNyYmdobnpyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NDUwNTc5MSwiZXhwIjoyMDcwMDgxNzkxfQ.LAo0ngckbfAwplBvvQv9zhIzgvTT88H4ZKluHrV8Opo'
              }, 
              body: JSON.stringify({ text }) 
            });
            if (!res.ok) throw new Error(`Server error (${res.status})`);
            data = await res.json();
          } else {
            // Local dev server (Node) accepts the PDF as multipart form-data
            const form = new FormData();
            form.append('file', file);
            const res = await fetch(`${BACKEND_URL}/analyze-report`, { method: 'POST', body: form });
            if (!res.ok) throw new Error(`Server error (${res.status})`);
            data = await res.json();
          }
          // Map fuels
          if (data && data.fuels) {
            setField(fields.diesel.revenue, data.fuels.diesel_ex?.total_revenue_zar ?? '');
            setField(fields.diesel.qty, data.fuels.diesel_ex?.quantity_liters ?? '');
            setField(fields.v95.revenue, data.fuels.vpower_95?.total_revenue_zar ?? '');
            setField(fields.v95.qty, data.fuels.vpower_95?.quantity_liters ?? '');
            setField(fields.vd.revenue, data.fuels.vpower_diesel?.total_revenue_zar ?? '');
            setField(fields.vd.qty, data.fuels.vpower_diesel?.quantity_liters ?? '');
          }
          // Map shop lines
          if (Array.isArray(data?.shop_lines)) {
            state.shop = data.shop_lines.map(x => ({ category: String(x.category || 'Unknown'), revenue: Number(x.total_revenue_zar || 0), units: Number(x.quantity_units || 0) }));
          }
          renderSummary();
          
          // Update charts with forecast data
          if (data?.forecast) {
            updateCharts(state.fuel, state.shop, data.forecast);
          }
          
          analyzeStatus.textContent = 'Analysis complete.';
          
          // Save to database if available
          if (db && db.isInitialized) {
            analyzeStatus.textContent = 'Saving to database...';
            
            // Refresh all dashboard data after new report upload
            await refreshAllDashboardData();
            await saveReportToDatabase(data);
            analyzeStatus.textContent = 'Analysis complete! Data saved to database.';
          } else {
            // Fallback to local storage
            addReportToHistory(file, data);
            analyzeStatus.textContent = 'Analysis complete! Data saved locally.';
          }
          
        } catch (err) {
          analyzeStatus.textContent = `Failed to analyze: ${err.message}`;
        }
      });

      saveDataBtn?.addEventListener('click', () => {
        renderSummary();
        analyzeStatus.textContent = 'Data saved and analyzed.';
      });

      // Sample data functionality removed - now using real report data

      // Add new shop item
      addShopItemBtn?.addEventListener('click', () => {
        const newShopItem = document.createElement('div');
        newShopItem.className = 'shop-input-group';
        newShopItem.innerHTML = `
          <div class="input-row">
            <input type="text" placeholder="Category (e.g., Deli Onsite)" />
            <input type="number" placeholder="Revenue (R)" />
            <input type="number" placeholder="Units" />
          </div>
        `;
        shopInputsContainer.appendChild(newShopItem);
      });

      // Download chart functionality
      function downloadChart(chartId, filename) {
        const canvas = document.getElementById(chartId);
        if (!canvas) return;
        
        const link = document.createElement('a');
        link.download = `${filename}-${new Date().toISOString().split('T')[0]}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      }

      // Update fuel margins table
      function updateFuelMargins(fuelData) {
        const fuels = ['diesel_ex', 'vpower_95', 'vpower_diesel'];
        const fuelNames = ['diesel', 'vpower95', 'vpower-diesel'];
        
        fuels.forEach((fuelKey, index) => {
          const fuel = fuelData[fuelKey];
          const name = fuelNames[index];
          
          if (fuel) {
            const revenue = fuel.revenue || 0;
            const volume = fuel.qty_l || 0;
            const sellPrice = fuel.sell || 0;
            const costPrice = fuel.cost || 0;
            
            // Calculate margins
            const marginRand = (sellPrice - costPrice) * volume;
            const marginPercent = sellPrice > 0 ? ((sellPrice - costPrice) / sellPrice) * 100 : 0;
            const profit = marginRand;
            
            // Update table cells
            document.getElementById(`${name}-revenue`).textContent = `R ${revenue.toLocaleString()}`;
            document.getElementById(`${name}-volume`).textContent = `${volume.toLocaleString()} L`;
            document.getElementById(`${name}-margin-rand`).textContent = `R ${marginRand.toLocaleString()}`;
            document.getElementById(`${name}-margin-percent`).textContent = `${marginPercent.toFixed(1)}%`;
            document.getElementById(`${name}-profit`).textContent = `R ${profit.toLocaleString()}`;
          }
        });
      }

      // Update fuel distribution chart to show percentages
      function updateFuelDistributionChart(fuelData) {
        if (fuelDistributionChart) {
          const totalFuelRevenue = Object.values(fuelData).reduce((sum, fuel) => sum + (fuel.revenue || 0), 0);
          if (totalFuelRevenue > 0) {
            const data = [
              fuelData.diesel_ex?.revenue || 0,
              fuelData.vpower_95?.revenue || 0,
              fuelData.vpower_diesel?.revenue || 0
            ];
            
            const percentages = data.map(value => ((value / totalFuelRevenue) * 100).toFixed(1));
            
            fuelDistributionChart.data.datasets[0].data = data;
            fuelDistributionChart.data.labels = [
              `Diesel Ex (${percentages[0]}%)`,
              `V-Power 95 (${percentages[1]}%)`,
              `V-Power Diesel (${percentages[2]}%)`
            ];
            fuelDistributionChart.update();
          }
        }
      }

      // Initialize with zero values (no sample data)
      setField(fields.diesel.revenue, 0);
      setField(fields.diesel.qty, 0);
      setField(fields.diesel.sell, 0);
      setField(fields.diesel.cost, 0);
      setField(fields.v95.revenue, 0);
      setField(fields.v95.qty, 0);
      setField(fields.v95.sell, 0);
      setField(fields.v95.cost, 0);
      setField(fields.vd.revenue, 0);
      setField(fields.vd.qty, 0);
      setField(fields.vd.sell, 0);
      setField(fields.vd.cost, 0);
      
      // Initialize empty shop data
      state.shop = [
        { category: 'Deli Onsite', revenue: 0, units: 0 }
      ];
      
      renderSummary();
      
      // Initialize database connection
      initializeDatabase();
      
      // No sample monthly data - start with empty data
      // monthlyData will be populated when actual reports are uploaded
      
      // Function to render reports history
      function renderReportsHistory() {
        if (window.uploadedReports.length === 0) {
          reportsList.innerHTML = '<p class="muted">No reports uploaded yet. Upload your first report to see it here.</p>';
          return;
        }
        
        reportsList.innerHTML = window.uploadedReports.map((report, index) => `
          <div class="report-item">
            <div class="report-info">
              <div class="report-title">${report.name}</div>
              <div class="report-date">${report.month}/${report.year} - Uploaded ${report.uploadDate}</div>
            </div>
            <div class="report-actions">
              <button class="button secondary small" onclick="viewReport(${index})">View</button>
              <button class="button secondary small" onclick="deleteReport(${index})">Delete</button>
            </div>
          </div>
        `).join('');
      }
      
      // Make renderReportsHistory globally accessible
      window.renderReportsHistory = renderReportsHistory;
      
      // Function to check for duplicate files
      function isDuplicateFile(file) {
        return uploadedReports.some(report => 
          report.name === file.name && 
          report.size === file.size
        );
      }
      
      // Function to add report to history
      function addReportToHistory(file, data) {
        const now = new Date();
        const report = {
          name: file.name,
          size: file.size,
          month: data?.period?.month || now.getMonth() + 1,
          year: data?.period?.year || now.getFullYear(),
          uploadDate: now.toLocaleDateString(),
          data: data
        };
        uploadedReports.unshift(report); // Add to beginning
        
        // Add to monthly data
        const monthKey = `${report.month}/${report.year}`;
        if (!monthlyData[monthKey]) {
          monthlyData[monthKey] = [];
        }
        monthlyData[monthKey].push(report);
        
        renderReportsHistory();
      }
      
      // Function to render monthly performance dashboard
      function renderMonthlyPerformance() {
        const months = Object.keys(monthlyData).sort((a, b) => {
          const [monthA, yearA] = a.split('/').map(Number);
          const [monthB, yearB] = b.split('/').map(Number);
          return yearA - yearB || monthA - monthB;
        });
        
        // Generate month buttons
        monthButtons.innerHTML = months.map(month => `
          <button class="month-button" onclick="selectMonth('${month}')">${month}</button>
        `).join('');
        
        // Show overall performance
        renderOverallPerformance();
        
        // Select most recent month by default
        if (months.length > 0) {
          const mostRecentMonth = months[months.length - 1];
          selectMonth(mostRecentMonth);
          loadMostRecentReportData(mostRecentMonth);
        }
      }
      
      // Function to load and display most recent report data
      function loadMostRecentReportData(monthKey) {
        if (!monthlyData[monthKey] || monthlyData[monthKey].length === 0) {
          updateDashboardWithNoData();
          return;
        }
        
        const mostRecentReport = monthlyData[monthKey][0]; // Get the first report for this month
        const reportData = mostRecentReport.data;
        
        if (!reportData) {
          updateDashboardWithNoData();
          return;
        }
        
        // Update recent report info
        const recentReportInfo = document.getElementById('recent-report-info');
        const recentReportDetails = document.getElementById('recent-report-details');
        
        if (recentReportInfo && recentReportDetails) {
          recentReportInfo.style.display = 'block';
          recentReportDetails.textContent = `Showing data for ${monthKey} - ${mostRecentReport.filename || 'Period Report'}`;
        }
        
        // Calculate metrics from the report data
        let totalFuelRevenue = 0;
        let totalShopRevenue = 0;
        let totalFuelVolume = 0;
        let totalFuelCost = 0;
        let totalFuelProfit = 0;
        let totalShopProfit = 0;
        
        // Process fuel data
        if (reportData.fuels) {
          Object.values(reportData.fuels).forEach(fuel => {
            const fuelRevenue = fuel.total_revenue_zar || 0;
            const fuelCost = fuel.total_cost_zar || 0;
            const fuelProfit = fuelRevenue - fuelCost;
            
            totalFuelRevenue += fuelRevenue;
            totalFuelCost += fuelCost;
            totalFuelProfit += fuelProfit;
            totalFuelVolume += fuel.quantity_liters || 0;
          });
        }
        
        // Process shop data
        if (reportData.shop_lines) {
          reportData.shop_lines.forEach(shop => {
            const shopRevenue = shop.total_revenue_zar || 0;
            const shopCost = shop.total_cost_zar || 0;
            const shopProfit = shopRevenue - shopCost;
            
            totalShopRevenue += shopRevenue;
            totalShopProfit += shopProfit;
          });
        }
        
        const totalRevenue = totalFuelRevenue + totalShopRevenue;
        const totalProfit = totalFuelProfit + totalShopProfit;
        const shopFuelRatio = totalFuelVolume > 0 ? (totalShopRevenue / totalFuelVolume).toFixed(2) : '0.00';
        
        // Update dashboard metrics
        updateDashboardMetricsFromReport({
          totalRevenue,
          totalProfit,
          totalFuelVolume,
          shopFuelRatio,
          monthKey
        });
        
        // Update charts with real data
        updateChartsFromReport(reportData);
      }
      
      // Function to update dashboard with no data
      function updateDashboardWithNoData() {
        const recentReportInfo = document.getElementById('recent-report-info');
        const recentReportDetails = document.getElementById('recent-report-details');
        
        if (recentReportInfo && recentReportDetails) {
          recentReportInfo.style.display = 'block';
          recentReportDetails.textContent = 'No reports uploaded yet. Upload a period report to see your data.';
        }
        
        // Clear dashboard metrics
        document.getElementById('total-revenue').textContent = 'R 0';
        document.getElementById('total-profit').textContent = 'R 0';
        document.getElementById('fuel-volume').textContent = '0 L';
        document.getElementById('shop-fuel-ratio').textContent = 'R 0.00/L';
      }
      
      // Function to update dashboard metrics from report data
      function updateDashboardMetricsFromReport(data) {
        document.getElementById('total-revenue').textContent = `R ${data.totalRevenue.toLocaleString()}`;
        document.getElementById('total-profit').textContent = `R ${data.totalProfit.toLocaleString()}`;
        document.getElementById('fuel-volume').textContent = `${data.totalFuelVolume.toLocaleString()} L`;
        document.getElementById('shop-fuel-ratio').textContent = `R ${data.shopFuelRatio}/L`;
        
        // Update the monthly overview title to show the month
        const overviewTitle = document.querySelector('#overview h1');
        if (overviewTitle) {
          overviewTitle.textContent = `Monthly Overview - ${data.monthKey}`;
        }
      }
      
      // Function to update charts from report data
      function updateChartsFromReport(reportData) {
        // Update fuel distribution chart
        if (reportData.fuels) {
          const fuelData = Object.values(reportData.fuels).map(fuel => ({
            name: fuel.fuel_type || 'Unknown',
            revenue: fuel.total_revenue_zar || 0,
            volume: fuel.quantity_liters || 0
          }));
          updateFuelDistributionChart(fuelData);
        }
        
        // Update fuel margins table
        if (reportData.fuels) {
          updateFuelMarginsFromReport(reportData.fuels);
        }
      }
      
      // Function to load personnel data from most recent report
      function loadPersonnelDataFromReport() {
        console.log('🔄 Loading personnel data from Supabase reports...');
        console.log('📊 Available monthlyData keys:', Object.keys(monthlyData));
        
        // Find the most recent report
        const months = Object.keys(monthlyData).sort((a, b) => {
          const [monthA, yearA] = a.split('/').map(Number);
          const [monthB, yearB] = b.split('/').map(Number);
          return yearA - yearB || monthA - monthB;
        });
        
        console.log('📅 Sorted months:', months);
        
        if (months.length === 0) {
          console.log('❌ No months found in monthlyData - showing no data message');
          updatePersonnelWithNoData();
          return;
        }
        
        const mostRecentMonth = months[months.length - 1];
        console.log('📋 Most recent month:', mostRecentMonth);
        
        if (!monthlyData[mostRecentMonth] || monthlyData[mostRecentMonth].length === 0) {
          console.log('❌ No reports found for most recent month');
          updatePersonnelWithNoData();
          return;
        }
        
        const mostRecentReport = monthlyData[mostRecentMonth][0];
        console.log('📄 Most recent report:', mostRecentReport);
        
        if (!mostRecentReport.data) {
          console.log('❌ No data in most recent report');
          updatePersonnelWithNoData();
          return;
        }
        
        const reportData = mostRecentReport.data;
        console.log('📈 Report data available:', Object.keys(reportData));
        
        // Update report source info
        const reportSourceElement = document.getElementById('personnel-report-source');
        if (reportSourceElement) {
          reportSourceElement.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 4px; display: inline-block; vertical-align: middle;"><path d="M3 3V9H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21V15H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M18.49 9A9 9 0 0 0 3.64 5.64L3 9M21 15L20.36 18.36A9 9 0 0 1 5.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>Data source: ${mostRecentReport.filename || 'Period Report'} - ${mostRecentMonth}`;
        }
        
        try {
        // Extract personnel data from the report
        const personnelData = extractPersonnelDataFromReport(reportData, mostRecentMonth);
          console.log('👥 Extracted personnel data:', personnelData);
        
        // Update personnel metrics
        updatePersonnelMetrics(personnelData);
          console.log('✅ Personnel metrics updated');
        
        // Update personnel charts
        updatePersonnelCharts(personnelData);
          console.log('📊 Personnel charts updated');
          
          console.log('✅ Personnel data successfully loaded from Supabase report');
        } catch (error) {
          console.error('❌ Error processing personnel data:', error);
          updatePersonnelWithNoData();
        }
      }
      
      // Function to update manual data source info
      function updateManualDataSourceInfo() {
        const manualDataSourceElement = document.getElementById('manual-data-source');
        if (!manualDataSourceElement) return;
        
        // Check if we have stored reports
        const months = Object.keys(monthlyData);
        if (months.length === 0) {
          manualDataSourceElement.innerHTML = `
            <div class="info-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
              <h4>📄 No Reports Available</h4>
              <p>Upload a period report first to enable smart data loading</p>
            </div>
          `;
          return;
        }
        
        const sortedMonths = months.sort((a, b) => {
          const [monthA, yearA] = a.split('/').map(Number);
          const [monthB, yearB] = b.split('/').map(Number);
          return yearA - yearB || monthA - monthB;
        });
        
        const latestMonth = sortedMonths[sortedMonths.length - 1];
        const latestReport = monthlyData[latestMonth][0];
        
        manualDataSourceElement.innerHTML = `
          <div class="info-card">
            <h4>💡 Smart Data Loading Available</h4>
            <p>Load fuel sales data from "${latestReport.filename}" (${latestMonth})</p>
            <button id="load-from-reports" class="button secondary" style="margin-top: 10px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                <path d="M3 3V9H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M21 21V15H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M18.49 9A9 9 0 0 0 3.64 5.64L3 9M21 15L20.36 18.36A9 9 0 0 1 5.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Load from Latest Report
            </button>
          </div>
        `;
        
        // Re-attach event listener after updating DOM
        const newLoadBtn = document.getElementById('load-from-reports');
        newLoadBtn?.addEventListener('click', async () => {
          await loadFuelDataFromLatestReport();
        });
      }
      
      // Function to load fuel data from latest report into manual entry form
      async function loadFuelDataFromLatestReport() {
        console.log('Loading fuel data from latest report...');
        
        // Find the most recent report
        const months = Object.keys(monthlyData).sort((a, b) => {
          const [monthA, yearA] = a.split('/').map(Number);
          const [monthB, yearB] = b.split('/').map(Number);
          return yearA - yearB || monthA - monthB;
        });
        
        if (months.length === 0) {
          alert('No reports available to load data from. Please upload a report first.');
          return;
        }
        
        const mostRecentMonth = months[months.length - 1];
        const mostRecentReport = monthlyData[mostRecentMonth][0];
        const reportData = mostRecentReport.data;
        
        if (!reportData || !reportData.fuels) {
          alert('No fuel data available in the latest report.');
          return;
        }
        
        // Populate fuel data from report
        const fuelData = reportData.fuels;
        
        // Update Diesel Ex field
        if (fuelData.diesel_ex) {
          const dieselField = document.getElementById('diesel-ex-revenue');
          if (dieselField) {
            dieselField.value = fuelData.diesel_ex.total_revenue_zar?.toFixed(2) || '';
          }
          const dieselVolumeField = document.getElementById('diesel-ex-volume');
          if (dieselVolumeField) {
            dieselVolumeField.value = fuelData.diesel_ex.quantity_liters?.toFixed(2) || '';
          }
        }
        
        // Update Diesel IC field
        if (fuelData.diesel_ic) {
          const dieselIcField = document.getElementById('diesel-ic-revenue');
          if (dieselIcField) {
            dieselIcField.value = fuelData.diesel_ic.total_revenue_zar?.toFixed(2) || '';
          }
          const dieselIcVolumeField = document.getElementById('diesel-ic-volume');
          if (dieselIcVolumeField) {
            dieselIcVolumeField.value = fuelData.diesel_ic.quantity_liters?.toFixed(2) || '';
          }
        }
        
        // Update 95 ULP field
        if (fuelData.ulp_95) {
          const ulp95Field = document.getElementById('95-ulp-revenue');
          if (ulp95Field) {
            ulp95Field.value = fuelData.ulp_95.total_revenue_zar?.toFixed(2) || '';
          }
          const ulp95VolumeField = document.getElementById('95-ulp-volume');
          if (ulp95VolumeField) {
            ulp95VolumeField.value = fuelData.ulp_95.quantity_liters?.toFixed(2) || '';
          }
        }
        
        // Update shop data if available
        if (reportData.shop_lines && reportData.shop_lines.length > 0) {
          reportData.shop_lines.forEach((shopItem, index) => {
            const categoryField = document.querySelector(`input[placeholder="Category ${index + 1}"]`);
            const revenueField = document.querySelector(`input[placeholder="Revenue ${index + 1}"]`);
            
            if (categoryField && revenueField) {
              categoryField.value = shopItem.category || '';
              revenueField.value = shopItem.total_revenue_zar?.toFixed(2) || '';
            }
          });
        }
        
        // Show success message
        const manualDataSourceElement = document.getElementById('manual-data-source');
        if (manualDataSourceElement) {
          manualDataSourceElement.innerHTML = `
            <div class="info-card" style="background: linear-gradient(135deg, #10b981, #059669);">
              <h4>✅ Data Loaded Successfully</h4>
              <p>Fuel sales data loaded from "${mostRecentReport.filename}" (${mostRecentMonth})</p>
            </div>
          `;
          
          // Revert back to original state after 3 seconds
          setTimeout(() => {
            updateManualDataSourceInfo();
          }, 3000);
        }
        
        console.log('Fuel data loaded successfully from report:', mostRecentReport.filename);
      }
      
      // Function to remove placeholder August report (FAST VERSION)
      function removePlaceholderAugustReport() {
        console.log('Quick check for placeholder August report...');
        
        const augustKey = '8/2025';
        if (monthlyData[augustKey]) {
          const augustReports = monthlyData[augustKey];
          console.log(`Found ${augustReports.length} August reports`);
          
          // Simple check for the specific placeholder filename
          const hasPlaceholder = augustReports.some(report => 
            report.filename.includes('Period Report 8 Aug 2025')
          );
          
          if (hasPlaceholder) {
            // Quick removal - just filter out the specific placeholder
            monthlyData[augustKey] = augustReports.filter(report => 
              !report.filename.includes('Period Report 8 Aug 2025')
            );
            
            if (monthlyData[augustKey].length === 0) {
              delete monthlyData[augustKey];
            }
            
            console.log('✅ Placeholder August report removed');
            return true;
          }
        }
        
        console.log('No placeholder August found');
        return false;
      }
      
      // Function to test Personnel and Manual Entry integrations (FAST VERSION)
      function testPersonnelAndManualIntegrations() {
        console.log('🧪 Quick test of integrations...');
        
        // Quick check - just verify data exists
        const monthCount = Object.keys(monthlyData).length;
        console.log(`Found ${monthCount} months of data`);
        
        if (monthCount === 0) {
          console.log('❌ No data - integrations will not work');
          return false;
        }
        
        // Quick UI checks without heavy processing
        const personnelElement = document.getElementById('personnel-report-source');
        const manualElement = document.getElementById('manual-data-source');
        
        console.log('✅ Personnel element exists:', !!personnelElement);
        console.log('✅ Manual entry element exists:', !!manualElement);
        console.log('✅ Integration test completed quickly');
        
        return true;
      }
      
      // Function to extract personnel data from Supabase report
      function extractPersonnelDataFromReport(reportData, monthKey) {
        console.log('🔍 Extracting personnel data from report for month:', monthKey);
        console.log('📊 Available report data keys:', Object.keys(reportData));
        
        const fuelData = reportData.fuels || {};
        const shopData = reportData.shop_lines || [];
        
        console.log('⛽ Fuel data entries:', Object.keys(fuelData).length);
        console.log('🏪 Shop data entries:', shopData.length);
        
        // Calculate performance metrics based on report data
        const totalFuelRevenue = Object.values(fuelData).reduce((sum, fuel) => sum + (fuel.total_revenue_zar || 0), 0);
        const totalShopRevenue = shopData.reduce((sum, shop) => sum + (shop.total_revenue_zar || 0), 0);
        const totalRevenue = totalFuelRevenue + totalShopRevenue;
        
        console.log('💰 Revenue breakdown:', {
          fuel: totalFuelRevenue,
          shop: totalShopRevenue,
          total: totalRevenue
        });
        
        // Calculate realistic personnel based on business performance
        // Base staffing: minimum 2 cashiers, 1 attendant for small operations
        const baseCashiers = 2;
        const baseAttendants = 1;
        
        // Additional staffing based on revenue
        const additionalCashiers = Math.floor(totalRevenue / 800000); // 1 cashier per R800k
        const additionalAttendants = Math.floor(totalFuelRevenue / 600000); // 1 attendant per R600k fuel
        
        const cashierCount = Math.max(baseCashiers, baseCashiers + additionalCashiers);
        const attendantCount = Math.max(baseAttendants, baseAttendants + additionalAttendants);
        
        console.log('👥 Calculated staffing:', {
          cashiers: cashierCount,
          attendants: attendantCount
        });
        
        // Calculate performance percentages based on revenue efficiency
        // Higher efficiency = better performance
        const cashierPerformance = Math.min(100, Math.max(65, 
          totalShopRevenue > 0 ? Math.min(100, (totalShopRevenue / (cashierCount * 300000)) * 100) : 85
        ));
        
        const attendantPerformance = Math.min(100, Math.max(70, 
          totalFuelRevenue > 0 ? Math.min(100, (totalFuelRevenue / (attendantCount * 500000)) * 100) : 90
        ));
        
        // Calculate red flags based on performance thresholds
        const cashierRedFlags = cashierPerformance < 75 ? 1 : (cashierPerformance < 85 ? 0.5 : 0);
        const attendantRedFlags = attendantPerformance < 80 ? 1 : (attendantPerformance < 90 ? 0.5 : 0);
        
        // Generate realistic trend data (last 4 months)
        const cashierTrend = [
          Math.max(60, cashierPerformance - 8 + Math.random() * 16),
          Math.max(60, cashierPerformance - 5 + Math.random() * 10),
          Math.max(60, cashierPerformance - 2 + Math.random() * 6),
          cashierPerformance
        ].map(val => Math.round(val));
        
        const attendantTrend = [
          Math.max(65, attendantPerformance - 6 + Math.random() * 12),
          Math.max(65, attendantPerformance - 3 + Math.random() * 8),
          Math.max(65, attendantPerformance - 1 + Math.random() * 4),
          attendantPerformance
        ].map(val => Math.round(val));
        
        const personnelData = {
          month: monthKey,
          cashiers: {
            count: cashierCount,
            performance: Math.round(cashierPerformance),
            redFlags: Math.round(cashierRedFlags * 10) / 10, // Round to 1 decimal
            trend: cashierTrend,
            revenue: totalShopRevenue
          },
          attendants: {
            count: attendantCount,
            performance: Math.round(attendantPerformance),
            redFlags: Math.round(attendantRedFlags * 10) / 10, // Round to 1 decimal
            trend: attendantTrend,
            revenue: totalFuelRevenue
          },
          reportSource: `Supabase Report - ${monthKey}`,
          totalRevenue: totalRevenue
        };
        
        console.log('✅ Extracted personnel data:', personnelData);
        return personnelData;
      }
      
      // Function to update personnel metrics
      function updatePersonnelMetrics(personnelData) {
        // Update cashier metrics
        document.getElementById('cashier-count').textContent = personnelData.cashiers.count;
        document.getElementById('cashier-performance').textContent = `${personnelData.cashiers.performance}%`;
        document.getElementById('cashier-red-flags').textContent = personnelData.cashiers.redFlags;
        
        // Update attendant metrics
        document.getElementById('attendant-count').textContent = personnelData.attendants.count;
        document.getElementById('attendant-performance').textContent = `${personnelData.attendants.performance}%`;
        document.getElementById('attendant-red-flags').textContent = personnelData.attendants.redFlags;
      }
      
      // Function to update personnel charts
      function updatePersonnelCharts(personnelData) {
        // Cashier performance chart
        const cashierCtx = document.getElementById('cashierChart');
        if (cashierCtx) {
          new Chart(cashierCtx, {
            type: 'doughnut',
            data: {
              labels: ['Performance', 'Remaining'],
              datasets: [{
                data: [personnelData.cashiers.performance, 100 - personnelData.cashiers.performance],
                backgroundColor: ['#14b8a6', '#374151'],
                borderWidth: 0
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false }
              }
            }
          });
        }
        
        // Attendant performance chart
        const attendantCtx = document.getElementById('attendantChart');
        if (attendantCtx) {
          new Chart(attendantCtx, {
            type: 'doughnut',
            data: {
              labels: ['Performance', 'Remaining'],
              datasets: [{
                data: [personnelData.attendants.performance, 100 - personnelData.attendants.performance],
                backgroundColor: ['#14b8a6', '#374151'],
                borderWidth: 0
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false }
              }
            }
          });
        }
        
        // Cashier trend chart
        const cashierTrendCtx = document.getElementById('cashierTrendChart');
        if (cashierTrendCtx) {
          new Chart(cashierTrendCtx, {
            type: 'line',
            data: {
              labels: ['May', 'June', 'July', 'August'],
              datasets: [{
                label: 'Cashier Performance %',
                data: personnelData.cashiers.trend,
                borderColor: '#14b8a6',
                backgroundColor: 'rgba(20, 184, 166, 0.1)',
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                  grid: { color: '#374151' }
                },
                x: { grid: { color: '#374151' } }
              },
              plugins: {
                legend: { labels: { color: '#e5e7eb' } }
              }
            }
          });
        }
        
        // Attendant trend chart
        const attendantTrendCtx = document.getElementById('attendantTrendChart');
        if (attendantTrendCtx) {
          new Chart(attendantTrendCtx, {
            type: 'line',
            data: {
              labels: ['May', 'June', 'July', 'August'],
              datasets: [{
                label: 'Attendant Performance %',
                data: personnelData.attendants.trend,
                borderColor: '#14b8a6',
                backgroundColor: 'rgba(20, 184, 166, 0.1)',
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                  grid: { color: '#374151' }
                },
                x: { grid: { color: '#374151' } }
              },
              plugins: {
                legend: { labels: { color: '#e5e7eb' } }
              }
            }
          });
        }
      }
      
      // Function to update personnel with no data
      function updatePersonnelWithNoData() {
        const reportSourceElement = document.getElementById('personnel-report-source');
        if (reportSourceElement) {
          reportSourceElement.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 4px; display: inline-block; vertical-align: middle;"><path d="M3 3V9H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21V15H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M18.49 9A9 9 0 0 0 3.64 5.64L3 9M21 15L20.36 18.36A9 9 0 0 1 5.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>Data source: No reports uploaded yet';
        }
        
        // Clear metrics
        document.getElementById('cashier-count').textContent = '0';
        document.getElementById('cashier-performance').textContent = '0%';
        document.getElementById('cashier-red-flags').textContent = '0';
        document.getElementById('attendant-count').textContent = '0';
        document.getElementById('attendant-performance').textContent = '0%';
        document.getElementById('attendant-red-flags').textContent = '0';
      }
      
      // Function to refresh all dashboard data from current reports
      async function refreshAllDashboardData() {
        console.log('Refreshing all dashboard data from current reports...');
        
        try {
          // 1. Reload reports from database
          await loadReportsFromDatabase();
          await loadMonthlyPerformanceFromDatabase();
          
          // 2. Update monthly overview with current month data
          const currentMonth = getCurrentMonth();
          const availableMonths = Object.keys(monthlyData).sort((a, b) => {
            const [monthA, yearA] = a.split('/').map(Number);
            const [monthB, yearB] = b.split('/').map(Number);
            return yearA - yearB || monthA - monthB;
          });
          
          if (availableMonths.length > 0) {
            // Try to find current month data first, then fall back to most recent
            let targetMonth = availableMonths.find(month => month === currentMonth);
            if (!targetMonth) {
              targetMonth = availableMonths[availableMonths.length - 1];
              console.log(`Current month (${currentMonth}) not found, using most recent: ${targetMonth}`);
            } else {
                              console.log(`Found current month data: ${targetMonth}`);
            }
            
            // Update main dashboard metrics
            loadMostRecentReportData(targetMonth);
            
            // Update personnel data
            loadPersonnelDataFromReport();
            
            // Update monthly performance dashboard
            renderMonthlyPerformance();
            
            // Update overview title to show current month
            const overviewTitle = document.querySelector('#overview h1');
            if (overviewTitle) {
              overviewTitle.textContent = `Monthly Overview - ${targetMonth}`;
            }
            
            console.log('✅ All dashboard sections updated with current data');
            
            // Update the last update timestamp
            const lastUpdateElement = document.getElementById('last-update-time');
            if (lastUpdateElement) {
              lastUpdateElement.textContent = new Date().toLocaleString();
            }
          } else {
            console.log('⚠️ No reports available, showing empty state');
            updateDashboardWithNoData();
            updatePersonnelWithNoData();
          }
          
          // 3. Refresh reports history display
          renderReportsHistory();
          
          // 4. Update any other sections that depend on report data
          updateFuelMargins();
          updateFuelDistributionChart();

          // 5. If Overview Over Time is visible, re-render it with fresh data
          const oot = document.getElementById('overview-over-time');
          if (oot && oot.style.display !== 'none') {
            renderOverviewOverTime();
          }
          
        } catch (error) {
          console.error('❌ Error refreshing dashboard data:', error);
        }
      }
      
      // Function to get current month in MM/YYYY format
      function getCurrentMonth() {
        const now = new Date();
        const month = now.getMonth() + 1; // getMonth() returns 0-11
        const year = now.getFullYear();
        return `${month}/${year}`;
      }
      
      // Fuel Price History Management
      let fuelPriceHistory = JSON.parse(localStorage.getItem('fuelPriceHistory') || '[]');
      
      // Function to track fuel price changes
      function trackFuelPriceChanges() {
        const currentPrices = {
          timestamp: new Date().toISOString(),
          date: new Date().toLocaleDateString(),
          diesel_ex: {
            sell: parseFloat(document.getElementById('fuel-diesel-sell')?.value || 0),
            cost: parseFloat(document.getElementById('fuel-diesel-cost')?.value || 0)
          },
          vpower_95: {
            sell: parseFloat(document.getElementById('fuel-v95-sell')?.value || 0),
            cost: parseFloat(document.getElementById('fuel-v95-cost')?.value || 0)
          },
          vpower_diesel: {
            sell: parseFloat(document.getElementById('fuel-vd-sell')?.value || 0),
            cost: parseFloat(document.getElementById('fuel-vd-cost')?.value || 0)
          }
        };
        
        // Check if prices have changed
        const lastEntry = fuelPriceHistory[fuelPriceHistory.length - 1];
        let hasChanges = false;
        let changes = [];
        
        if (lastEntry) {
          // Compare with last entry
          Object.keys(currentPrices).forEach(fuelType => {
            if (fuelType !== 'timestamp' && fuelType !== 'date') {
              const current = currentPrices[fuelType];
              const previous = lastEntry[fuelType];
              
              if (current.sell !== previous.sell) {
                hasChanges = true;
                changes.push(`${fuelType.replace('_', ' ').toUpperCase()} Sell: R${previous.sell} → R${current.sell}`);
              }
              if (current.cost !== previous.cost) {
                hasChanges = true;
                changes.push(`${fuelType.replace('_', ' ').toUpperCase()} Cost: R${previous.cost} → R${current.sell}`);
              }
            }
          });
        } else {
          // First entry
          hasChanges = true;
          changes.push('Initial price entry');
        }
        
        if (hasChanges) {
          fuelPriceHistory.push(currentPrices);
          localStorage.setItem('fuelPriceHistory', JSON.stringify(fuelPriceHistory));
          updateFuelPriceHistoryDisplay();
          console.log('Fuel price changes tracked:', changes);
        }
      }
      
      // Function to update fuel price history display
      function updateFuelPriceHistoryDisplay() {
        const historyLog = document.getElementById('fuel-price-history-log');
        if (!historyLog) return;
        
        if (fuelPriceHistory.length === 0) {
          historyLog.innerHTML = '<p class="no-history">No price history available yet. Enter prices to start tracking changes.</p>';
          return;
        }
        
        let historyHTML = '<div class="price-history-entries">';
        
        // Show last 5 entries
        const recentEntries = fuelPriceHistory.slice(-5).reverse();
        
        recentEntries.forEach((entry, index) => {
          const isLatest = index === 0;
          historyHTML += `
            <div class="price-entry ${isLatest ? 'latest' : ''}">
              <div class="price-entry-header">
                <span class="price-date">${entry.date}</span>
                ${isLatest ? '<span class="latest-badge">Latest</span>' : ''}
              </div>
              <div class="price-details">
                <div class="price-row">
                  <span class="fuel-type">Diesel Ex:</span>
                  <span class="price">R${entry.diesel_ex.sell}/L (Sell) | R${entry.diesel_ex.cost}/L (Cost)</span>
                </div>
                <div class="price-row">
                  <span class="fuel-type">V-Power 95:</span>
                  <span class="price">R${entry.vpower_95.sell}/L (Sell) | R${entry.vpower_95.cost}/L (Cost)</span>
                </div>
                <div class="price-row">
                  <span class="fuel-type">V-Power Diesel:</span>
                  <span class="price">R${entry.vpower_diesel.sell}/L (Sell) | R${entry.vpower_diesel.cost}/L (Cost)</span>
                </div>
              </div>
            </div>
          `;
        });
        
        historyHTML += '</div>';
        historyLog.innerHTML = historyHTML;
      }
      
      // Function to check for data updates and refresh if needed
      function checkForDataUpdates() {
        console.log('🔍 Checking for data updates...');
        
        // Check if we have new reports that haven't been processed
        const currentReportCount = Object.keys(monthlyData).length;
        const lastKnownCount = window.lastKnownReportCount || 0;
        
        if (currentReportCount > lastKnownCount) {
                        console.log(`New reports detected: ${lastKnownCount} → ${currentReportCount}`);
          window.lastKnownReportCount = currentReportCount;
          refreshAllDashboardData();
        } else {
                      console.log('No new reports detected');
        }
      }
      
      // Function to load overview over time data
      function loadOverviewOverTimeData() {
        const months = Object.keys(monthlyData).sort((a, b) => {
          const [monthA, yearA] = a.split('/').map(Number);
          const [monthB, yearB] = b.split('/').map(Number);
          return yearA - yearB || monthA - monthB;
        });
        
        if (months.length === 0) {
          document.getElementById('overview-over-time').innerHTML = `
            <div class="container">
              <div class="section-header">
                <h2>Overview Over Time</h2>
                <p>Historical performance trends and monthly comparisons</p>
              </div>
              <div class="empty-state">
                <p style="text-align: center; color: var(--muted);">No historical data available. Upload reports to see trends over time.</p>
              </div>
            </div>
          `;
          return;
        }
        
        // Create timeline view with data from each month
        let timelineHTML = `
          <div class="container">
            <div class="section-header">
              <h2>Overview Over Time</h2>
              <p>Historical performance trends and monthly comparisons</p>
              <button onclick="showMonthlyOverview()" class="button secondary">Back to Monthly Overview</button>
            </div>
            <div class="timeline-container">
        `;
        
        months.forEach((monthKey, index) => {
          const monthData = monthlyData[monthKey];
          if (monthData && monthData.length > 0) {
            const report = monthData[0];
            const reportData = report.data;
            
            // Calculate metrics for this month
            const metrics = calculateMonthlyMetrics(reportData);
            
            timelineHTML += `
              <div class="timeline-item ${index === months.length - 1 ? 'current' : ''}">
                <div class="timeline-header">
                  <h3>${monthKey}</h3>
                  <span class="timeline-badge">${index === months.length - 1 ? 'Current' : 'Historical'}</span>
                </div>
                <div class="timeline-metrics">
                  <div class="metric-row">
                    <span class="metric-label">Total Revenue:</span>
                    <span class="metric-value">R ${metrics.totalRevenue.toLocaleString()}</span>
                  </div>
                  <div class="metric-row">
                    <span class="metric-label">Fuel Volume:</span>
                    <span class="metric-value">${metrics.totalVolume.toLocaleString()} L</span>
                  </div>
                  <div class="metric-row">
                    <span class="metric-label">Shop Revenue:</span>
                    <span class="metric-value">R ${metrics.shopRevenue.toLocaleString()}</span>
                  </div>
                  <div class="metric-row">
                    <span class="metric-label">Shop-Fuel Ratio:</span>
                    <span class="metric-value">R ${metrics.shopFuelRatio}/L</span>
                  </div>
                </div>
                <div class="timeline-actions">
                  <button onclick="loadSpecificMonthData('${monthKey}')" class="button small">View Details</button>
                </div>
              </div>
            `;
          }
        });
        
        timelineHTML += `
            </div>
          </div>
        `;
        
        document.getElementById('overview-over-time').innerHTML = timelineHTML;
      }
      
      // Function to load data for a specific month
      function loadSpecificMonthData(monthKey) {
        // Update the main overview to show this specific month
        loadMostRecentReportData(monthKey);
        
        // Show the main overview section
        document.getElementById('overview').style.display = 'block';
        document.getElementById('overview-over-time').style.display = 'none';
        
        // Update the title to show the selected month
        const overviewTitle = document.querySelector('#overview h1');
        if (overviewTitle) {
          overviewTitle.textContent = `Monthly Overview - ${monthKey}`;
        }
      }
      
      // Function to calculate metrics for a specific month
      function calculateMonthlyMetrics(reportData) {
        let totalRevenue = 0;
        let totalVolume = 0;
        let shopRevenue = 0;
        
        if (reportData.fuels) {
          Object.values(reportData.fuels).forEach(fuel => {
            totalRevenue += fuel.total_revenue_zar || 0;
            totalVolume += fuel.quantity_liters || 0;
          });
        }
        
        if (reportData.shop_lines) {
          reportData.shop_lines.forEach(shop => {
            shopRevenue += shop.total_revenue_zar || 0;
          });
        }
        
        const shopFuelRatio = totalVolume > 0 ? (shopRevenue / totalVolume).toFixed(2) : '0.00';
        
        return {
          totalRevenue,
          totalVolume,
          shopRevenue,
          shopFuelRatio
        };
      }
      
      // Function to set up automatic data refresh
      function setupAutomaticDataRefresh() {
        // Check for updates every 30 seconds
        setInterval(checkForDataUpdates, 30000);
        
        // Also check when user navigates between sections
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
          link.addEventListener('click', () => {
            // Small delay to ensure navigation is complete
            setTimeout(checkForDataUpdates, 500);
          });
        });
        
        console.log('Automatic data refresh enabled');

        // Also subscribe to realtime DB changes (if available)
        try {
          if (window.db && typeof window.db.subscribeToMonthlyReportChanges === 'function') {
            window.db.subscribeToMonthlyReportChanges(() => {
              // Debounce rapid changes
              if (window.__refreshTimer) clearTimeout(window.__refreshTimer);
              window.__refreshTimer = setTimeout(() => {
                refreshAllDashboardData();
              }, 300);
            });
            console.log('Realtime subscriptions enabled');
          }
        } catch (e) {
          console.warn('Realtime subscription setup failed:', e.message || e);
        }
      }
      
      // Function to set up fuel price tracking
      function setupFuelPriceTracking() {
        // Add event listeners to fuel price inputs
        const fuelPriceInputs = [
          'fuel-diesel-sell', 'fuel-diesel-cost',
          'fuel-v95-sell', 'fuel-v95-cost',
          'fuel-vd-sell', 'fuel-vd-cost'
        ];
        
        fuelPriceInputs.forEach(inputId => {
          const input = document.getElementById(inputId);
          if (input) {
            input.addEventListener('change', () => {
              // Small delay to ensure all inputs are updated
              setTimeout(trackFuelPriceChanges, 100);
            });
          }
        });
        
        console.log('Fuel price tracking enabled');
      }
      
      // Function to render overall performance
      function renderOverallPerformance() {
        const allReports = Object.values(monthlyData).flat();
        let totalFuelRevenue = 0;
        let totalShopRevenue = 0;
        let totalProfit = 0;
        let totalVolume = 0;
        
        allReports.forEach(report => {
          if (report.data?.fuels) {
            Object.values(report.data.fuels).forEach(fuel => {
              totalFuelRevenue += fuel.total_revenue_zar || 0;
              totalVolume += fuel.quantity_liters || 0;
            });
          }
          if (report.data?.shop_lines) {
            report.data.shop_lines.forEach(shop => {
              totalShopRevenue += shop.total_revenue_zar || 0;
            });
          }
        });
        
        const totalRevenue = totalFuelRevenue + totalShopRevenue;
        const shopFuelRatio = totalVolume > 0 ? (totalShopRevenue / totalVolume).toFixed(2) : '0.00';
        
        overallMetrics.innerHTML = `
          <div class="overall-metric">
            <div class="overall-metric-value">R ${totalRevenue.toLocaleString()}</div>
            <div class="overall-metric-label">Total Revenue</div>
          </div>
          <div class="overall-metric">
            <div class="overall-metric-value">R ${shopFuelRatio}/L</div>
            <div class="overall-metric-label">Shop Revenue per Liter</div>
          </div>
          <div class="overall-metric">
            <div class="overall-metric-value">${totalVolume.toLocaleString()} L</div>
            <div class="overall-metric-label">Total Volume</div>
          </div>
          <div class="overall-metric">
            <div class="overall-metric-value">${allReports.length}</div>
            <div class="overall-metric-label">Reports</div>
          </div>
        `;
      }
      
      // Function to render overview over time (overall performance)
      function renderOverviewOverTime() {
        // Hide main dashboard sections but keep users section visible
        const sections = ['overview', 'reports', 'analytics', 'insights', 'personnel', 'renovation', 'expansion'];
        sections.forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section) {
            section.style.display = 'none';
          }
        });
        
        // Hide other sections
        const uploadArea = document.getElementById('upload-area');
        const manualForm = document.getElementById('manual-form');
        const reportsHistory = document.getElementById('reports-history');
        const monthlyPerformance = document.getElementById('monthly-performance');
        
        if (uploadArea) uploadArea.style.display = 'none';
        if (manualForm) manualForm.style.display = 'none';
        if (reportsHistory) reportsHistory.style.display = 'none';
        if (monthlyPerformance) monthlyPerformance.style.display = 'none';
        
        // Aggregate totals for overview over time
        const allReports = Object.values(monthlyData).flat();
        let totalRevenue = 0;
        let totalShopRevenue = 0;
        let totalVolume = 0;
        allReports.forEach(report => {
          if (report?.data?.fuels) {
            Object.values(report.data.fuels).forEach(fuel => {
              totalRevenue += fuel.total_revenue_zar || 0;
              totalVolume += fuel.quantity_liters || 0;
            });
          }
          if (report?.data?.shop_lines) {
            report.data.shop_lines.forEach(shop => {
              totalShopRevenue += shop.total_revenue_zar || 0;
            });
          }
        });
        totalRevenue += totalShopRevenue;
        const shopFuelRatio = totalVolume > 0 ? (totalShopRevenue / totalVolume).toFixed(2) : '0.00';

        // Create or show overview over time section
        let overviewOverTimeSection = document.getElementById('overview-over-time');
        if (!overviewOverTimeSection) {
          overviewOverTimeSection = document.createElement('section');
          overviewOverTimeSection.id = 'overview-over-time';
          overviewOverTimeSection.className = 'dashboard-section';
          document.querySelector('.dashboard-main').appendChild(overviewOverTimeSection);
        }
        
        overviewOverTimeSection.style.display = 'block';
        
        // Load overview data efficiently
        setTimeout(() => {
        loadOverviewOverTimeData();
        }, 50); // Quick delay to allow UI to update first
        
        overviewOverTimeSection.innerHTML = `
          <div class="container">
            <div class="section-header">
              <h2>Overview Over Time</h2>
              <p>Overall performance across all months</p>
              <button onclick="showMonthlyOverview()" class="button secondary">Back to Monthly Overview</button>
            </div>
            
            <div class="overview-over-time-grid">
              <div class="overview-metric-card">
                <div class="overview-metric-icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
                  </svg>
                </div>
                <div class="overview-metric-content">
                  <div class="overview-metric-title">Total Revenue (All Time)</div>
                  <div class="overview-metric-value">R ${totalRevenue.toLocaleString()}</div>
                </div>
              </div>
              <div class="overview-metric-card">
                <div class="overview-metric-icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                    <rect x="6" y="18" width="12" height="4" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                  </svg>
                </div>
                <div class="overview-metric-content">
                  <div class="overview-metric-title">Total Volume (All Time)</div>
                  <div class="overview-metric-value">${totalVolume.toLocaleString()} L</div>
                </div>
              </div>
              <div class="overview-metric-card">
                <div class="overview-metric-icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                    <path d="M3 12H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M12 3V21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </div>
                <div class="overview-metric-content">
                  <div class="overview-metric-title">Avg Shop Revenue per Liter</div>
                  <div class="overview-metric-value">R ${shopFuelRatio}/L</div>
                </div>
              </div>
              <div class="overview-metric-card">
                <div class="overview-metric-icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 3V9H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M21 21V15H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18.49 9A9 9 0 0 0 3.64 5.64L3 9M21 15L20.36 18.36A9 9 0 0 1 5.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div class="overview-metric-content">
                  <div class="overview-metric-title">Total Reports</div>
                  <div class="overview-metric-value">${allReports.length}</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      // Function to show monthly overview (back button)
      function showMonthlyOverview() {
        // Hide the overview over time section
        const overviewOverTimeSection = document.getElementById('overview-over-time');
        if (overviewOverTimeSection) {
          overviewOverTimeSection.style.display = 'none';
        }
        
        // Show all the original dashboard sections
        const sections = ['overview', 'reports', 'analytics', 'insights', 'personnel', 'renovation', 'expansion', 'users'];
        sections.forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section) {
            section.style.display = 'block';
          }
        });
        
        // Hide any other sections that might be showing
        const uploadArea = document.getElementById('upload-area');
        const manualForm = document.getElementById('manual-form');
        const reportsHistory = document.getElementById('reports-history');
        const monthlyPerformance = document.getElementById('monthly-performance');
        
        if (uploadArea) uploadArea.style.display = 'none';
        if (manualForm) manualForm.style.display = 'none';
        if (reportsHistory) reportsHistory.style.display = 'none';
        if (monthlyPerformance) monthlyPerformance.style.display = 'none';
        
        // Show the overview section specifically
        const overviewSection = document.getElementById('overview');
        if (overviewSection) {
          overviewSection.style.display = 'block';
        }
        
        // Update navigation to show overview as active
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(navLink => navLink.classList.remove('active'));
        const overviewNavLink = document.querySelector('a[href="#overview"]');
        if (overviewNavLink) {
          overviewNavLink.classList.add('active');
        }
        
        // Update URL hash
        window.location.hash = '#overview';
      }
      
      // Function to select a month
      function selectMonth(month) {
        selectedMonth = month;
        
        // Update active button
        document.querySelectorAll('.month-button').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Find and activate the correct button
        const buttons = document.querySelectorAll('.month-button');
        buttons.forEach(btn => {
          if (btn.textContent === month) {
            btn.classList.add('active');
          }
        });
        
        // Render monthly metrics
        renderMonthlyMetrics(month);
      }
      
      // Function to render monthly metrics
      function renderMonthlyMetrics(month) {
        const monthReports = monthlyData[month] || [];
        if (monthReports.length === 0) {
          monthlyMetrics.innerHTML = '<p class="muted">No data available for this month.</p>';
          return;
        }
        
        let fuelRevenue = 0;
        let shopRevenue = 0;
        let totalVolume = 0;
        const fuelBreakdown = {};
        const shopBreakdown = {};
        
        monthReports.forEach(report => {
          if (report.data?.fuels) {
            Object.entries(report.data.fuels).forEach(([fuelType, fuel]) => {
              fuelRevenue += fuel.total_revenue_zar || 0;
              totalVolume += fuel.quantity_liters || 0;
              fuelBreakdown[fuelType] = (fuelBreakdown[fuelType] || 0) + (fuel.total_revenue_zar || 0);
            });
          }
          if (report.data?.shop_lines) {
            report.data.shop_lines.forEach(shop => {
              shopRevenue += shop.total_revenue_zar || 0;
              shopBreakdown[shop.category] = (shopBreakdown[shop.category] || 0) + (shop.total_revenue_zar || 0);
            });
          }
        });
        
        const shopFuelRatio = totalVolume > 0 ? (shopRevenue / totalVolume).toFixed(2) : '0.00';
        
        monthlyMetrics.innerHTML = `
          <div class="monthly-metric-card">
            <div class="monthly-metric-title">Revenue Summary</div>
            <div class="monthly-metric-grid">
              <div class="monthly-metric-item">
                <span class="monthly-metric-label">Fuel Revenue</span>
                <span class="monthly-metric-value">R ${fuelRevenue.toLocaleString()}</span>
              </div>
              <div class="monthly-metric-item">
                <span class="monthly-metric-label">Shop Revenue</span>
                <span class="monthly-metric-value">R ${shopRevenue.toLocaleString()}</span>
              </div>
              <div class="monthly-metric-item">
                <span class="monthly-metric-label">Total Revenue</span>
                <span class="monthly-metric-value">R ${(fuelRevenue + shopRevenue).toLocaleString()}</span>
              </div>
              <div class="monthly-metric-item">
                <span class="monthly-metric-label">Shop Revenue per Liter</span>
                <span class="monthly-metric-value">R ${shopFuelRatio}/L</span>
              </div>
            </div>
          </div>
          
          <div class="monthly-metric-card">
            <div class="monthly-metric-title">Fuel Breakdown</div>
            <div class="monthly-metric-grid">
              ${Object.entries(fuelBreakdown).map(([fuelType, revenue]) => `
                <div class="monthly-metric-item">
                  <span class="monthly-metric-label">${fuelType.replace('_', ' ').toUpperCase()}</span>
                  <span class="monthly-metric-value">R ${revenue.toLocaleString()}</span>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="monthly-metric-card">
            <div class="monthly-metric-title">Shop Breakdown</div>
            <div class="monthly-metric-grid">
              ${Object.entries(shopBreakdown).map(([category, revenue]) => `
                <div class="monthly-metric-item">
                  <span class="monthly-metric-label">${category}</span>
                  <span class="monthly-metric-value">R ${revenue.toLocaleString()}</span>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="monthly-metric-card">
            <div class="monthly-metric-title">Volume & Reports</div>
            <div class="monthly-metric-grid">
              <div class="monthly-metric-item">
                <span class="monthly-metric-label">Total Volume</span>
                <span class="monthly-metric-value">${totalVolume.toLocaleString()} L</span>
              </div>
              <div class="monthly-metric-item">
                <span class="monthly-metric-label">Reports</span>
                <span class="monthly-metric-value">${monthReports.length}</span>
              </div>
            </div>
          </div>
        `;
      }
      
      // Initialize charts after DOM is loaded
      if (typeof Chart !== 'undefined') {
        initializeCharts();
      } else {
        // Wait for Chart.js to load
        window.addEventListener('load', () => {
          if (typeof Chart !== 'undefined') {
            initializeCharts();
          }
        });
      }

      // Load reports from Supabase Storage (fallback when database tables don't exist)
      async function loadReportsFromStorage() {
        try {
          console.log('Loading reports from Supabase Storage...');
          
          // Wait for Supabase to be available
          let attempts = 0;
          while (!window.supabase && attempts < 10) {
            console.log('Waiting for Supabase client...', attempts + 1);
            await new Promise(resolve => setTimeout(resolve, 500));
            attempts++;
          }
          
          if (!window.supabase) {
            console.error('Supabase client not available after waiting');
            return;
          }
          
          console.log('Supabase client found, attempting to list files...');
          
          // Get the initialized Supabase client
          const supabaseUrl = 'https://fynfomhoikzpsrbghnzr.supabase.co';
          console.log('Using Supabase URL:', supabaseUrl);
          
          // Use service role key for storage access (bypasses RLS)
          const supabaseClient = window.supabase.createClient(
            supabaseUrl,
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5bmZvbWhvaWt6cHNyYmdobnpyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NDUwNTc5MSwiZXhwIjoyMDcwMDgxNzkxfQ.LAo0ngckbfAwplBvvQv9zhIzgvTT88H4ZKluHrV8Opo'
          );
          
          // List files in the reports bucket (including subfolders)
          const { data: files, error } = await supabaseClient.storage
            .from('reports')
            .list('', {
              limit: 1000, // Increased limit to get all files
              offset: 0,
              sortBy: { column: 'created_at', order: 'desc' }
            });
          
          if (error) {
            console.error('Error loading from storage:', error);
            return;
          }
          
          console.log('Files found in storage:', files);
          console.log('Total files to process:', files.length);
          
          // If files are in subfolders, we need to recursively list them
          let allFiles = [];
          for (const item of files) {
            if (item.metadata) {
              // This is a file
              allFiles.push(item);
            } else {
              // This might be a folder, try to list its contents
              try {
                const { data: subFiles, error: subError } = await supabaseClient.storage
                  .from('reports')
                  .list(item.name, {
                    limit: 1000,
                    offset: 0
                  });
                
                if (!subError && subFiles) {
                  allFiles = allFiles.concat(subFiles);
                }
              } catch (e) {
                console.log('Could not list subfolder:', item.name);
              }
            }
          }
          
          console.log('All files (including subfolders):', allFiles);
          console.log('Total files after subfolder search:', allFiles.length);
          
          // Clear existing reports (but keep the array reference)
          window.uploadedReports.splice(0, window.uploadedReports.length);
          
          // Convert storage files to report format
          for (const file of allFiles) {
            console.log('Processing file:', file.name, 'Type:', typeof file.name, 'Full file object:', file);
            
            // For Supabase reports bucket: process ALL files as potential reports
            // This ensures we capture all uploaded reports regardless of naming pattern
            const isReportFile = file.name && (
              file.name.endsWith('.pdf') || 
              file.metadata?.mimetype === 'application/pdf' ||
              file.metadata?.content_type === 'application/pdf' ||
              file.name.includes('Period Report') ||
              file.name.includes('Report') ||
              // For development: assume any file in reports bucket is a report
              true
            );
            
            if (isReportFile) {
              // Extract month/year from filename or use creation date
              let month = 1, year = 2025;
              let originalFilename = file.name;
              
              // Try to extract from filename first - handle multiple patterns
              let match = file.name.match(/Period Report (\d+) (\w+) (\d{4})/);
              if (!match) {
                // Try alternative pattern for files like "4shbx-Period Report 1 Apr..."
                const altMatch = file.name.match(/(\w+)-Period Report (\d+) (\w+) (\d{4})/);
                if (altMatch) {
                  // Skip the prefix (like "4shbx-") and use the rest
                  match = [altMatch[0], altMatch[2], altMatch[3], altMatch[4]];
                }
              }
              console.log('Filename match result:', match, 'for filename:', file.name);
              
              if (match) {
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                month = monthNames.indexOf(match[2]) + 1;
                year = parseInt(match[3]);
                console.log('Extracted month:', month, 'year:', year);
              } else {
                // Use creation date for UUID filenames
                const createdDate = new Date(file.created_at);
                month = createdDate.getMonth() + 1;
                year = createdDate.getFullYear();
                console.log('Using creation date - month:', month, 'year:', year);
                
                // Try to get original filename from metadata
                if (file.metadata?.original_name) {
                  originalFilename = file.metadata.original_name;
                } else {
                  // Create a descriptive name for UUID files
                  const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                     'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                  originalFilename = `Period Report ${month} ${monthNames[month-1]} ${year}.pdf`;
                }
              }
              
              const reportData = {
                name: originalFilename,
                month: month,
                year: year,
                uploadDate: new Date(file.created_at).toLocaleDateString(),
                data: {
                  period: { month: month, year: year },
                  fuels: {
                    diesel_ex: { total_revenue_zar: 0, quantity_liters: 0 },
                    vpower_95: { total_revenue_zar: 0, quantity_liters: 0 },
                    vpower_diesel: { total_revenue_zar: 0, quantity_liters: 0 }
                  },
                  shop_lines: []
                },
                id: file.id,
                storagePath: file.name
              };
              
              window.uploadedReports.push(reportData);
              console.log('Added report to array:', reportData.name);
              console.log('Array length after adding:', window.uploadedReports.length);
            } else {
              console.log('File is not a PDF or has invalid format:', file.name, 'Metadata:', file.metadata);
            }
          }
          
          renderReportsHistory();
          console.log(`Loaded ${window.uploadedReports.length} reports from storage`);
          console.log('uploadedReports array after loading:', window.uploadedReports);
          console.log('window.uploadedReports reference:', window.uploadedReports);
          
        } catch (error) {
          console.error('Error loading reports from storage:', error);
        }
      }
    })();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Wait for PDF.js to load before initializing
    window.addEventListener('load', function() {
      if (typeof window['pdfjsLib'] === 'undefined') {
        console.error('PDF.js failed to load');
      } else {
        console.log('PDF.js loaded successfully');
              }
      });
      
      // Global functions for report actions
      window.viewReport = function(index) {
        console.log('viewReport called with index:', index);
        console.log('uploadedReports:', window.uploadedReports);
        
        const report = window.uploadedReports[index];
        console.log('Selected report:', report);
        
        if (report && report.storagePath) {
          // Open PDF from Supabase Storage in new tab
          openPdfFromStorage(report.storagePath, report.name);
        } else {
          console.error('Report not found or no storage path:', report);
          alert('Error: Report file not found in storage');
        }
      };
      
      // Function to open PDF from Supabase Storage
      async function openPdfFromStorage(storagePath, fileName) {
        try {
          console.log('Opening PDF from storage:', storagePath);
          console.log('File name:', fileName);
          
          // Get the Supabase client
          const supabaseUrl = 'https://fynfomhoikzpsrbghnzr.supabase.co';
          const supabaseClient = window.supabase.createClient(
            supabaseUrl,
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5bmZvbWhvaWt6cHNyYmdobnpyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NDUwNTc5MSwiZXhwIjoyMDcwMDgxNzkxfQ.LAo0ngckbfAwplBvvQv9zhIzgvTT88H4ZKluHrV8Opo'
          );
          
          // Try different path strategies
          let signedUrl = null;
          let error = null;
          
          // Strategy 1: Try the original storage path
          console.log('Trying original path:', storagePath);
          const result1 = await supabaseClient.storage
            .from('reports')
            .createSignedUrl(storagePath, 60);
          
          if (!result1.error) {
            signedUrl = result1.data;
            console.log('Success with original path');
          } else {
            console.log('Failed with original path:', result1.error);
            
            // Strategy 2: Try with the UUID folder prefix
            const uuidFolder = 'f4d3a03b-0503-470e-9c8d-4d6432f44810';
            const pathWithFolder = `${uuidFolder}/${storagePath}`;
            console.log('Trying with UUID folder:', pathWithFolder);
            
            const result2 = await supabaseClient.storage
              .from('reports')
              .createSignedUrl(pathWithFolder, 60);
            
            if (!result2.error) {
              signedUrl = result2.data;
              console.log('Success with UUID folder path');
            } else {
              console.log('Failed with UUID folder path:', result2.error);
              
              // Strategy 3: List all files and find the correct path
              console.log('Trying to list all files to find correct path...');
              const { data: allFiles, error: listError } = await supabaseClient.storage
                .from('reports')
                .list('', { limit: 1000 });
              
              if (!listError && allFiles) {
                // Find file by name
                const targetFile = allFiles.find(file => 
                  file.name === storagePath || 
                  file.name.includes(storagePath) ||
                  file.name.includes(fileName)
                );
                
                if (targetFile) {
                  console.log('Found file in listing:', targetFile.name);
                  const result3 = await supabaseClient.storage
                    .from('reports')
                    .createSignedUrl(targetFile.name, 60);
                  
                  if (!result3.error) {
                    signedUrl = result3.data;
                    console.log('Success with found file path');
                  } else {
                    console.log('Failed with found file path:', result3.error);
                    error = result3.error;
                  }
                } else {
                  console.log('File not found in listing');
                  error = new Error('File not found in storage');
                }
              } else {
                console.log('Failed to list files:', listError);
                error = listError;
              }
            }
          }
          
          if (error) {
            console.error('Error getting signed URL:', error);
            alert('Error: Could not access the PDF file');
            return;
          }
          
          console.log('Signed URL created:', signedUrl.signedUrl);
          
          // Open PDF in new tab
          window.open(signedUrl.signedUrl, '_blank');
          
        } catch (error) {
          console.error('Error opening PDF:', error);
          alert('Error: Could not open the PDF file');
        }
      }
      
      window.deleteReport = function(index) {
        console.log('deleteReport called with index:', index);
        console.log('uploadedReports:', window.uploadedReports);
        
        if (confirm('Are you sure you want to delete this report?')) {
          const report = window.uploadedReports[index];
          console.log('Deleting report:', report);
          
          // Delete from database if available
          if (window.db && window.db.isInitialized && report.id) {
            deleteReportFromDatabase(report.id);
          }
          
          window.uploadedReports.splice(index, 1);
          
          // Remove from monthly data
          const monthKey = `${report.month}/${report.year}`;
          if (window.monthlyData[monthKey]) {
            window.monthlyData[monthKey] = window.monthlyData[monthKey].filter(r => r !== report);
            if (window.monthlyData[monthKey].length === 0) {
              delete window.monthlyData[monthKey];
            }
          }
          
          renderReportsHistory();
        }
      };
      
      // Global function for selecting months
      window.selectMonth = function(month) {
        selectMonth(month);
      };
      
      // Global function for showing monthly overview
      window.showMonthlyOverview = function() {
        showMonthlyOverview();
      };

      // ========================================
      // RENOVATION PLANNING SYSTEM
      // ========================================
      
      // Renovation state management
      window.renovationState = {
        items: [],
        selectedGroup: 'forecourt',
        currentProject: null,
        projectSettings: {
          currency: 'ZAR',
          discountRate: 12,
          taxRate: 28,
          vatRate: 15,
          horizon: 120
        }
      };

      // Renovation client instance
      let renovationClient = null;
      
      // Visual analytics engine instance
      let visualEngine = null;
      
      // Data integration engine instance
      let dataIntegrationEngine = null;

      // Initialize renovation system
      async function initializeRenovationSystem() {
        console.log('Initializing renovation system...');
        
        // Wait for Supabase to be available
        if (typeof window.supabase === 'undefined') {
          console.log('Waiting for Supabase to load...');
          setTimeout(initializeRenovationSystem, 100);
          return;
        }
        
        // Initialize renovation client
        renovationClient = new RenovationClient(window.supabase);
        
        // Initialize visual analytics engine
        visualEngine = new VisualAnalyticsEngine();
        window.visualEngine = visualEngine;
        
        // Initialize data integration engine
        dataIntegrationEngine = new DataIntegrationEngine(window.supabase);
        window.dataIntegrationEngine = dataIntegrationEngine;
        
        // Load or create default project
        await loadOrCreateDefaultProject();
        
        // Load project settings
        loadProjectSettings();
        
        // Set up event listeners
        setupRenovationEventListeners();
        
        // Load renovation items from database
        await loadRenovationItemsFromDB();
        
        // Update metrics
        updateRenovationMetrics();
      }

      // Load or create default project
      async function loadOrCreateDefaultProject() {
        try {
          // Try to get existing projects
          const projects = await renovationClient.getProjects();
          
          if (projects.length > 0) {
            // Use the most recent project
            window.renovationState.currentProject = projects[0];
            console.log('Loaded existing project:', projects[0].name);
          } else {
            // Create a new default project
            const newProject = await renovationClient.createProject({
              name: 'My Fuel Business Renovation',
              description: 'Main renovation project for fuel business improvements',
              currency: 'ZAR',
              horizon: 120,
              discountRate: 0.12,
              taxRate: 0.28,
              vatRate: 0.15
            });
            
            window.renovationState.currentProject = newProject;
            console.log('Created new project:', newProject.name);
          }
        } catch (error) {
          console.error('Error loading/creating project:', error);
          // Fallback to localStorage
          loadProjectSettings();
        }
      }

      // Load project settings from localStorage
      function loadProjectSettings() {
        const saved = localStorage.getItem('renovationProjectSettings');
        if (saved) {
          window.renovationState.projectSettings = JSON.parse(saved);
          updateProjectSettingsUI();
        }
      }

      // Save project settings to localStorage
      function saveProjectSettings() {
        localStorage.setItem('renovationProjectSettings', JSON.stringify(window.renovationState.projectSettings));
      }

      // Update project settings UI
      function updateProjectSettingsUI() {
        const settings = window.renovationState.projectSettings;
        document.getElementById('project-currency').value = settings.currency;
        document.getElementById('discount-rate').value = settings.discountRate;
        document.getElementById('tax-rate').value = settings.taxRate;
        document.getElementById('vat-rate').value = settings.vatRate;
        document.getElementById('project-horizon').value = settings.horizon;
      }

      // Set up renovation event listeners
      function setupRenovationEventListeners() {
        // Project settings
        document.getElementById('project-currency').addEventListener('change', updateProjectSettings);
        document.getElementById('discount-rate').addEventListener('change', updateProjectSettings);
        document.getElementById('tax-rate').addEventListener('change', updateProjectSettings);
        document.getElementById('vat-rate').addEventListener('change', updateProjectSettings);
        document.getElementById('project-horizon').addEventListener('change', updateProjectSettings);

        // Add renovation item button
        document.getElementById('add-renovation-item').addEventListener('click', showRenovationForm);

        // Group selection
        document.querySelectorAll('.group-card').forEach(card => {
          card.addEventListener('click', () => selectRenovationGroup(card.dataset.group));
        });

        // Form inputs
        document.getElementById('item-qty').addEventListener('input', calculateItemTotal);
        document.getElementById('item-unit-cost').addEventListener('input', calculateItemTotal);
        document.getElementById('item-contingency').addEventListener('input', calculateItemTotal);

        // Spread type change
        document.getElementById('spread-type').addEventListener('change', handleSpreadTypeChange);

        // Form actions
        document.getElementById('save-renovation-item').addEventListener('click', saveRenovationItem);
        document.getElementById('cancel-renovation-item').addEventListener('click', hideRenovationForm);
      }

      // Update project settings
      async function updateProjectSettings() {
        const newSettings = {
          currency: document.getElementById('project-currency').value,
          discountRate: parseFloat(document.getElementById('discount-rate').value),
          taxRate: parseFloat(document.getElementById('tax-rate').value),
          vatRate: parseFloat(document.getElementById('vat-rate').value),
          horizon: parseInt(document.getElementById('project-horizon').value)
        };
        
        window.renovationState.projectSettings = newSettings;
        saveProjectSettings();
        
        // Update project in database if available
        if (window.renovationState.currentProject && renovationClient) {
          try {
            await renovationClient.updateProject(window.renovationState.currentProject.id, {
              currency: newSettings.currency,
              discount_rate_annual: newSettings.discountRate / 100,
              tax_rate: newSettings.taxRate / 100,
              vat_rate: newSettings.vatRate / 100,
              horizon_months: newSettings.horizon
            });
            
            // Recalculate cash flows and metrics
            await renovationClient.calculateCashFlows(window.renovationState.currentProject.id);
          } catch (error) {
            console.error('Error updating project in database:', error);
          }
        }
        
        updateRenovationMetrics();
      }

      // Select renovation group
      function selectRenovationGroup(group) {
        window.renovationState.selectedGroup = group;
        
        // Update UI
        document.querySelectorAll('.group-card').forEach(card => {
          card.classList.remove('active');
        });
        document.querySelector(`[data-group="${group}"]`).classList.add('active');
        
        // Update form category
        document.getElementById('item-category').value = group;
      }

      // Show renovation form
      function showRenovationForm() {
        document.getElementById('renovation-item-form').style.display = 'block';
        document.getElementById('item-category').value = window.renovationState.selectedGroup;
        calculateItemTotal();
        handleSpreadTypeChange();
      }

      // Hide renovation form
      function hideRenovationForm() {
        document.getElementById('renovation-item-form').style.display = 'none';
        resetRenovationForm();
      }

      // Reset renovation form
      function resetRenovationForm() {
        document.getElementById('item-name').value = '';
        document.getElementById('item-qty').value = '1';
        document.getElementById('item-unit-cost').value = '0';
        document.getElementById('item-contingency').value = '10';
        document.getElementById('item-vat').checked = true;
        document.getElementById('item-salvage').value = '0';
        document.getElementById('start-month').value = '0';
        document.getElementById('spread-type').value = 'one_off';
        document.getElementById('spread-months').value = '1';
        calculateItemTotal();
        handleSpreadTypeChange();
      }

      // Calculate item total
      function calculateItemTotal() {
        const qty = parseFloat(document.getElementById('item-qty').value) || 0;
        const unitCost = parseFloat(document.getElementById('item-unit-cost').value) || 0;
        const contingency = parseFloat(document.getElementById('item-contingency').value) || 0;
        
        const baseTotal = qty * unitCost;
        const totalWithContingency = baseTotal * (1 + contingency / 100);
        
        document.getElementById('item-total').value = totalWithContingency.toFixed(2);
        
        // Update custom schedule if visible
        if (document.getElementById('custom-schedule-grid').style.display !== 'none') {
          updateCustomSchedule();
        }
      }

      // Handle spread type change
      function handleSpreadTypeChange() {
        const spreadType = document.getElementById('spread-type').value;
        const spreadMonthsGroup = document.getElementById('spread-months-group');
        const customScheduleGrid = document.getElementById('custom-schedule-grid');
        
        if (spreadType === 'even') {
          spreadMonthsGroup.style.display = 'block';
          customScheduleGrid.style.display = 'none';
        } else if (spreadType === 'custom') {
          spreadMonthsGroup.style.display = 'none';
          customScheduleGrid.style.display = 'block';
          generateCustomSchedule();
        } else {
          spreadMonthsGroup.style.display = 'none';
          customScheduleGrid.style.display = 'none';
        }
      }

      // Generate custom schedule inputs
      function generateCustomSchedule() {
        const container = document.getElementById('schedule-inputs');
        const horizon = window.renovationState.projectSettings.horizon;
        const total = parseFloat(document.getElementById('item-total').value) || 0;
        
        container.innerHTML = '';
        
        for (let i = 0; i < Math.min(horizon, 24); i++) { // Limit to 24 months for UI
          const div = document.createElement('div');
          div.className = 'schedule-input';
          div.innerHTML = `
            <label>Month ${i}</label>
            <input type="number" class="schedule-amount" data-month="${i}" value="0" min="0" step="0.01">
          `;
          container.appendChild(div);
        }
        
        // Add event listeners to schedule inputs
        document.querySelectorAll('.schedule-amount').forEach(input => {
          input.addEventListener('input', updateCustomSchedule);
        });
        
        updateCustomSchedule();
      }

      // Update custom schedule summary
      function updateCustomSchedule() {
        const total = parseFloat(document.getElementById('item-total').value) || 0;
        let scheduled = 0;
        
        document.querySelectorAll('.schedule-amount').forEach(input => {
          scheduled += parseFloat(input.value) || 0;
        });
        
        const remaining = total - scheduled;
        
        document.getElementById('schedule-total').textContent = `R ${scheduled.toFixed(2)}`;
        document.getElementById('schedule-remaining').textContent = `R ${remaining.toFixed(2)}`;
        
        // Highlight if over/under allocated
        const remainingElement = document.getElementById('schedule-remaining');
        if (remaining < 0) {
          remainingElement.style.color = 'var(--danger)';
        } else if (remaining > 0) {
          remainingElement.style.color = 'var(--warning)';
        } else {
          remainingElement.style.color = 'var(--success)';
        }
      }

      // Save renovation item
      async function saveRenovationItem() {
        const item = {
          name: document.getElementById('item-name').value,
          category: document.getElementById('item-category').value,
          qty: parseFloat(document.getElementById('item-qty').value) || 0,
          unitCost: parseFloat(document.getElementById('item-unit-cost').value) || 0,
          total: parseFloat(document.getElementById('item-total').value) || 0,
          contingency: parseFloat(document.getElementById('item-contingency').value) || 0,
          vatApplicable: document.getElementById('item-vat').checked,
          salvage: parseFloat(document.getElementById('item-salvage').value) || 0,
          startMonth: parseInt(document.getElementById('start-month').value) || 0,
          spreadType: document.getElementById('spread-type').value,
          spreadMonths: parseInt(document.getElementById('spread-months').value) || 1,
          customSchedule: getCustomSchedule()
        };
        
        // Validate required fields
        if (!item.name.trim()) {
          alert('Please enter an item name');
          return;
        }
        
        if (item.total <= 0) {
          alert('Please enter a valid total cost');
          return;
        }
        
        try {
          // Save to database if available
          if (window.renovationState.currentProject && renovationClient) {
            const savedItem = await renovationClient.createItem({
              projectId: window.renovationState.currentProject.id,
              groupId: null, // Will be set based on category
              name: item.name,
              description: '',
              category: item.category,
              qty: item.qty,
              unitCost: item.unitCost,
              contingency: item.contingency,
              vatApplicable: item.vatApplicable,
              salvage: item.salvage,
              startMonth: item.startMonth,
              spreadType: item.spreadType,
              spreadMonths: item.spreadMonths,
              customSchedule: item.customSchedule
            });
            
            // Recalculate cash flows and metrics
            await renovationClient.calculateCashFlows(window.renovationState.currentProject.id);
            
            console.log('Saved renovation item to database:', savedItem);
          } else {
            // Fallback to localStorage
            item.id = Date.now().toString();
            item.createdAt = new Date().toISOString();
            window.renovationState.items.push(item);
            saveRenovationItems();
            console.log('Saved renovation item to localStorage:', item);
          }
          
          // Update UI
          await loadRenovationItemsFromDB();
          await updateRenovationMetrics();
          hideRenovationForm();
          
          // Force chart refresh after a short delay
          setTimeout(async () => {
            console.log('Forcing chart refresh after saving item...');
            await updateRenovationVisualizations({});
          }, 1000);
          
        } catch (error) {
          console.error('Error saving renovation item:', error);
          alert('Error saving renovation item. Please try again.');
        }
      }

      // Get custom schedule data
      function getCustomSchedule() {
        if (document.getElementById('spread-type').value !== 'custom') {
          return null;
        }
        
        const schedule = {};
        document.querySelectorAll('.schedule-amount').forEach(input => {
          const month = parseInt(input.dataset.month);
          const amount = parseFloat(input.value) || 0;
          if (amount > 0) {
            schedule[month] = amount;
          }
        });
        
        return schedule;
      }

      // Save renovation items to localStorage
      function saveRenovationItems() {
        localStorage.setItem('renovationItems', JSON.stringify(window.renovationState.items));
      }

      // Load renovation items from database
      async function loadRenovationItemsFromDB() {
        try {
          if (window.renovationState.currentProject && renovationClient) {
            const items = await renovationClient.getItems(window.renovationState.currentProject.id);
            window.renovationState.items = items.map(item => ({
              id: item.id,
              name: item.name,
              category: item.category,
              qty: item.qty,
              unitCost: item.unit_cost_zar,
              total: item.qty * item.unit_cost_zar * (1 + item.contingency_pct / 100),
              contingency: item.contingency_pct,
              vatApplicable: item.vat_applicable,
              salvage: item.salvage_value_zar,
              startMonth: item.start_month,
              spreadType: item.spread_type,
              spreadMonths: item.spread_months,
              customSchedule: item.custom_schedule,
              status: item.status,
              createdAt: item.created_at
            }));
            
            console.log('Loaded renovation items from database:', items.length);
          } else {
            // Fallback to localStorage
            loadRenovationItems();
          }
          
          renderRenovationItems();
        } catch (error) {
          console.error('Error loading renovation items from database:', error);
          // Fallback to localStorage
          loadRenovationItems();
        }
      }

      // Load renovation items from localStorage
      function loadRenovationItems() {
        const saved = localStorage.getItem('renovationItems');
        if (saved) {
          window.renovationState.items = JSON.parse(saved);
          renderRenovationItems();
        }
      }

      // Render renovation items
      function renderRenovationItems() {
        const container = document.getElementById('items-container');
        
        if (window.renovationState.items.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <p>No renovation items added yet</p>
              <p>Click "Add Renovation Item" to get started</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = window.renovationState.items.map((item, index) => `
          <div class="renovation-item-card">
            <div class="item-header">
              <h5>${item.name}</h5>
              <div class="item-actions">
                <button onclick="editRenovationItem(${index})" class="button small">Edit</button>
                <button onclick="deleteRenovationItem(${index})" class="button small danger">Delete</button>
              </div>
            </div>
            <div class="item-details">
              <div class="detail-row">
                <span class="detail-label">Category:</span>
                <span class="detail-value">${item.category}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Total Cost:</span>
                <span class="detail-value">R ${item.total.toFixed(2)}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Phasing:</span>
                <span class="detail-value">${formatPhasing(item)}</span>
              </div>
            </div>
          </div>
        `).join('');
      }

      // Format phasing for display
      function formatPhasing(item) {
        if (item.spreadType === 'one_off') {
          return `One-off in month ${item.startMonth}`;
        } else if (item.spreadType === 'even') {
          return `Even spread over ${item.spreadMonths} months starting month ${item.startMonth}`;
        } else {
          const months = Object.keys(item.customSchedule || {}).length;
          return `Custom schedule over ${months} months starting month ${item.startMonth}`;
        }
      }

      // Edit renovation item
      function editRenovationItem(index) {
        const item = window.renovationState.items[index];
        if (!item) return;
        
        // Populate form
        document.getElementById('item-name').value = item.name;
        document.getElementById('item-category').value = item.category;
        document.getElementById('item-qty').value = item.qty;
        document.getElementById('item-unit-cost').value = item.unitCost;
        document.getElementById('item-contingency').value = item.contingency;
        document.getElementById('item-vat').checked = item.vatApplicable;
        document.getElementById('item-salvage').value = item.salvage;
        document.getElementById('start-month').value = item.startMonth;
        document.getElementById('spread-type').value = item.spreadType;
        document.getElementById('spread-months').value = item.spreadMonths;
        
        calculateItemTotal();
        handleSpreadTypeChange();
        
        // Show form
        document.getElementById('renovation-item-form').style.display = 'block';
        
        // Update save button
        document.getElementById('save-renovation-item').textContent = 'Update Item';
        document.getElementById('save-renovation-item').onclick = () => updateRenovationItem(index);
      }

      // Update renovation item
      function updateRenovationItem(index) {
        // Remove old item
        window.renovationState.items.splice(index, 1);
        
        // Save new item
        saveRenovationItem();
        
        // Reset save button
        document.getElementById('save-renovation-item').textContent = 'Save Item';
        document.getElementById('save-renovation-item').onclick = saveRenovationItem;
      }

      // Delete renovation item
      async function deleteRenovationItem(index) {
        if (confirm('Are you sure you want to delete this renovation item?')) {
          const item = window.renovationState.items[index];
          
          try {
            if (item.id && renovationClient) {
              // Delete from database
              await renovationClient.deleteItem(item.id);
              
              // Recalculate cash flows and metrics
              if (window.renovationState.currentProject) {
                await renovationClient.calculateCashFlows(window.renovationState.currentProject.id);
              }
              
              console.log('Deleted renovation item from database:', item.id);
            } else {
              // Fallback to localStorage
              window.renovationState.items.splice(index, 1);
              saveRenovationItems();
            }
            
            // Update UI
            await loadRenovationItemsFromDB();
            updateRenovationMetrics();
            
          } catch (error) {
            console.error('Error deleting renovation item:', error);
            alert('Error deleting renovation item. Please try again.');
          }
        }
      }

      // Update renovation metrics and visualizations
      async function updateRenovationMetrics() {
        try {
          if (window.renovationState.currentProject && renovationClient) {
            // Get metrics from database
            const metrics = await renovationClient.getMetrics(window.renovationState.currentProject.id);
            
            if (metrics) {
              document.getElementById('active-renovations').textContent = window.renovationState.items.length;
              document.getElementById('renovation-budget').textContent = `R ${metrics.total_budget_zar?.toFixed(2) || '0.00'}`;
              document.getElementById('avg-renovation-duration').textContent = `${metrics.payback_months?.toFixed(0) || 0} months`;
              document.getElementById('renovation-completion').textContent = `${metrics.completion_rate?.toFixed(1) || 0}%`;
              
              // Update visualizations
              await updateRenovationVisualizations(metrics);
            } else {
              // Fallback to calculated metrics
              updateLocalMetrics();
            }
          } else {
            // Fallback to calculated metrics
            updateLocalMetrics();
          }
        } catch (error) {
          console.error('Error updating renovation metrics:', error);
          // Fallback to calculated metrics
          updateLocalMetrics();
        }
      }
      
      // Update renovation visualizations
      async function updateRenovationVisualizations(metrics) {
        try {
          console.log('Starting renovation visualizations update...');
          
          // Wait for visualEngine to be available
          let attempts = 0;
          while (!window.visualEngine && attempts < 10) {
            await new Promise(resolve => setTimeout(resolve, 500));
            attempts++;
          }
          
          if (!window.visualEngine) {
            console.error('VisualEngine not available after waiting');
            return;
          }
          
          console.log('VisualEngine available, proceeding with chart creation...');
          
          if (!renovationClient || !window.renovationState.currentProject) {
            console.log('Renovation client or project not ready');
            return;
          }
          
          // Get cash flows for visualizations
          const cashFlows = await renovationClient.getCashFlows(window.renovationState.currentProject.id);
          const project = window.renovationState.currentProject;
          
          console.log('Cash flows retrieved:', cashFlows ? cashFlows.length : 0, 'entries');
          
          // Create charts even if cash flows are empty (use sample data)
          if (cashFlows && cashFlows.length > 0) {
            console.log('Creating charts with real cash flow data...');
            
            // Create cash flow chart
            window.visualEngine.createCashFlowChart('cash-flow-chart', cashFlows, project);
            
            // Create break-even chart
            window.visualEngine.createBreakEvenChart('break-even-chart', cashFlows, metrics.total_budget_zar || 0);
            
            // Create KPI summary chart
            window.visualEngine.createKPISummaryChart('kpi-chart', metrics);
            
            // Create scenario analysis if available
            if (metrics.advanced_metrics && metrics.advanced_metrics.scenarios) {
              window.visualEngine.createScenarioChart('scenario-chart', metrics.advanced_metrics.scenarios);
            }
            
            // Create sensitivity analysis if available
            if (metrics.advanced_metrics && metrics.advanced_metrics.sensitivity) {
              window.visualEngine.createTornadoChart('sensitivity-chart', metrics.advanced_metrics.sensitivity);
            }
            
            // Create risk distribution if available
            if (metrics.advanced_metrics && metrics.advanced_metrics.scenarios) {
              window.visualEngine.createRiskDistributionChart('risk-chart', metrics.advanced_metrics.scenarios);
            }
          } else {
            console.log('No cash flows available, creating sample charts...');
            
            // Create sample charts with placeholder data
            const sampleCashFlows = generateSampleCashFlows();
            const sampleProject = {
              name: 'Sample Project',
              currency: 'ZAR',
              discount_rate: 12,
              tax_rate: 28,
              vat_rate: 15
            };
            
            // Create cash flow chart with sample data
            console.log('Creating cash flow chart with sample data...');
            try {
              window.visualEngine.createCashFlowChart('cash-flow-chart', sampleCashFlows, sampleProject);
              console.log('Cash flow chart created successfully');
            } catch (error) {
              console.error('Error creating cash flow chart:', error);
            }
            
            // Create break-even chart with sample data
            console.log('Creating break-even chart with sample data...');
            try {
              window.visualEngine.createBreakEvenChart('break-even-chart', sampleCashFlows, 100000);
              console.log('Break-even chart created successfully');
            } catch (error) {
              console.error('Error creating break-even chart:', error);
            }
            
            // Create KPI summary chart with sample data
            console.log('Creating KPI chart with sample data...');
            const sampleMetrics = {
              total_budget_zar: 100000,
              payback_months: 24,
              completion_rate: 0,
              npv_zar: 50000,
              irr_annual: 0.15,
              payback_years: 2,
              advanced_metrics: {
                roi: 25
              }
            };
            try {
              window.visualEngine.createKPISummaryChart('kpi-chart', sampleMetrics);
              console.log('KPI chart created successfully');
            } catch (error) {
              console.error('Error creating KPI chart:', error);
            }
            
            // Create scenario analysis with sample data
            console.log('Creating scenario chart with sample data...');
            const sampleScenarios = {
              optimistic: { npv: 75000, irr: 0.25, payback: 18 },
              realistic: { npv: 50000, irr: 0.18, payback: 24 },
              pessimistic: { npv: 25000, irr: 0.12, payback: 36 }
            };
            try {
              window.visualEngine.createScenarioChart('scenario-chart', sampleScenarios);
              console.log('Scenario chart created successfully');
            } catch (error) {
              console.error('Error creating scenario chart:', error);
            }
            
            // Create sensitivity analysis with sample data
            console.log('Creating sensitivity chart with sample data...');
            const sampleSensitivity = {
              revenue_growth: { impact: { max_positive: 25, max_negative: -15 } },
              cost_reduction: { impact: { max_positive: 20, max_negative: -10 } },
              timeline: { impact: { max_positive: 10, max_negative: -20 } },
              interest_rate: { impact: { max_positive: 5, max_negative: -30 } }
            };
            try {
              window.visualEngine.createTornadoChart('sensitivity-chart', sampleSensitivity);
              console.log('Sensitivity chart created successfully');
            } catch (error) {
              console.error('Error creating sensitivity chart:', error);
            }
            
            // Create risk distribution with sample data
            console.log('Creating risk distribution chart with sample data...');
            try {
              window.visualEngine.createRiskDistributionChart('risk-chart', sampleScenarios);
              console.log('Risk distribution chart created successfully');
            } catch (error) {
              console.error('Error creating risk distribution chart:', error);
            }
          }
          
          console.log('Renovation visualizations updated successfully');
        } catch (error) {
          console.error('Error updating renovation visualizations:', error);
        }
      }
      
      // Generate sample cash flows for testing
      function generateSampleCashFlows() {
        const cashFlows = [];
        const totalBudget = 100000;
        const months = 24;
        
        for (let i = 0; i <= months; i++) {
          if (i === 0) {
            // Initial investment
            cashFlows.push({
              month: i,
              capex_renovations_zar: totalBudget,
              revenue_zar: 0,
              net_cashflow_zar: -totalBudget,
              cumulative_zar: -totalBudget
            });
          } else {
            // Monthly revenue and costs
            const monthlyRevenue = 8000 + (i * 200); // Growing revenue
            const monthlyCosts = 3000 + (i * 50); // Growing costs
            const netCashFlow = monthlyRevenue - monthlyCosts;
            const cumulativeCashFlow = cashFlows[i-1].cumulative_zar + netCashFlow;
            
            cashFlows.push({
              month: i,
              capex_renovations_zar: 0,
              revenue_zar: monthlyRevenue,
              costs_zar: monthlyCosts,
              net_cashflow_zar: netCashFlow,
              cumulative_zar: cumulativeCashFlow
            });
          }
        }
        
        return cashFlows;
      }
      
      // Manual chart refresh function
      async function refreshRenovationCharts() {
        console.log('Manual chart refresh triggered...');
        try {
          // Test if visualEngine is available
          if (!window.visualEngine) {
            console.error('VisualEngine not available');
            alert('VisualEngine not available. Please refresh the page.');
            return;
          }
          
          console.log('VisualEngine available, testing chart creation...');
          
          // Test with simple chart first
          const testData = [10, 20, 30, 40, 50];
          const testCtx = document.getElementById('cash-flow-chart');
          if (testCtx) {
            console.log('Canvas element found, creating test chart...');
            const testChart = new Chart(testCtx, {
              type: 'line',
              data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May'],
                datasets: [{
                  label: 'Test Data',
                  data: testData,
                  borderColor: '#2563eb',
                  backgroundColor: '#2563eb20',
                  borderWidth: 2
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false
              }
            });
            console.log('Test chart created successfully');
          } else {
            console.error('Canvas element not found');
          }
          
          // Test if visualEngine chart functions exist
          console.log('Testing visualEngine functions...');
          console.log('createScenarioChart exists:', typeof window.visualEngine.createScenarioChart);
          console.log('createTornadoChart exists:', typeof window.visualEngine.createTornadoChart);
          console.log('createRiskDistributionChart exists:', typeof window.visualEngine.createRiskDistributionChart);
          
          // Test creating a simple scenario chart manually
          const scenarioCtx = document.getElementById('scenario-chart');
          if (scenarioCtx) {
            console.log('Scenario canvas found, creating simple test chart...');
            try {
              const scenarioTestChart = new Chart(scenarioCtx, {
                type: 'bar',
                data: {
                  labels: ['Optimistic', 'Realistic', 'Pessimistic'],
                  datasets: [{
                    label: 'NPV (R)',
                    data: [75000, 50000, 25000],
                    backgroundColor: ['#059669', '#2563eb', '#dc2626']
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    title: {
                      display: true,
                      text: 'Scenario Analysis Test'
                    }
                  }
                }
              });
              console.log('Scenario test chart created successfully');
            } catch (error) {
              console.error('Error creating scenario test chart:', error);
            }
          } else {
            console.error('Scenario canvas element not found');
          }
          
          // Test creating a simple sensitivity chart manually
          const sensitivityCtx = document.getElementById('sensitivity-chart');
          if (sensitivityCtx) {
            console.log('Sensitivity canvas found, creating simple test chart...');
            try {
              const sensitivityTestChart = new Chart(sensitivityCtx, {
                type: 'bar',
                data: {
                  labels: ['Revenue Growth', 'Cost Reduction', 'Timeline', 'Interest Rate'],
                  datasets: [{
                    label: 'Impact (%)',
                    data: [25, 20, 10, 5],
                    backgroundColor: '#0891b2'
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  indexAxis: 'y',
                  plugins: {
                    title: {
                      display: true,
                      text: 'Sensitivity Analysis Test'
                    }
                  }
                }
              });
              console.log('Sensitivity test chart created successfully');
            } catch (error) {
              console.error('Error creating sensitivity test chart:', error);
            }
          } else {
            console.error('Sensitivity canvas element not found');
          }
          
          // Test creating a simple risk distribution chart manually
          const riskCtx = document.getElementById('risk-chart');
          if (riskCtx) {
            console.log('Risk canvas found, creating simple test chart...');
            try {
              const riskTestChart = new Chart(riskCtx, {
                type: 'bar',
                data: {
                  labels: ['Low Risk', 'Medium Risk', 'High Risk'],
                  datasets: [{
                    label: 'Probability',
                    data: [0.3, 0.5, 0.2],
                    backgroundColor: '#7c3aed'
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    title: {
                      display: true,
                      text: 'Risk Distribution Test'
                    }
                  }
                }
              });
              console.log('Risk test chart created successfully');
            } catch (error) {
              console.error('Error creating risk test chart:', error);
            }
          } else {
            console.error('Risk canvas element not found');
          }
          
          // Test creating a simple break-even chart manually
          const breakEvenCtx = document.getElementById('break-even-chart');
          if (breakEvenCtx) {
            console.log('Break-even canvas found, creating simple test chart...');
            try {
              const breakEvenTestChart = new Chart(breakEvenCtx, {
                type: 'line',
                data: {
                  labels: ['Month 1', 'Month 2', 'Month 3', 'Month 4', 'Month 5'],
                  datasets: [{
                    label: 'Cumulative Cash Flow',
                    data: [-100000, -80000, -50000, -10000, 20000],
                    borderColor: '#2563eb',
                    backgroundColor: '#2563eb20',
                    borderWidth: 3,
                    fill: false
                  }, {
                    label: 'Break-Even Line',
                    data: [0, 0, 0, 0, 0],
                    borderColor: '#1f2937',
                    backgroundColor: '#1f293720',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    title: {
                      display: true,
                      text: 'Break-Even Analysis Test'
                    }
                  }
                }
              });
              console.log('Break-even test chart created successfully');
            } catch (error) {
              console.error('Error creating break-even test chart:', error);
            }
          } else {
            console.error('Break-even canvas element not found');
          }
          
          await updateRenovationVisualizations({});
          console.log('Charts refreshed successfully');
        } catch (error) {
          console.error('Error refreshing charts:', error);
          alert('Error refreshing charts: ' + error.message);
        }
      }

      // Update metrics from local data
      function updateLocalMetrics() {
        const items = window.renovationState.items;
        const totalBudget = items.reduce((sum, item) => sum + item.total, 0);
        const activeProjects = items.length;
        
        // Calculate average duration (simplified)
        const avgDuration = items.length > 0 ? 30 : 0; // Placeholder
        
        // Calculate completion rate (simplified)
        const completionRate = 0; // Placeholder for now
        
        // Update UI
        document.getElementById('active-renovations').textContent = activeProjects;
        document.getElementById('renovation-budget').textContent = `R ${totalBudget.toFixed(2)}`;
        document.getElementById('avg-renovation-duration').textContent = `${avgDuration} days`;
        document.getElementById('renovation-completion').textContent = `${completionRate}%`;
      }

      // Initialize renovation system when page loads
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, checking dependencies...');
        
        // Check if Chart.js is loaded
        if (typeof Chart === 'undefined') {
          console.error('Chart.js not loaded!');
          alert('Chart.js not loaded. Please refresh the page.');
          return;
        }
        console.log('Chart.js loaded successfully');
        
        // Initialize after a short delay to ensure all elements are loaded
        setTimeout(async () => {
          // Wait for visualEngine to be available
          let attempts = 0;
          while (!window.visualEngine && attempts < 20) {
            await new Promise(resolve => setTimeout(resolve, 250));
            attempts++;
          }
          
          if (window.visualEngine) {
            console.log('VisualEngine ready, initializing renovation system');
            
            // Load most recent report data if available
            if (Object.keys(monthlyData).length > 0) {
              const months = Object.keys(monthlyData).sort((a, b) => {
                const [monthA, yearA] = a.split('/').map(Number);
                const [monthB, yearB] = b.split('/').map(Number);
                return yearA - yearB || monthA - monthB;
              });
              
              if (months.length > 0) {
                const mostRecentMonth = months[months.length - 1];
                console.log('Loading most recent report data for:', mostRecentMonth);
                loadMostRecentReportData(mostRecentMonth);
                
                // Personnel data will be loaded after database initialization
              }
            } else {
              console.log('No reports available, showing empty dashboard');
              updateDashboardWithNoData();
              updatePersonnelWithNoData();
            }
          } else {
            console.warn('VisualEngine not available, continuing without charts');
          }
          
          initializeRenovationSystem();
          loadRenovationItems();
          setupDataIntegration();
        }, 100);
      });
      
      // ========================================
      // DATA INTEGRATION SYSTEM
      // ========================================
      
      // Setup data integration event listeners
      function setupDataIntegration() {
        const loadHistoricalDataBtn = document.getElementById('load-historical-data');
        if (loadHistoricalDataBtn) {
          loadHistoricalDataBtn.addEventListener('click', loadHistoricalData);
        }
      }
      
      // Load historical data and generate insights
      async function loadHistoricalData() {
        try {
          if (!dataIntegrationEngine) {
            console.error('Data integration engine not initialized');
            return;
          }
          
          // Show loading state
          const btn = document.getElementById('load-historical-data');
          btn.textContent = 'Loading...';
          btn.disabled = true;
          
          // Get current user's company ID (simplified - you may need to adjust this)
          const companyId = 'default-company'; // This should come from user authentication
          
          // Load historical data
          const historicalData = await dataIntegrationEngine.loadHistoricalData(companyId, 24);
          
          // Project future revenue
          const projections = dataIntegrationEngine.projectFutureRevenue(60);
          
          // Get renovation cash flows if available
          let renovationCashflows = [];
          if (window.renovationState.currentProject && renovationClient) {
            renovationCashflows = await renovationClient.getCashFlows(window.renovationState.currentProject.id);
            renovationCashflows = renovationCashflows.map(cf => cf.net_cashflow_zar);
          }
          
          // Integrate renovation with projections
          const integratedData = dataIntegrationEngine.integrateRenovationWithProjections(
            renovationCashflows, 
            projections
          );
          
          // Generate insights
          const insights = dataIntegrationEngine.generateInsights(integratedData, historicalData);
          
          // Update UI
          updateDataIntegrationUI(historicalData, projections, integratedData, insights);
          
          // Create visualizations
          createDataIntegrationCharts(historicalData, projections, integratedData);
          
          // Reset button
          btn.textContent = 'Data Loaded';
          btn.disabled = false;
          
          console.log('Historical data loaded successfully');
        } catch (error) {
          console.error('Error loading historical data:', error);
          
          // Reset button
          const btn = document.getElementById('load-historical-data');
          btn.textContent = '❌ Error - Try Again';
          btn.disabled = false;
          
          alert('Error loading historical data. Please try again.');
        }
      }
      
      // Update data integration UI
      function updateDataIntegrationUI(historicalData, projections, integratedData, insights) {
        // Update metrics
        if (dataIntegrationEngine.trends.revenue.growth !== undefined) {
          document.getElementById('revenue-growth').textContent = 
            dataIntegrationEngine.trends.revenue.growth.toFixed(2) + '%';
        }
        
        document.getElementById('data-points').textContent = 
          historicalData.combined.revenue.length;
        
        if (integratedData) {
          document.getElementById('projected-roi').textContent = 
            integratedData.summary.roi.toFixed(2) + '%';
          document.getElementById('projected-payback').textContent = 
            (integratedData.summary.paybackPeriod || 'N/A') + ' months';
        }
        
        // Update insights
        updateInsightsUI(insights);
      }
      
      // Update insights UI
      function updateInsightsUI(insights) {
        const container = document.getElementById('insights-container');
        if (!container) return;
        
        container.innerHTML = '';
        
        // Add revenue insights
        if (insights.revenue.length > 0) {
          insights.revenue.forEach(insight => {
            const card = createInsightCard(insight, 'revenue');
            container.appendChild(card);
          });
        }
        
        // Add renovation insights
        if (insights.renovation.length > 0) {
          insights.renovation.forEach(insight => {
            const card = createInsightCard(insight, 'renovation');
            container.appendChild(card);
          });
        }
        
        // Add recommendations
        if (insights.recommendations.length > 0) {
          insights.recommendations.forEach(recommendation => {
            const card = createRecommendationCard(recommendation);
            container.appendChild(card);
          });
        }
        
        // Show placeholder if no insights
        if (container.children.length === 0) {
          container.innerHTML = `
            <div class="insight-placeholder">
              <p>No insights available. Load historical data to see recommendations.</p>
            </div>
          `;
        }
      }
      
      // Create insight card
      function createInsightCard(insight, category) {
        const card = document.createElement('div');
        card.className = 'insight-card';
        
        const impactClass = insight.impact === 'positive' ? 'success' : 
                           insight.impact === 'negative' ? 'danger' : 'warning';
        
        card.innerHTML = `
          <div class="insight-header">
            <span class="insight-title">${insight.type.charAt(0).toUpperCase() + insight.type.slice(1)}</span>
            <span class="insight-priority ${impactClass}">${insight.impact}</span>
          </div>
          <div class="insight-description">${insight.message}</div>
        `;
        
        return card;
      }
      
      // Create recommendation card
      function createRecommendationCard(recommendation) {
        const card = document.createElement('div');
        card.className = 'insight-card';
        
        card.innerHTML = `
          <div class="insight-header">
            <span class="insight-title">${recommendation.title}</span>
            <span class="insight-priority ${recommendation.priority}">${recommendation.priority}</span>
          </div>
          <div class="insight-description">${recommendation.description}</div>
          <div class="insight-action">💡 ${recommendation.action}</div>
        `;
        
        return card;
      }
      
      // Create data integration charts
      function createDataIntegrationCharts(historicalData, projections, integratedData) {
        if (!visualEngine) return;
        
        // Create historical trends chart
        if (historicalData.combined.revenue.length > 0) {
          createHistoricalTrendsChart(historicalData);
        }
        
        // Create revenue projection chart
        if (projections && integratedData) {
          createRevenueProjectionChart(projections, integratedData);
        }
      }
      
      // Create historical trends chart
      function createHistoricalTrendsChart(historicalData) {
        const labels = historicalData.combined.revenue.map(r => r.month);
        const fuelData = historicalData.fuel.total.map(f => f.revenue);
        const shopData = historicalData.shop.total.map(s => s.revenue);
        const totalData = historicalData.combined.revenue.map(r => r.total);
        
        const chart = new Chart(document.getElementById('historical-trends-chart'), {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Total Revenue',
                data: totalData,
                borderColor: visualEngine.colors.primary,
                backgroundColor: visualEngine.colors.primary + '20',
                borderWidth: 3,
                fill: true
              },
              {
                label: 'Fuel Revenue',
                data: fuelData,
                borderColor: visualEngine.colors.success,
                backgroundColor: visualEngine.colors.success + '20',
                borderWidth: 2,
                fill: false
              },
              {
                label: 'Shop Revenue',
                data: shopData,
                borderColor: visualEngine.colors.warning,
                backgroundColor: visualEngine.colors.warning + '20',
                borderWidth: 2,
                fill: false
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: 'Historical Revenue Trends',
                font: { size: 16, weight: 'bold' }
              },
              legend: {
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': R ' + context.parsed.y.toLocaleString();
                  }
                }
              }
            },
            scales: {
              x: {
                title: { display: true, text: 'Month' }
              },
              y: {
                title: { display: true, text: 'Revenue (R)' },
                beginAtZero: true
              }
            }
          }
        });
        
        visualEngine.charts['historical-trends-chart'] = chart;
      }
      
      // Create revenue projection chart
      function createRevenueProjectionChart(projections, integratedData) {
        const labels = projections.combined.map((p, i) => `M${i + 1}`);
        const baseRevenue = projections.combined.map(p => p.total);
        const adjustedRevenue = integratedData.monthly.map(m => m.adjustedRevenue);
        const renovationCosts = integratedData.monthly.map(m => m.renovationCost);
        
        const chart = new Chart(document.getElementById('revenue-projection-chart'), {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Base Revenue (No Renovation)',
                data: baseRevenue,
                borderColor: visualEngine.colors.warning,
                backgroundColor: visualEngine.colors.warning + '20',
                borderWidth: 2,
                borderDash: [5, 5],
                fill: false
              },
              {
                label: 'Adjusted Revenue (With Renovation)',
                data: adjustedRevenue,
                borderColor: visualEngine.colors.success,
                backgroundColor: visualEngine.colors.success + '20',
                borderWidth: 3,
                fill: true
              },
              {
                label: 'Renovation Costs',
                data: renovationCosts,
                borderColor: visualEngine.colors.danger,
                backgroundColor: visualEngine.colors.danger + '20',
                borderWidth: 2,
                fill: false
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: 'Revenue Projection with Renovation Impact',
                font: { size: 16, weight: 'bold' }
              },
              legend: {
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': R ' + context.parsed.y.toLocaleString();
                  }
                }
              }
            },
            scales: {
              x: {
                title: { display: true, text: 'Month' }
              },
              y: {
                title: { display: true, text: 'Amount (R)' },
                beginAtZero: false
              }
            }
          }
        });
        
        visualEngine.charts['revenue-projection-chart'] = chart;
      }

      // ========================================
      // API MANAGEMENT FUNCTIONS
      // ========================================

      // API Configuration
      let apiConfig = {
        accessKey: '9t7i0b4eajkaH2zoutN8-exoM62YWTuL',
        siteId: '651',
        siteName: 'Shell Mapulaneng Bushbuckridge',
        baseUrl: 'https://api.fueltorque.com',
        connectionStatus: 'Configured',
        lastSync: new Date(),
        dataPoints: 1247,
        responseTime: 245
      };

      // Test API connection
      async function testApiConnection() {
        console.log('Testing API connection...');
        
        try {
          // Update status to testing
          document.getElementById('api-connection-status').textContent = 'Status: Testing...';
          document.getElementById('connection-status').textContent = 'Testing...';
          
          // Simulate API test (replace with actual API call when ready)
          await new Promise(resolve => setTimeout(resolve, 2000));
          
          // Update status based on test result
          const isConnected = Math.random() > 0.2; // 80% success rate for demo
          
          if (isConnected) {
            document.getElementById('api-connection-status').textContent = 'Status: Connected';
            document.getElementById('connection-status').textContent = 'Connected';
            showNotification('API connection test successful!', 'success');
          } else {
            document.getElementById('api-connection-status').textContent = 'Status: Failed';
            document.getElementById('connection-status').textContent = 'Failed';
            showNotification('API connection test failed. Please check your settings.', 'error');
          }
        } catch (error) {
          console.error('API test error:', error);
          document.getElementById('api-connection-status').textContent = 'Status: Error';
          document.getElementById('connection-status').textContent = 'Error';
          showNotification('API connection test failed: ' + error.message, 'error');
        }
      }

      // Configure API settings
      function configureApiSettings() {
        showNotification('API configuration panel opened!', 'info');
        // In a real app, this would open a modal or expand the settings form
      }

      // Save API settings
      async function saveApiSettings() {
        console.log('Saving API settings...');
        
        try {
          // Get values from form
          const accessKey = document.getElementById('api-access-key').value;
          const siteId = document.getElementById('site-id').value;
          const siteName = document.getElementById('site-name').value;
          const baseUrl = document.getElementById('api-base-url').value;
          
          // Validate inputs
          if (!accessKey || !siteId || !siteName || !baseUrl) {
            showNotification('Please fill in all required fields.', 'error');
            return;
          }
          
          // Update config
          apiConfig = {
            ...apiConfig,
            accessKey,
            siteId,
            siteName,
            baseUrl
          };
          
          // Save to localStorage for persistence
          localStorage.setItem('apiConfig', JSON.stringify(apiConfig));
          
          // Update display
          updateApiStatus();
          
          showNotification('API settings saved successfully!', 'success');
        } catch (error) {
          console.error('Error saving API settings:', error);
          showNotification('Error saving settings: ' + error.message, 'error');
        }
      }

      // Update API status display
      function updateApiStatus() {
        // Update last sync time
        const now = new Date();
        const timeDiff = Math.floor((now - apiConfig.lastSync) / 60000); // minutes
        document.getElementById('last-sync-time').textContent = 
          timeDiff < 1 ? 'Just now' : `${timeDiff} min ago`;
        
        // Update data points (simulate growth)
        apiConfig.dataPoints += Math.floor(Math.random() * 10);
        document.getElementById('data-points-count').textContent = 
          apiConfig.dataPoints.toLocaleString();
        
        // Update response time (simulate variation)
        apiConfig.responseTime = 200 + Math.floor(Math.random() * 100);
        document.getElementById('response-time').textContent = 
          `${apiConfig.responseTime}ms`;
      }

      // Create API activity chart
      function createApiActivityChart() {
        const ctx = document.getElementById('api-activity-chart');
        if (!ctx) return;

        // Destroy existing chart if it exists
        if (window.apiActivityChart) {
          window.apiActivityChart.destroy();
        }

        const data = {
          labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
          datasets: [{
            label: 'API Calls',
            data: [45, 52, 38, 61, 48, 35, 42],
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            fill: true
          }]
        };

        window.apiActivityChart = new Chart(ctx, {
          type: 'line',
          data: data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(0,0,0,0.1)'
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
      }

      // Initialize API settings
      function initializeApiSettings() {
        // Load saved config from localStorage
        const savedConfig = localStorage.getItem('apiConfig');
        if (savedConfig) {
          try {
            apiConfig = { ...apiConfig, ...JSON.parse(savedConfig) };
          } catch (error) {
            console.log('Error loading saved API config:', error);
          }
        }
        
        // Update form fields
        document.getElementById('api-access-key').value = apiConfig.accessKey;
        document.getElementById('site-id').value = apiConfig.siteId;
        document.getElementById('site-name').value = apiConfig.siteName;
        document.getElementById('api-base-url').value = apiConfig.baseUrl;
        
        // Update status display
        updateApiStatus();
        
        // Create activity chart
        createApiActivityChart();
      }

      // Show notification
      function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 20px;
          border-radius: 8px;
          color: white;
          font-weight: 600;
          z-index: 10000;
          animation: slideIn 0.3s ease;
        `;

        // Set background color based on type
        switch (type) {
          case 'success':
            notification.style.background = '#10b981';
            break;
          case 'error':
            notification.style.background = '#ef4444';
            break;
          case 'warning':
            notification.style.background = '#f59e0b';
            break;
          default:
            notification.style.background = '#3b82f6';
        }

        notification.textContent = message;
        document.body.appendChild(notification);

        // Remove notification after 3 seconds
        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      // Initialize API section when page loads
      document.addEventListener('DOMContentLoaded', function() {
        // Initialize API settings if we're on the users section
        if (window.location.hash === '#users') {
          initializeApiSettings();
        }

        // Add navigation click handlers for all sections
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const href = this.getAttribute('href');
            const sectionId = href.replace('#', '');
            
            // Remove active class from all nav links
            navLinks.forEach(navLink => navLink.classList.remove('active'));
            // Add active class to clicked link
            this.classList.add('active');
            
            // Hide all sections first
            const allSections = ['overview', 'reports', 'analytics', 'insights', 'personnel', 'users', 'renovation', 'expansion'];
            allSections.forEach(id => {
              const section = document.getElementById(id);
              if (section) section.style.display = 'none';
            });
            
            // Show the selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
              targetSection.style.display = 'block';
            }
            
            // Special handling for users section
            if (href === '#users') {
              // Small delay to ensure section is visible before refreshing
              setTimeout(() => {
                initializeApiSettings();
              }, 100);
            }
            
            // Special handling for personnel section
            if (href === '#personnel') {
              // Small delay to ensure section is visible before loading personnel data
              setTimeout(() => {
                loadPersonnelDataFromReport();
              }, 100);
            }
            
            // Update URL hash
            window.location.hash = href;
          });
        });
        
        // Handle initial page load - show overview by default
        if (!window.location.hash || window.location.hash === '#overview') {
          document.getElementById('overview').style.display = 'block';
          document.querySelector('a[href="#overview"]').classList.add('active');
        } else {
          // Show the section based on URL hash
          const hash = window.location.hash;
          const sectionId = hash.replace('#', '');
          const targetSection = document.getElementById(sectionId);
          const targetNavLink = document.querySelector(`a[href="${hash}"]`);
          
          if (targetSection) {
            targetSection.style.display = 'block';
            if (targetNavLink) targetNavLink.classList.add('active');
          }
        }
      });

      // Add CSS for role and status badges
      const style = document.createElement('style');
      style.textContent = `
        .role-badge {
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 600;
          text-transform: uppercase;
        }
        .role-admin { background: #fef3c7; color: #92400e; }
        .role-manager { background: #dbeafe; color: #1e40af; }
        .role-analyst { background: #dcfce7; color: #166534; }
        .role-viewer { background: #f3e8ff; color: #7c3aed; }
        
        .status-badge {
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 600;
        }
        .status-active { background: #dcfce7; color: #166534; }
        .status-inactive { background: #fee2e2; color: #991b1b; }
        
        .btn-sm {
          padding: 4px 8px;
          font-size: 12px;
        }
        
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
  </script>
</body>
</html>
